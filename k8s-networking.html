<!DOCTYPE html>
<html lang="en">
<head>  
	<meta charset="utf-8">
	<title>k8s-internals</title>
 
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="path/to/image.jpg">
 
<!-- build:css -->
<link rel="stylesheet" href="css/libs/bootstrap.min.css">
<link rel="stylesheet" href="css/libs/font-awesome.min.css">
<link rel="stylesheet" href="css/libs/animate.min.css">
<link rel="stylesheet" href="css/libs/slick.css">
<link rel="stylesheet" href="css/libs/magnific-popup.css">

<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/media.css">
<!-- endbuild -->
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#000">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#000">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#000">
	<!-- <style>body { opacity:s 0; overflow-x: hidden; } html { background-color: #fff; }</style> -->
</head>
<body data-spy="scroll" data-target=".navbar" data-offset="50" class="loaded" link="blue">

	
<div class="site-content">
	<!-- Naviigation -->
	<div class="navbar-wrap">
		<div class="navbar">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<nav class="navbar-menu">
							<div class="navbar-header">
								<button class="collapsed navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-example-js-navbar-scrollspy">
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</button>
							</div>
							 
							<div class="navbar-full">
								<div class="collapse bs-example-js-navbar-scrollspy">
									<ul class="nav navbar-nav">
										<li style="display: none;"><a></a></li>
										<li><a href="http://www.linkedin.com/in/baburajkallarakkal">About Me</a></li>
										<li><a href="http://padmavyuha.blogspot.com/">Blog</a></li>
										<li><a href="https://sourceforge.net/projects/oraclerman/">Projects</a></li>
										<li><a href="https://hub.docker.com/u/baburaj/">Docker</a></li>
										<li><a href="mailto:raj.anju@gmail.com">Contact Me</a></li>
										<li>
										</li>
									</ul>
							
								</div>
							</div>
						</nav>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Naviigation -->
	

<!-- Header -->
	<div class="menu-sticky"></div>
 
	<!-- Screen-one -->
	<div class="screen-one">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<div class="screen-one-title">

						<h2> K8S Networking Internals   </h2>
					</div>
				</div>
			</div>
		</div>
	 
		<div class="container">
 
<!-- container -->		
		<div class="screen-one-item-container">
							<h3>  Pause Container! </h3>
							<p>
                                What is a pause container? This acts as a parent container to other containers  in
                                the POD and is responsible for bringing up the network namespace.

                            </p>
							<p> </p>

<pre>

    [root@netlab6 etc]# kubectl create namespace demo
    namespace/demo created

    [root@netlab6 etc]# kubectl -n demo create deployment netops --image=baburaj/netops
    deployment.apps/netops created

    [root@netlab6 etc]# kubectl -n demo get po -o wide
    NAME                     READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES
    netops-f49b8bdb7-fwmzb   1/1     Running   0          29s   192.168.191.65   netlab8   <none>           <none>

    [root@netlab8 ~]# docker ps  |grep netops
    e5a08108d0d5   baburaj/netops         "/usr/bin/nginx-starâ€¦"   5 minutes ago    Up 5 minutes              k8s_netops_netops-f49b8bdb7-fwmzb_demo_a65ea2e7-41c3-4be4-8cab-e40fd5955dca_0
    35281cd4a860   k8s.gcr.io/pause:3.6   "/pause"                 5 minutes ago    Up 5 minutes              k8s_POD_netops-f49b8bdb7-fwmzb_demo_a65ea2e7-41c3-4be4-8cab-e40fd5955dca_0
    
    [root@netlab8 ~]# docker inspect k8s_netops_netops-f49b8bdb7-fwmzb_demo_a65ea2e7-41c3-4be4-8cab-e40fd5955dca_0 | jq '.[].State.Pid'
    18484

    [root@netlab8 ~]# nsenter -t 18484 -a

    [root@netops-f49b8bdb7-fwmzb /]# ip addr show
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
        valid_lft forever preferred_lft forever
    2: tunl0@NONE: <NOARP> mtu 1480 qdisc noop state DOWN group default qlen 1000
        link/ipip 0.0.0.0 brd 0.0.0.0
    4: eth0@if7: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1480 qdisc noqueue state UP group default
        link/ether 5e:bf:1f:df:67:ce brd ff:ff:ff:ff:ff:ff link-netnsid 0
        inet 192.168.191.65/32 scope global eth0
        valid_lft forever preferred_lft forever

        [root@netlab8 ~]# cd /var/run/

        [root@netlab8 run]# ln -s /var/run/docker/netns netns

        [root@netlab8 run]# ip netns list
        c09b7f2fae29 (id: 0)
        default

        [root@netlab8 run]# ip link show | grep -B1 c09b7f2fae29
        7: cali861b4e7784e@if4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1480 qdisc noqueue state UP mode DEFAULT group default
            link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns c09b7f2fae29
            
</pre>		

		</div>
<!-- container -->		


<!-- container -->		
<div class="screen-one-item-container">
	<h3>  k8s (Identify Network Namespace for the PODs) </h3>
	<p> </p>
	<p> </p>

<pre>

    [root@netlab6 etc]# kubectl -n demo create deployment netops --image=baburaj/netops
    deployment.apps/netops created

    [root@netlab6 etc]# kubectl -n demo scale deployment.apps/netops --replicas=4
    deployment.apps/netops scaled

    [root@netlab6 etc]# kubectl -n demo get po -o wide
    NAME                     READY   STATUS    RESTARTS   AGE    IP               NODE      NOMINATED NODE   READINESS GATES
    netops-f49b8bdb7-8d747   1/1     Running   0          8s     192.168.197.66   netlab7   <none>           <none>
    netops-f49b8bdb7-8g6mt   1/1     Running   0          8s     192.168.191.66   netlab8   <none>           <none>
    netops-f49b8bdb7-fwmzb   1/1     Running   0          17h    192.168.191.65   netlab8   <none>           <none>
    netops-f49b8bdb7-gbx79   1/1     Running   0          121m   192.168.197.65   netlab7   <none>           <none>

    [root@netlab7 ~]# docker inspect k8s_netops_netops-f49b8bdb7-8d747_demo_97fa310a-90cc-4f46-a5d4-fa3ece50511a_0 |  jq -r '.[].State.Pid'
    709675

    [root@netlab7 ~]# ip netns identify 709675
    
    [root@netlab7 ~]# cd /var/run/
    [root@netlab7 run]# ln -s /var/run/docker/netns netns
    
    [root@netlab7 run]# ip netns identify 709675
    a2badaf582ef    

    [root@netlab7 run]# ip netns list
    a2badaf582ef (id: 1)
    a8c95b2f1d86 (id: 0)
    default

    [root@netlab7 run]# nsenter -t 709675 -n ip a
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
        valid_lft forever preferred_lft forever
    2: tunl0@NONE: <NOARP> mtu 1480 qdisc noop state DOWN group default qlen 1000
        link/ipip 0.0.0.0 brd 0.0.0.0
    4: eth0@if8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1480 qdisc noqueue state UP group default
        link/ether de:94:bb:a8:4b:86 brd ff:ff:ff:ff:ff:ff link-netns default
        inet 192.168.197.66/32 scope global eth0
        valid_lft forever preferred_lft forever
       
    #ip addr show (trimmed output)

    ...
    7: cali7901bed189a@if4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1480 qdisc noqueue state UP group default
    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns a8c95b2f1d86
    inet6 fe80::ecee:eeff:feee:eeee/64 scope link
       valid_lft forever preferred_lft forever
    8: cali68a5797a837@if4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1480 qdisc noqueue state UP group default
        link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns a2badaf582ef
        inet6 fe80::ecee:eeff:feee:eeee/64 scope link
        valid_lft forever preferred_lft forever
    ...

    Note:
    Network namespace name : a2badaf582ef  can be mapped against the link to understand the veth pair.

    Also eth0@if8 within the docker container indicates that the ID is "8" and the iface id from rootns which has
    "8" is cali68a5797a837

    Another way to map it 
    [root@netlab7 run]# ip -j addr show  | jq -cr '.[] | select (.link_index != null) | { ifindex: .ifindex, link_index: .link_index, ifname: .ifname}'
    {"ifindex":7,"link_index":4,"ifname":"cali7901bed189a"}
    {"ifindex":8,"link_index":4,"ifname":"cali68a5797a837"}

    [root@netlab7 ~]# for container in $(docker container ls | egrep -v 'pause|kube-proxy|CONTAINER'  | awk '{print $1}') ;do echo -n [ $container ]: ; docker exec -it $container bash -c 'ip -j addr show ' | jq -cr '.[] | select (.link_index != null) | { ifindex: .ifindex, link_index: .link_index, ifname: .ifname}' | jq -rc; done
    [ adfe6a7cdedb ]:{"ifindex":4,"link_index":8,"ifname":"eth0"}
    [ 7d1ac8e70bf5 ]:{"ifindex":4,"link_index":7,"ifname":"eth0"}
    [ c1fcefbe3e73 ]:{"ifindex":7,"link_index":4,"ifname":"cali7901bed189a"}
    {"ifindex":8,"link_index":4,"ifname":"cali68a5797a837"}    

    #Need to write a python script to consoldiate and list all container, if names with mapping.


</pre>		

</div>
<!-- container -->		


<!-- container -->		
<div class="screen-one-item-container">
	<h3>  SUBTITLE </h3>
	<p> </p>
	<p> </p>

<pre>
CODE BLOCK
</pre>		

</div>
<!-- container -->		



<!-- container -->		
<div class="screen-one-item-container">
	<h3>  SUBTITLE </h3>
	<p> </p>
	<p> </p>

<pre>
CODE BLOCK
</pre>		

</div>
<!-- container -->		


<!-- container -->		
<div class="screen-one-item-container">
	<h3>  SUBTITLE </h3>
	<p> </p>
	<p> </p>

<pre>
CODE BLOCK
</pre>		

</div>
<!-- container -->		




	

</body>
</html>
