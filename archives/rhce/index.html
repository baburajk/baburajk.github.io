<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="Generator" content="EditPlus®">
  <meta name="Author" content="">
  <meta name="Keywords" content="">
  <meta name="Description" content="">
  <title>Notes</title>
 <link rel="stylesheet" href="css/stylesheet1.css">
 <link rel="stylesheet" href="css/stylesheet2.css">
 <link rel="stylesheet" href="css/w3.css">

 <style type="text/css" >
	  
 </style>
<script Language="Javascript">
function toggle() {
    var x = document.getElementById('contents');
    if (x.style.display === 'none') {
		document.getElementById("togglelink").text = "hide"
        x.style.display = 'block';
    } else {
        x.style.display = 'none';
		document.getElementById("togglelink").text = "show"
    }
}
</script>


 </head>
	<body> 
		<div id="nav">
			<div id="jumplinks"> Quick notes </div>
		</div>
    
		<div id="body">
			<div id="content" class="mw-body" role="main">
 				<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2><span class="toctoggle">&nbsp;[<a href="javascript:toggle()" id="togglelink">hide</a>]&nbsp;</span></div>
					<div id="contents">
						<ul>
							<li> <a href="#DNS">	 <span class="tocnumber">	1 </span> <span class="toctext"> DNS  	</span></a> </li>
              <li> <a href="#SELINUX">   <span class="tocnumber"> 2 </span> <span class="toctext"> SELinux   </span></a> </li>
              <li> <a href="#SAMBA">   <span class="tocnumber"> 3 </span> <span class="toctext"> Samba  </span></a> </li>
              <li> <a href="#POSTFIX">   <span class="tocnumber"> 4 </span> <span class="toctext"> Postfix  </span></a> </li>
              <li> <a href="#NTP">   <span class="tocnumber"> 5 </span> <span class="toctext"> NTP  </span></a> </li>
              <li> <a href="#KERBEROS">   <span class="tocnumber"> 6 </span> <span class="toctext"> Kerberos  </span></a> </li>
              <li> <a href="#NETWORKING">   <span class="tocnumber"> 7 </span> <span class="toctext"> Networking  </span></a> </li>
              <li> <a href="#APACHE">   <span class="tocnumber"> 8 </span> <span class="toctext"> Apache  </span></a> </li>
              <li> <a href="#MARIADB">   <span class="tocnumber"> 9 </span> <span class="toctext"> MariaDB  </span></a> </li>
              <li> <a href="#ISCSI">   <span class="tocnumber"> 10 </span> <span class="toctext"> ISCSI  </span></a> </li>
              <li> <a href="#BOOT">   <span class="tocnumber"> 11 </span> <span class="toctext"> Boot  </span></a> </li>
              <li> <a href="#LVM">   <span class="tocnumber"> 12 </span> <span class="toctext"> LVM  </span></a> </li>
              <li> <a href="#NFS">  <span class="tocnumber">  13 </span> <span class="toctext"> NFS   </span></a> </li>
              <li> <a href="#VIRTUALIZATION">  <span class="tocnumber">  14 </span> <span class="toctext"> Virtualization   </span></a> </li>
              <li> <a href="#SECURITY">  <span class="tocnumber">  15 </span> <span class="toctext"> Security   </span></a> </li>
              <li> <a href="#KICKSTART">  <span class="tocnumber">  16 </span> <span class="toctext"> Kickstart   </span></a> </li>
              <li> <a href="#DHCP">  <span class="tocnumber">  17 </span> <span class="toctext"> DHCP   </span></a> </li>
              <li> <a href="#INTERFACES">  <span class="tocnumber">  18 </span> <span class="toctext"> Interfaces   </span></a> </li>
              <li> <a href="#STORAGE">  <span class="tocnumber">  19 </span> <span class="toctext"> Storage   </span></a> </li>
             <li> <a href="#VNET">  <span class="tocnumber">  20 </span> <span class="toctext"> Virtual Networking   </span></a> </li>
              <li> <a href="#GENERIC">  <span class="tocnumber">  21 </span> <span class="toctext"> Generic   </span></a> </li>
              <li> <a href="#QUESTIONS">  <span class="tocnumber">  22 </span> <span class="toctext"> Questions   </span></a> </li>
         			<li> <a href="#LDAP"> <span class="tocnumber">	23 </span> <span class="toctext"> LDAP 	</span></a> </li> 

              <li> <a href="#WEB"> <span class="tocnumber">  24 </span> <span class="toctext"> WEB </span></a> </li> 

						</ul>
					</div>
				</div>

				<style>
					html,body,h1,h2,h3,h4,h5,h6 { font-family: "Comic Sans MS", cursive, sans-serif; }
				</style>
 

<p>

< GENERIC >   <br>
0. Install tcp_wrappers, also enable firewall-cmd --add-serivce ssh(test specific) <br>
1. Enable Services on both (iscsi requires enablement on client as well.) <br>
2. Check SELINUX context and booleans ( sepolicy booleans, seinfo -t) <br>
3. Add firewalld with --permanent.<br>
4. Install SELINUX Docs. (sepolicy manpage -a -p /usr/share/man/man8, mandb) <br>
5. For Kerberos run authconfig with --update to ensure the kerberos is enabled. (Enable *SSSD* in sssd.conf, install sssd as well) <br>
6. Update /etc/krb5.conf - Kerberos REALM, also update ACL on both client and server : /var/kerberos/krb5kdc/kadm5.acl<br>
7. When it comes to NFS, addprinc -randkey host/<hostname> , nfs/<hostname>, cifs/<hostname><br>
8. Configure NTP/Chrony along with Kerberos and ensure the timesync before Kerberos setup.<br>
9. Enable nfs-secure on both server and client (  mount -o v4.2,sec=krb5p alongwith RPCNFSDARGS="-V 4.2" in /etc/sysconfig/nfs<br>
10.Check semanage permissive -a <type> and back it out via -d to see if there are selinux issues (preview changes by semanage fcontext -C -l).<br>
11.Refer to /usr/share/doc/pam-1.1.8/txts/*listfile* for restricting logins.<br>
12.Add samba-client to FW on the client as well.<br>
13.In general add UID/GID to any users getting created for easy mapping.<br>
14.For NFS, if public_content_rw_t is used nfs_anon_write boolean should be enabled and <br>
15.Do a nmap scan at the end to ensure the ports are open:  nmap -Pn -sT dns4.intercloudzone.com<br>
16.Restricting a login options: /etc/nologin, /etc/securetty (console/root), /sbin/nologin (passwd file), pam_sshd(listfile),
   tcpd(/etc/hosts.allow or hosts.deny), sshd_config(DenyUsers/AllowUsers)<br>
17. Routing information doc: /usr/share/doc/initscripts-9.49.39/sysconfig.txt<br>
18. Apache Home Directory(chmod o+x /home/userdir or setfacl -R -m u:apache:X /home/userdir, setfacl -R -m d:u:apache:X  /home/userdir)<br>
19. Unable to login to mysql (Worst-case, mysqld_safe --skip-grant-tables, update user set password=password('oracle') where user='root')<br>
20. Deny login access (/etc/securetty, /sbin/nologin, /etc/nologin, /etc/pam.d/ssh (Refer *listfiles*), sshd_config(DenyUsers))<br>
21. /usr/libexec/mysqld --verbose --help and mysqladmin variables (lists the current system)<br>
22. Add Header always set Strict-Transport-Security for HSTS under VirtualHost.<br>
23. ldapsearch example (ldapsearch -x cn=ldapuser01 -b dc=intercloudzone,dc=com) or ldapadd -x -w redhat -D "cn=Manager,dc=intercloudzone,dc=com" 
    x = simple auth, b = Base DN, D = Bind DN.<br>
24. IP Forwarding ( net.ipv6.conf.all.forwarding and net.ipv4.ip_forward)<br>
25. Disable ICMPs ( sysctl -w net.ipv4.icmp_echo_ignore_all=1) or ICMP Broadcasts (sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1)<br>
26. HTTP: Do restorecon after copying certs/pkeys to /etc/pki/tls/certs for SSL enabling.<br>
27. /etc/profile is executed only on a login shell vs. /etc/bashrc are executed everytime a shell is created. So any command ot be available for sub-shell, should be in the bashrc script.<br>
28. smbd_anon_write and samba_share_nfs should be enabled if the context is public_content_rw_t<br>

<br> RHCE Specifics<br>

1.  Use subnets/IP addresses along with hostnames where ever possible, including allow/deny access for services<br>
2.  Ensure chrony/ntp is installed/configured for nfs-secure/kerberos. Also do restorecon /etc/krb5.keytab. Install kerberos-workstation as well.<br>
3.  Add ssh for firewalld/systemctl enable ssh.<br>
4.  Samba booleans, also ensure the directory permissions are in tact.<br>
5.  Note: semanage fcontext, should be followed by restorecon.<br>
6.  Samba mount options, ntlmssp and multiuser.<br>
7.  Do chown for named.<br>
8.  httpd manuals of interest, auth.html, sections.html.<br>
9.  Careful with AllowUsers implicitly all the rest are denied.<br>
10.  ISCSI add service and also add port to firewalld and enable the iscsi, iscsiadm on the client.<br>
11.  _netdev important in the fstab and also UUID.<br>
12.  Caching DNS server, ensure the resolv.conf is updated.<br>
13.  To enable Samba home directories do enable on both server and client. <br>
  setsebool -P use_samba_home_dirs on<br>
  setsebool -P samba_enable_home_dirs on<br>
14. For NFS/Kerberos, install the chrony, add server to ntp server and also do timedate-ctl set-ntp true <br>
15. In tcp_wrappers only for IPv4, the CIDR notation is NOT supported. Adhere to either of these options:  ALL : 192.168.0.0/255.255.254.0 or ALL : 192.168.<br>
16. In samba hosts allow can be 192.168., 127.0 comma separated <br>
17. If man pages screws/rolls over :  man ls | col -b > /tmp/ls.lst. Another option is to export LESS="-XF"


</p>


<div class="w3-container">
	<h1><span class="mw-headline" id="DNS"> DNS </h1>


<pre>

--ALlows DNS connectivity from remote hosts as well.

listen-on port 53 { any ; };


--ACL Examples

acl black-hats {
    10.0.2.0/24;
    192.168.0.0/24;
 };

 acl red-hats {
    10.0.1.0/24;
 };

acl "trusted" {
  127.0.0.0/8;
  192.168.122.0/24;
};

 options {
    blackhole { black-hats; };
    allow-query     { localhost; trusted ; };
    allow-recursion { red-hats; };
 }
 
--Create master zone

zone "intercloudzone.com" IN {
  type master;
  file "intercloudzone.db";
};

zone "122.168.192.in-addr.arpa" IN {
  type master;
  file "122.168.192.in-addr.arpa.db";
};

--GENERATE function can be used to generate multiple hosts.

[root@rhce5 named]# cat 122.168.192.in-addr.arpa.db
$TTL 1D
$ORIGIN 122.168.192.in-addr.arpa.
@ IN SOA  @ root.intercloudzone.com. (
          0 ; serial
          1D  ; refresh
          1H  ; retry
          1W  ; expire
          3H )  ; minimum
  NS  dns.intercloudzone.com.
$GENERATE 4-5 @ NS  rhce$.intercloudzone.com.
50  PTR   dns.intercloudzone.com.
90  PTR   dummy.intercloudzone.com.
$GENERATE 80-85 $ PTR dummy$.intercloudzone.com.

[root@rhce5 named]# named-checkzone -D 122.168.192.in-addr.arpa 122.168.192.in-addr.arpa.db
zone 122.168.192.in-addr.arpa/IN: loaded serial 0
122.168.192.in-addr.arpa.         86400 IN SOA  122.168.192.in-addr.arpa. root.intercloudzone.com. 0 86400 3600 604800 10800
122.168.192.in-addr.arpa.         86400 IN NS rhce4.intercloudzone.com.
122.168.192.in-addr.arpa.         86400 IN NS rhce5.intercloudzone.com.
122.168.192.in-addr.arpa.         86400 IN NS dns.intercloudzone.com.
50.122.168.192.in-addr.arpa.          86400 IN PTR  dns.intercloudzone.com.
80.122.168.192.in-addr.arpa.          86400 IN PTR  dummy80.intercloudzone.com.
81.122.168.192.in-addr.arpa.          86400 IN PTR  dummy81.intercloudzone.com.
82.122.168.192.in-addr.arpa.          86400 IN PTR  dummy82.intercloudzone.com.
83.122.168.192.in-addr.arpa.          86400 IN PTR  dummy83.intercloudzone.com.
84.122.168.192.in-addr.arpa.          86400 IN PTR  dummy84.intercloudzone.com.
85.122.168.192.in-addr.arpa.          86400 IN PTR  dummy85.intercloudzone.com.
90.122.168.192.in-addr.arpa.          86400 IN PTR  dummy.intercloudzone.com.
OK


[root@rhce5 named]# dig +short -x 192.168.122.90 @192.168.122.50
dummy.intercloudzone.com.

[root@rhce5 named]# dig +short -x 192.168.122.85 @192.168.122.50
dummy85.intercloudzone.com.


[root@rhce4 named]# named-checkconf -z /etc/named.conf
zone intercloudzone.com/IN: loaded serial 0
zone 122.168.192.in-addr.arpa/IN: loaded serial 0
zone localhost.localdomain/IN: loaded serial 0
zone localhost/IN: loaded serial 0
zone 1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa/IN: loaded serial 0
zone 1.0.0.127.in-addr.arpa/IN: loaded serial 0
zone 0.in-addr.arpa/IN: loaded serial 0

--Authoratative queries ( aa after the query output indicates the answer is from the Authoratative server)


[root@rhce5 named]# cat intercloudzone.db
$TTL 1D
$ORIGIN intercloudzone.com.
@ IN SOA  @ root.intercloudzone.com. (
          0 ; serial
          1D  ; refresh
          1H  ; retry
          1W  ; expire
          3H )  ; minimum
  NS    dns
  MX  10  mail
dns A   192.168.122.50
mail  A   192.168.122.50
dummy A   192.168.122.90
dummy2 CNAME    dummy

[root@rhce5 named]# named-checkzone -D intercloudzone.com intercloudzone.db
zone intercloudzone.com/IN: loaded serial 0
intercloudzone.com.           86400 IN SOA  intercloudzone.com. root.intercloudzone.com. 0 86400 3600 604800 10800
intercloudzone.com.           86400 IN NS dns.intercloudzone.com.
intercloudzone.com.           86400 IN MX 10 mail.intercloudzone.com.
dns.intercloudzone.com.           86400 IN A  192.168.122.50
dummy.intercloudzone.com.         86400 IN A  192.168.122.90
dummy2.intercloudzone.com.          86400 IN CNAME  dummy.intercloudzone.com.
mail.intercloudzone.com.          86400 IN A  192.168.122.50
OK

[root@rhce5 named]# dig +short dummy.intercloudzone.com @192.168.122.50
192.168.122.90

[root@rhce5 named]# dig +short dummy2.intercloudzone.com @192.168.122.50
dummy.intercloudzone.com.
192.168.122.90

--Note
Ensure the '.' at the end : $ORIGIN intercloudzone.com.


--To flush the local cache 
rndc flush

--Dump the database
rndc dump
rndc dumpdb -zones

--Chown root:named, add the zone to /etc/named.conf 

--Unbound (lightweight)

 unbound-control-setup ( Set's up the cred keys)

--Configs worth noting.
inteface, access-control and forward-zone

</pre>
	

<div class="w3-container">
  <h1><span class="mw-headline" id="SELINUX"> SELinux </h1>
  
<p>

</p>

<pre>

-Selinux commands can be batched for performance

[root@rhce5 data]# semanage -i -<<_EOF
port -a -t http_port_t -p tcp 81
fcontext -a -t httpd_sys_content_t "/shared(/.*)?"
_EOF

-Prints customizations to the console 
[root@rhce5 data]# semanage output -o -
..
port -a -t http_port_t -p tcp 81
fcontext -a -f a -t httpd_sys_content_t '/shared(/.*)?'

or
semanage fcontext -C -l
semanage boolean -C -l

-Transition - this says initrc_t executing httpd_exec_t will transition to httpd_t

[root@rhce5 data]# sesearch -T -s initrc_t -t httpd_exec_t
Found 1 semantic te rules:
   type_transition initrc_t httpd_exec_t : process httpd_t;

-List customized contexts

[root@rhce5 data]# semanage fcontext -lC
SELinux fcontext                                   type               Context

/shared(/.*)?                                      all files          system_u:object_r:httpd_sys_content_t:s0

[root@rhce5 data]# semanage permissive -a httpd_t
[root@rhce5 data]# semanage permissive --list

Customized Permissive Types

httpd_t

Builtin Permissive Types


--Files with context type public_content_t/public_content_rw_t  type allow them to be read by FTP, Apache, Samba and rsync
but also requires to have the boolen flag ready ( in case of samba below)
 setsebool -P smbd_anon_write=1


--Remote mounting an apache dir via NFS.

-On Server - add FW, export the FS.
firewall-cmd --add-service={nfs,rpc-bind,mountd}

[root@rhce4 ~]# exportfs -vr
exporting *:/var/www/html
..

systemctl start nfs rpcbind nfs-mountd

-On Client.
mount -o context="system_u:object_r:httpd_sys_content_t:s0" rhce4.intercloudzone.com:/var/www/html /var/www/ -v

Option-2 is to set the boolean
setsebool -P httpd_use_nfs=1


--ausearch options

ausearch -x httpd 
ausearch -m avc --start today


-Sequence to remember.

a) Enable service
b) Add firewalld --permanenent.
c) Add semanage fcontext 
d) Run restorecon -vR
e) Enable semanage port

 
</pre>


<div class="w3-container">
	<h1><span class="mw-headline" id="SAMBA"> Samba </h1>
<p>

</p>


<pre> 
 
Reference:
<a href="https://www.lisenet.com/2016/samba-server-on-rhel-7/"> Samba Configuration on lisnet </a>

Any directory/file system you want to share on the network with Samba alone needs to have samba_share_t type applied to it. 

public_content_t type allow them to be read by FTP, Apache, Samba and rsync. 
Files labeled with the public_content_rw_t type require booleans to be set before 
services can write to files labeled with the public_content_rw_t type.

For Samba it's - smbd_anon_write.

Another important boolean is samba_share_nfs. By default, SELinux prevents Samba daemons from reading and writing NFS shares.
# setsebool -P samba_share_nfs=1


--Debug
[root@rhce3 ~]# smbclient -k //rhce2/smbsdata -U user7 -d9

[root@rhce3 samba]# smbclient -L //rhce2 -U user11
Enter SAMBA\user11's password:
session setup failed: NT_STATUS_LOGON_FAILURE

* Change it to FQDN

[root@rhce3 samba]# smbclient -L //rhce2.intercloudzone.com -U user11
Enter SAMBA\user11's password:
Domain=[RHCE2] OS=[Windows 6.1] Server=[Samba 4.6.2]

--Samba multiuser option with elevated privlege.
mount -o username=dev2 -o rw,multiuser,sec=ntlmssp //rhce1.intercloudzone.com/smbdevops /mnt/smbmulti/

setsebool -P samba_share_nfs=1

-Check the public share via guest.

smbclient //localhost/public guest%

[root@rhce5 ~]# mount -o username=kuttu,multiuser,sec=ntlmssp //kerberos.intercloudzone.com/smbshare /sambamount
Password for kuttu@//kerberos.intercloudzone.com/smbshare:  *****

[kuttu@rhce5 sambamount]$ ls -al
ls: reading directory .: Permission denied
total 0

[root@rhce5 ~]# touch /sambamount/cfile
touch: cannot touch ‘/sambamount/cfile’: Permission denied

[kuttu@rhce5 sambamount]$ id
uid=1000(kuttu) gid=1000(kuttu) groups=1000(kuttu) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
[kuttu@rhce5 sambamount]$ cifscreds add kerberos.intercloudzone.com
Password:

[kuttu@rhce5 sambamount]$ ls -ltr
total 0
-rw-r--r--. 1 root root 0 May 11 16:35 afile
-rw-r--r--. 1 root root 0 May 11 16:35 bfile

-- Group share
semanage fcontext -a -t samba_share_t "/groupshare(/.*)?"
restorecon -v /groupshare/

chown root:group1 /groupshare/
chmod 2770 /groupshare/

groupadd -g 2000 group1
useradd -u 3000 -G group1 user1
useradd -u 3000 -G group1 user2

smbpasswd -x user1
smbpasswd -x user2

[groupshare]
       comment = Group Share
       path = /groupshare
  valid users = @group1
  writable = yes
  create mask = 0660
  force create mode = 0660

testparm - Will test the syntax of configuration file.

On Client:
mount //kerberos.intercloudzone.com/groupshare /groupmount/ -o username=user1
mount //kerberos.intercloudzone.com/groupshare /groupmount/ -o username=user2


--Samba 

[root@rhce4 samba]# lsof -i :445
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
smbd    2870 root   34u  IPv6  42902      0t0  TCP *:microsoft-ds (LISTEN)
smbd    2870 root   36u  IPv4  42904      0t0  TCP *:microsoft-ds (LISTEN)
 

[root@rhce4 samba]# smbclient  //kerberos.intercloudzone.com/smbshare -U kuttu
Enter SAMBA\kuttu's password:
tree connect failed: NT_STATUS_BAD_NETWORK_NAME

File Permissions, DNS definition and SELINUX booleans are 3 things to triple check here

</pre>


<div class="w3-container">
  <h1><span class="mw-headline" id="POSTFIX"> Postfix </h1>
<p>

</p>


<pre> 


--postix null client configuration

myhostname = srv1.rhce.local
mydomain = rhce.local
myorigin = $mydomain
relayhost = [10.8.8.70] # Disable MX lookups by using SQuare brackets.
inet_interfaces = loopback-only #    Do not accept mail from the network.
mydestination =           "Disable local mail delivery. All mail goes to the mail server s specified in relayhost"
mynetworks = 127.0.0.0/8 [::]/128 #Only messages that originate from the 127.0.0.0/8 network and the [::1]/128 network are forwarded to the relay host by the null client.
local_transport = error: local delivery disable # prevent the local null client from sorting any mail into mailboxes

--Postfix/Sendmail.
Only one service should be running, check via alternativies --list ( shutoff one) to avoid errors.

--A user with /sbin/nologin can check mail due to the fact that the saslauth is configured..

[root@rhce4 ~]# cat /etc/sasl2/smtpd.conf
pwcheck_method: saslauthd
mech_list: plain login

--Configure Postfix to enable user authentication on the physical host system. Do not make any additional changes to the local system.
Make sure e-mails can be sent from user to user locally. Forward e-mails directed to the local root account to a regular account on the local system.

inet_interfaces = loopback-only
inet_protocols = all
myhostname = rhce5.intercloudzone.com
myorigin = $mydomain
mydestination = $myhostname, localhost.$mydomain, localhost

[root@rhce4 README_FILES]# grep ^root /etc/aliases
root:		devopsuser1
[root@rhce4 README_FILES]# newaliases

[root@rhce5 postfix]# telnet localhost 25
Trying ::1...
Connected to localhost.
Escape character is '^]'.
220 rhce5.intercloudzone.com ESMTP Postfix
EHLO localhost

[root@rhce5 postfix]# date | mail -s "Root mail" root@localhost
You have mail in /var/spool/mail/root
[root@rhce5 postfix]# mail -u devopsuser1
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
"/var/mail/devopsuser1": 3 messages 1 new
    1 root                  Wed May 16 17:20  19/678   "Test"
    2 root                  Wed May 16 17:20  19/678   "Test"
>N  3 root                  Wed May 16 18:46  18/651   "Root mail"
&

[root@rhce5 postfix]# firewall-cmd --add-rich-rule='rule family=ipv4 source address=192.168.0.0/16 service name=smtp accept'
success

1. Forward local mail, reject incoming mail

my_destination = localhost
inet_interfaces = loopback-only # No interfaces listening in on 25 to accept mail

relay_host = mailserver.com #Forward any mails

2. Receive local network mail and forward all mail to central mail server.

inet_interfaces = all
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain.
mynetworks = 192.168.122.0/24
disable_dns_lookups = yes

relay host = server.intercloudzone.com

-Delete all
postsuper -d ALL deferred

-Delete all emails for a specific user.
echo 'd *' | mail -N -u username

--For Postfix settings
man 5 postconf

--Relayhost settings
 
myhostname = rhce1.intercloudzone.com
myorigin = $mydomain
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
mynetworks = 192.168.122.0/24, 192.168.110.0/24, 127.0.0.0/8
smtp_host_lookup = native
disable_dns_lookups = yes # Deprecated from 2.11 onwards 
aliases is in /etc and should be updated with newaliases instead of postmap
smtp_dns_support_level = disabled # This parameter overrides all parameters and ensure DNS Looksps are disabled 
reject all incoming email : inet_interfaces = loopback-only ( all means receive mails)

The relayhost prevents mail from getting stuck on the null client if it is turned off while some remote destination is unreachable.

The loopback-only tells to not accept mail from the network. Only messages that originate from the
127.0.0.0/8 network and the [::1]/128 network are forwarded to the relay host by the null client.

We prevent the local null client from sorting any mail into mailboxes by putting a local_transport parameter. 
We also disable local mail delivery by not specifying mydestination. All mail goes to the mail server as specified in relayhost.
 Note that we can also use a DNS name for the relayhost, as well as turn off MX lookups by putting a record in square brackets.


--postfix
man 5 access 

Note: Check the man page and ensure the smptd_client_restrictions are added to main.cf

       /etc/postfix/main.cf:
           smtpd_client_restrictions =
               check_client_access hash:/etc/postfix/access

       /etc/postfix/access:
           1.2.3   REJECT
           1.2.3.4 OK

--Time out on DNS lookups
Apr 18 18:53:28 rhce4 postfix/smtp[2882]: B1A97651073: to=<mailer1@intercloudzone.com>, orig_to=<mailer1>, relay=none, delay=60, delays=0.11/0.02/60/0, dsn=4.4.1, status=deferred (connect to mx.intercloudzone.com[66.96.140.122]:25: Connection timed out)

[root@rhce4 ~]# postconf -d | grep dns
disable_dns_lookups = no

--Check queues
mailq

--Requeue
[root@rhce4 postfix]# postsuper -r DE48A60CCBE
postsuper: DE48A60CCBE: requeued

-Mail queues
mailq , postfix 

-Resend
postfix -f


</pre>

</div>


<div class="w3-container">
	<h1><span class="mw-headline" id="NTP"> NTP</h1>
<p>

</p>

<pre> 
  
--NTP

General info
Sync hardware clock to systemclock (if NTP isn't present)
hwclock --hctosys

Reverse..
hwclock --systohc

Before NTP configuation ensure the timezones are set correctly.

-Setup an NTP peer, make sure to remove 'nopeer' from below on client
and add peer server 

The "ntp server" command points to a server (meaning you are the client), and no matter what your clock says, 
you will jump to the server's clock setting because it has presumed authority of knowing what time it is.

The "ntp peer" command is set between two devices.  And the assumption is that  neither one has authority (equal, peering)
 to know what time it is, but the two will work on getting in sync.  Both sides will actually shift their clock 
 (maximum jump of two minutes at a time, so if clocks are way different then it'll take a while to sync!) towards each other.

restrict default nomodify notrap noquery
peer 192.168.122.50

Broadcast client listens only within the subnet
Multicast client can span the local subnet (similar to Broadcasti)

--Broadcast server configuration.
"restrict" is only inbound 

[root@rhce1 ~]# cat /etc/ntp.conf |grep -v ^# |grep -v ^$
driftfile /var/lib/ntp/drift
restrict default nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict ::1
server 0.rhel.pool.ntp.org iburst
server 1.rhel.pool.ntp.org iburst
server 2.rhel.pool.ntp.org iburst
server 3.rhel.pool.ntp.org iburst
broadcast 192.168.122.255 iburst
disable auth
includefile /etc/ntp/crypto/pw
keys /etc/ntp/keys
disable monitor

[root@rhce1 ~]# ntpq -p; ntpstat
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*up2.com         195.219.14.21    2 u   43   64    1   53.916   -7.959   2.288
 orchid.sidereal 200.98.196.212   2 u   42   64    1   51.787  -10.519   5.668
 static-96-244-9 192.168.10.254   2 u   41   64    1   60.231   -0.570   3.590
 ns1.rx-name.net 193.190.147.153  3 u   40   64    1  172.425    1.124   2.824
 192.168.122.255 .BCST.          16 u    -   64    0    0.000    0.000   0.000
synchronised to NTP server (216.6.2.70) at stratum 3
   time correct to within 1043 ms
   polling server every 64 s


--Broadcast client should have the subnet restrict clause so it can use the broadcast server subnet.

[root@rhce2 ~]# cat /etc/ntp.conf |grep -v ^# |grep -v ^$
driftfile /var/lib/ntp/drift
restrict default nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict ::1
restrict 192.168.122.0 mask 255.255.255.0 nomodify notrap
broadcastclient
disable auth
includefile /etc/ntp/crypto/pw
keys /etc/ntp/keys
disable monitor

[root@rhce2 ~]# ntpq -p ; ntpstat
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
*rhce1           96.244.96.19     3 u   20   64    1    0.357  -28.578   0.061
synchronised to NTP server (192.168.122.10) at stratum 4
   time correct to within 1040 ms
   polling server every 64 s



[root@lab125a ~]# ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
-ns3.weiszhostin 64.250.105.228   2 u   17   64    1   69.389   -1.701   3.561
+b1-66er.matrix. 129.6.15.30      2 u   16   64    1   59.531    4.167   1.907
+y.ns.gin.ntt.ne 249.224.99.213   2 u   15   64    1   19.662    1.950   3.374
*level1g.cs.unc. .PPS.            1 u   14   64    1   59.402    3.533   4.409
 192.168.2.255   .BCST.          16 u    -   64    0    0.000    0.000   0.000


* => Current source of sync
- => Indicates system not considered for sync.
Blank => Indicates server rejected or high stratum level or failed sanity checks.

3rd Column Stratum; Anything > 15 is invalid.

reach = 377 All probes were answered.

--Display in seconds.
ntpdc -p 

timedatectl set-ntp 0

-Chrony commands examples
chroncy sources -v, chrony burst 2/4 

</pre>

</div>

 
<div class="w3-container">
	<h1><span class="mw-headline" id="KERBEROS"> Kerberos </h1>	
<p>
 
	
</p>

<pre> 

--Update Host file Note (If DNS is not being used, make sure the FQDN is right after the IP in /etc/hosts)

192.168.122.10 rhce1.intercloudzone.com rhce1
192.168.122.20 rhce2.intercloudzone.com rhce2

--Install Packages (On the Server)
yum install -y krb5-server krb5-workstation pam_krb5


Note: Without pam_krb5 module, the authconfig will fail
[root@rhce2 ~]# authconfig --enablekrb5 --update
authconfig: Authentication module /usr/lib64/security/pam_krb5.so is missing. Authentication process might not work correctly.


--Edit /etc/krb5.conf to update realm

--Update KDC configuration files with the FQDN (REALM)

[root@rhce1 ~]# grep -i intercloudzone /etc/krb5.conf
 default_realm = INTERCLOUDZONE.COM
 INTERCLOUDZONE.COM = {
  kdc = rhce1.intercloudzone.com
  admin_server = rhce1.intercloudzone.com
 .intercloudzone.com = INTERCLOUDZONE.COM
 intercloudzone.com = INTERCLOUDZONE.COM


-- Update ACL with the realm.
[root@rhce1 ~]# sed -i 's/EXAMPLE/INTERCLOUDZONE/g' /var/kerberos/krb5kdc/kadm5.acl
[root@rhce1 ~]# cat /var/kerberos/krb5kdc/kadm5.acl
*/admin@INTERCLOUDZONE.COM  *


-- Create krb5 DB( -s creates stash file )

[root@rhce1 ~]# kdb5_util create -s -r INTERCLOUDZONE.COM
Loading random data
Initializing database '/var/kerberos/krb5kdc/principal' for realm 'INTERCLOUDZONE.COM',
master key name 'K/M@INTERCLOUDZONE.COM'
You will be prompted for the database Master Password.
It is important that you NOT FORGET this password.
Enter KDC database master key:

[root@rhce1 ~]# rpm -ql krb5-server-1.15.1-8.el7.x86_64 |grep systemd
/usr/lib/systemd/system/kadmin.service
/usr/lib/systemd/system/kprop.service
/usr/lib/systemd/system/krb5kdc.service

-Start admin & KDC

For kerberos to work time sync should be working (chrony/ntp)
systemctl start krb5kdc kadmin

--Add services to firewall

[root@rhce2 ~]# nc -v rhce1.intercloudzone.com 88  
Ncat: Version 6.40 ( http://nmap.org/ncat )
libnsock nsi_new2(): nsi_new (IOD #1)
libnsock nsock_connect_tcp(): TCP connection requested to 192.168.122.10:88 (IOD #1) EID 8
libnsock nsock_trace_handler_callback(): Callback: CONNECT ERROR [No route to host (113)] for EID 8 [192.168.122.10:88]
Ncat: No route to host.

--Enable kerberos with firewalld on rhce1 and retry


[root@rhce1 icmptypes]# firewall-cmd --permanent --add-service kerberos
success
[root@rhce1 icmptypes]# firewall-cmd --permanent --add-service kadmin
success
[root@rhce1 icmptypes]# firewall-cmd --reload
success


--Create admin & users (to test) and add hosts

kadmin.local:  addprinc root/admin
kadmin.local:  addprinc kuttu
kadmin.local: addprinc -randkey host/rhce1.intercloudzone.com
kadmin.local: addprinc -randkey host/rhce2.intercloudzone.com
useradd kuttu

systemctl restart krb5kdc kadmin

--Create a local copy stored by default in the /etc/krb5.keytab file:
kadmin.local:  ktadd host/rhce1.intercloudzone.com


--Test KDC on the server itself , add to /etc/ssh/sshd_config followed

GSSAPIAuthentication yes
GSSAPIDelegateCredentials yes

systemctl reload sshd


--On Client (Enable these)
[root@rhce2 ~]# grep yes /etc/ssh/ssh_config
 
   GSSAPIAuthentication yes
   GSSAPIDelegateCredentials yes
 
 --Test it on the server itself.


[kuttu@rhce1 ~]$ kinit
Password for kuttu@INTERCLOUDZONE.COM:
[kuttu@rhce1 ~]$ klist
Ticket cache: KEYRING:persistent:1002:1002
Default principal: kuttu@INTERCLOUDZONE.COM

Valid starting       Expires              Service principal
01/19/2018 13:06:41  01/20/2018 13:06:41  krbtgt/INTERCLOUDZONE.COM@INTERCLOUDZONE.COM

[kuttu@rhce1 ~]$ ssh rhce1.intercloudzone.com
Last login: Fri Jan 19 13:06:39 2018


[kuttu@rhce1 ~]$ kdestroy
[kuttu@rhce1 ~]$ klist
klist: Credentials cache keyring 'persistent:1002:1002' not found
[kuttu@rhce1 ~]$ ssh rhce1.intercloudzone.com
kuttu@rhce1.intercloudzone.com's password:


-Logs of interest.
 /var/log/krb5kdc.log /var/log/secure /var/log/messages and /var/log/audit/audit.log

Make sure to add root user , run ktadd -k /etc/krb5.keytab and ship the keytab file to client.

[root@rhce1 exports.d]# klist -k /etc/krb5.keytab
Keytab name: FILE:/etc/krb5.keytab
KVNO Principal
---- --------------------------------------------------------------------------
   3 usera@INTERCLOUDZONE.COM
   3 usera@INTERCLOUDZONE.COM
   2 host/rhce2.intercloudzone.com@INTERCLOUDZONE.COM
   2 host/rhce2.intercloudzone.com@INTERCLOUDZONE.COM
   2 host/kerberos.intercloudzone.com@INTERCLOUDZONE.COM
   2 host/kerberos.intercloudzone.com@INTERCLOUDZONE.COM
   2 root/admin@INTERCLOUDZONE.COM
   2 root/admin@INTERCLOUDZONE.COM

--Add client host and principal user.

kadmin -p root/admin
kadmin: addprinc -randkey host/rhce2.intercloudzone.com
kadmin: addprinc kannan/rhce2.intercloudzone.com

-While logged in extract principal's key and store it locally in a keytab file called krb5.keytab
kadmin:  ktadd -k /etc/krb5.keytab host/rhce2.intercloudzone.com

authconfig --enablekrb5 --update --test
authconfig --enablekrb5 --update

--Backup
kdb5_util dump -verbose /tmp/kdc.dump
strings /backup/kdc.dump

--Restore
kdb5_util load /backup/kdc.dump

--Display Keylist (Principals) in a Keytab File
klist -kt /etc/krb5.keytab

--Remove keylist (Principals) from a keytab file
ktremove -k /etc/krb5.keytab usera

--Troubleshoot
# export KRB5_TRACE=/dev/stdout
# kinit

 </pre>

</div>

 
	
<div class="w3-container">
	<h1><span class="mw-headline" id="NFS"> NFS</h1>	
<p>
NFS, Kerberos
</p>

<pre> 

--Enable Debugging info into the nfs 
Change the parameter : /etc/sysconfig/nfs 
RPCGSSDARGS="-v -v -v "

Restart the services
systemctl restart nfs rpcbind


--NFS Sharing Details

SHARING FILES
If you want to share files with multiple domains (Apache, FTP, rsync, Samba), you can set a file context of public_content_t and public_content_rw_t. 
These context allow any of the above domains to read the content.

semanage fcontext -a -t public_content_t "/var/nfsd(/.*)?" 
restorecon -F -R -v /var/nfsd

Allow nfsd servers to read and write /var/nfsd/incoming by adding the public_content_rw_t type to the directory 
and by restoring the file type. You also need to turn on the nfsd_anon_write boolean.

semanage fcontext -a -t public_content_rw_t "/var/nfsd/incoming(/.*)?" 
restorecon -F -R -v /var/nfsd/incoming 
setsebool -P nfsd_anon_write 1

--install
yum install nfs-utils
systemctl enable rpcbind nfs nfs-server nfs-secure

Note: nfs-secure need to be enabled on both client and server. On client use v4.2,sec=krb5p to ensure SELinux lables are exported.



--Exportfs Syntax
export host1(options1) host2(options2) host3(options3)

--Mounted directories in /var/lib/nfs/etab

--Defaults
ro,sync,wdelay,root_squash (Squashes power of root)

--all_squash  
To squash every remote user (including root), use all_squash. To specify the user and group IDs that the NFS server 
should assign to remote users from a particular host, use the anonuid and anongid options, respectively, as in:
export host(anonuid=uid,anongid=gid)

--syntax
/home bob.example.com(rw) 
/home bob.example.com (rw)

The first line allows only users from bob.example.com read/write access to the /home directory. The second line allows users from 
bob.example.com to mount the directory as read-only (the default), while the rest of the world can mount it read/write.

--rpcbind
NFS requires rpcbind, which dynamically assigns ports for RPC services and can cause problems for configuring firewall rules. To allow
clients to access NFS shares behind a firewall, edit the /etc/sysconfig/nfs file to set which ports the RPC services run on

--Mounts listed
cat /var/lib/nfs/etab (server) and /etc/mtab (on client)

--NFS configuration
/etc/sysconfig/nfs

--Firewall
firewall-cmd add-service={nfs,mountd,rpc-bind}

--Check from client
showmount -e rhce1
rpcinfo -p rhce1.intercloudzone.com

--SElinux
getsebool -a | egrep '^nfs|^use_nfs'

--nfs-secure-server (Kerberos)
systemctl start kadmin krb5kdc nfs-secure


kadmin:  addprinc -randkey nfs/rhce1.intercloudzone.com
WARNING: no policy specified for nfs/rhce1.intercloudzone.com@INTERCLOUDZONE.COM; defaulting to no policy
Principal "nfs/rhce1.intercloudzone.com@INTERCLOUDZONE.COM" created.

kadmin:  addprinc -randkey nfs/rhce2.intercloudzone.com
WARNING: no policy specified for nfs/rhce2.intercloudzone.com@INTERCLOUDZONE.COM; defaulting to no policy
Principal "nfs/rhce2.intercloudzone.com@INTERCLOUDZONE.COM" created.

[root@rhce1 ~]# systemctl enable nfs-secure
[root@rhce1 ~]# systemctl start nfs-secure

[root@rhce2 ~]# kadmin
Authenticating as principal root/admin@INTERCLOUDZONE.COM with password.
Password for root/admin@INTERCLOUDZONE.COM:
kadmin:  ktadd nfs/rhce1.intercloudzone.com
Entry for principal nfs/rhce1.intercloudzone.com with kvno 2, encryption type aes256-cts-hmac-sha1-96 added to keytab FILE:/etc/krb5.keytab
..
...
Entry for principal nfs/rhce1.intercloudzone.com with kvno 2, encryption type des-cbc-md5 added to keytab FILE:/etc/krb5.keytab.
kadmin:  quit

[root@rhce2 ~]# ls -ltr /etc/krb5.keytab
-rw-------. 1 root root 3002 Feb  1 17:02 /etc/krb5.keytab

--Check the client for mounted directories
[root@rhce2 ~]# showmount -e rhce1
Export list for rhce1:
/nfskrb5  rhce2.intercloudzone.com
/nfsdata  rhce2.intercloudzone.com
/nfsrhcsa rhce3.intercloudzone.com
/common   rhce2.intercloudzone.com
 
--Notes
insecure in NFS property to ensure the clients use ports < 1024
nfsd server process runs on port 2049
rpcbind runs on both server & client.
rpc.quotad runs on both the server and client. 

=> On Server...

 
 
Test-1

[root@lab125a network-scripts]# cat /var/lib/nfs/etab
/nfsdummy0	lab125a(rw,sync,wdelay,hide,nocrossmnt,secure,no_root_squash,no_all_squash,
no_subtree_check,secure_locks,acl,no_pnfs,anonuid=65534,anongid=65534,sec=sys,rw,secure,no_root_squash,no_all_squash)
/nfsrw	lab125a(rw,sync,wdelay,hide,nocrossmnt,secure,
root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid=65534,anongid=65534,sec=sys,rw,secure,root_squash,all_squash)
/nfsro	lab125a(ro,sync,wdelay,hide,nocrossmnt,secure,no_root_squash,
no_all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid=65534,anongid=65534,sec=sys,ro,secure,no_root_squash,no_all_squash)

[root@lab130a network-scripts]# mount -v -t nfs -o rw 192.168.2.50:/nfsro /dataro
mount.nfs: timeout set for Mon Aug 21 14:45:53 2017
mount.nfs: trying text-based options 'vers=4,addr=192.168.2.50,clientaddr=192.168.2.53'
mount.nfs: mount(2): Permission denied
mount.nfs: access denied by server while mounting 192.168.2.50:/nfsro


#Ensure these

- Add both client and server to nfs
ktadd -k nfs/server.intercloudzone.com
ktadd -k nfs/client.intercloudzone.com

- Add both client and server to host
ktadd -k host/server.intercloudzone.com
ktadd -k host/client.intercloudzone.com

-Check the ACL to see if its updated
[root@rhce4 ~]# cat /var/kerberos/krb5kdc/kadm5.acl
*/admin@INTERCLOUDZONE.COM	*

-Copy the keytab file
[root@rhce5 ~]# scp server.intercloudzone.com:/etc/krb5.keytab /etc/
 Restricted computer - message from /etc/banner
root@server.intercloudzone.com's password:
krb5.keytab                                                                                     100% 8074     4.1MB/s   00:00

-Update the /etc/krb5.conf file on both server and client..
[root@rhce4 ~]# grep -Hi intercloudzone /etc/krb5.conf
/etc/krb5.conf: default_realm = INTERCLOUDZONE.COM
/etc/krb5.conf: INTERCLOUDZONE.COM = {
/etc/krb5.conf:  kdc = kerberos.intercloudzone.com
/etc/krb5.conf:  admin_server = kerberos.intercloudzone.com
/etc/krb5.conf: .intercloudzone.com = INTERCLOUDZONE.COM
/etc/krb5.conf: intercloudzone.com = INTERCLOUDZONE.COM

[root@rhce5 tester]# grep -Hi intercloudzone /etc/krb5.conf
/etc/krb5.conf: default_realm = INTERCLOUDZONE.COM
/etc/krb5.conf: INTERCLOUDZONE.COM = {
/etc/krb5.conf:  kdc = kerberos.intercloudzone.com
/etc/krb5.conf:  admin_server = kerberos.intercloudzone.com
/etc/krb5.conf: .intercloudzone.com = INTERCLOUDZONE.COM
/etc/krb5.conf: intercloudzone.com = INTERCLOUDZONE.COM


[root@rhce5 ~]# mount.nfs4 -vvv -o sec=krb5 server.intercloudzone.com:/shared /tester
mount.nfs4: timeout set for Thu May 10 09:07:59 2018
mount.nfs4: trying text-based options 'sec=krb5,vers=4.1,addr=192.168.122.40,clientaddr=192.168.122.50'


=> Errors.
https://bugzilla.redhat.com/show_bug.cgi?id=1402427

[root@rhce4 ~]# grep RPC /etc/sysconfig/nfs
RPCNFSDARGS=""
#RPCNFSDCOUNT=16
RPCMOUNTDOPTS=""
RPCIDMAPDARGS=""
RPCGSSDARGS="-vvv"

SELinux is preventing /usr/sbin/rpc.gssd from using the block_suspend capability.
May  7 20:37:24 rhce4 dbus[642]: [system] Activating service name='org.fedoraproject.Setroubleshootd' (using servicehelper)
May  7 20:37:25 rhce4 dbus[642]: [system] Successfully activated service 'org.fedoraproject.Setroubleshootd'
May  7 20:37:25 rhce4 setroubleshoot: SELinux is preventing /usr/sbin/rpc.gssd from using the block_suspend capability. For complete SELinux messages run: sealert -l 75c702ec-b199-44a5-9a16-705b0ec79cce
May  7 20:37:25 rhce4 python: SELinux is preventing /usr/sbin/rpc.gssd from using the block_suspend capability.#012#012*****  Plugin catchall (100. confidence) suggests   **************************#012#012If you believe that rpc.gssd should have the block_suspend capability by default.#012Then you should report this as a bug.#012You can generate a local policy module to allow this access.#012Do#012allow this access for now by executing:#012# ausearch -c 'rpc.gssd' --raw | audit2allow -M my-rpcgssd#012# semodule -i my-rpcgssd.pp#012


#Autofs mounting

[root@lab130a etc]# tail -2 auto.master
+auto.master
/-	/etc/auto.direct

[root@lab130a etc]# cat auto.direct
/autodir 192.168.2.50:/nfsexports/data

</pre>

</div>


	
<div class="w3-container">
	<h1><span class="mw-headline" id="NETWORKING"> Networking </h1>
	
<p>

</p>

	
<pre> 

--Notes

modprobe bonding
ls -l /usr/share/doc/teamd-1.25/example_configs/
man nmcli-examples
nmcli con add help ( to check the different configurations)
modinfo bonding
cat /proc/net/bonding/bond1

NB:Team ports should be down prior to adding to the Team Configuration
ip link show

--Enable IPv4 forwarding.
sysctl -w net.ipv4.ip_forward=1

--Add dummy interface and enforce static route to make it visible from the server.

[root@rhce1 ~]# modprobe dummy

[root@rhce1 ~]# ip link show dummy0
9: dummy0: <BROADCAST,NOARP> mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
    link/ether 8e:db:6e:b9:3c:51 brd ff:ff:ff:ff:ff:ff
[root@rhce1 ~]# ip link set name ethx dev dummy0

[root@rhce1 ~]# ip address add 192.168.123.123/24 dev ethx

[root@rhce1 ~]# ip link set dev ethx up

[root@rhce1 ~]# ip addr show ethx
9: ethx: <BROADCAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN qlen 1000
    link/ether 8e:db:6e:b9:3c:51 brd ff:ff:ff:ff:ff:ff
    inet 192.168.123.123/24 scope global ethx
       valid_lft forever preferred_lft forever
    inet6 fe80::8cdb:6eff:feb9:3c51/64 scope link
       valid_lft forever preferred_lft forever

[root@rhce1 ~]# ping -c 1 192.168.123.123
PING 192.168.123.123 (192.168.123.123) 56(84) bytes of data.
64 bytes from 192.168.123.123: icmp_seq=1 ttl=64 time=0.049 ms

--- 192.168.123.123 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.049/0.049/0.049/0.000 ms


--Before adding the route
root@mayura:/etc/sysconfig/network-scripts\> ping 192.168.123.123
PING 192.168.123.123 (192.168.123.123) 56(84) bytes of data.
^C
--- 192.168.123.123 ping statistics ---
4 packets transmitted, 0 received, 100% packet loss, time 2999ms

--Add the route
root@mayura:/etc/sysconfig/network-scripts\> ip route add 192.168.123.0/24 via 192.168.122.1 dev virbr0
or 
root@mayura:/etc/sysconfig/network-scripts\> ip route add 192.168.123.0/24 via 192.168.110.1 dev virbr1

root@mayura:/etc/sysconfig/network-scripts\> ip route show
default via 192.168.2.1 dev br_fe
default via 192.168.2.1 dev enp7s0  proto static  metric 100
192.168.2.0/24 dev br_fe  proto kernel  scope link  src 192.168.2.21
192.168.2.0/24 dev enp7s0  proto kernel  scope link  src 192.168.2.20  metric 100
192.168.110.0/24 dev virbr1  proto kernel  scope link  src 192.168.110.1
192.168.120.0/24 dev virbr2  proto kernel  scope link  src 192.168.120.1
192.168.122.0/24 dev virbr0  proto kernel  scope link  src 192.168.122.1
192.168.130.0/24 dev virbr3  proto kernel  scope link  src 192.168.130.1
192.168.123.0/24 via 192.168.122.1 dev virbr0

root@mayura:/etc/sysconfig/network-scripts\> ping 192.168.123.123
PING 192.168.123.123 (192.168.123.123) 56(84) bytes of data.
64 bytes from 192.168.123.123: icmp_seq=1 ttl=64 time=0.185 ms


--Two VM's ( modprobe dummy)

Add 192.168.145.100 on rhce2 and 192.168.150.100 on rhce3. What requires to have these two networks talk to each other?
The common nics on rhce2 and rhce3 are 192.168.122.20 and 192.168.122.30 

#rhce2
modprobe dummy
ip addr add 192.168.145.100 dev dummy0


#rhce3
modprobe dummy
ip addr add 192.168.150.100 dev dummy0


#On Mayura/Hypervisor
root@mayura:~\> ip route add 192.168.145.0/24 via 192.168.122.1
root@mayura:~\> ip route add 192.168.150.0/24 via 192.168.122.1

192.168.145.0/24 via 192.168.122.1 dev virbr0
192.168.150.0/24 via 192.168.122.1 dev virbr0

--Ensure ipv4_forward is enabled usually it is for virtalization
echo "1" > /proc/sys/net/ipv4/ip_forward

net.ipv4.ip_forward = 1 

--Overrun: Total number of receiver overruns resulting in dropped packets. THis means either kernel has issues or machine is too slow
for the interface. (-s -s => More verbose )

root@panchajanya:~\> ip addr show dev enp8s0
3: enp8s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master br_fe state UP qlen 1000
    link/ether 00:1f:bc:02:01:67 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::21f:bcff:fe02:167/64 scope link
       valid_lft forever preferred_lft forever
	  
	  
[root@lab19 ~]# ip -s -s -s link show dev eth0
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT qlen 1000
    link/ether 52:54:00:45:56:5e brd ff:ff:ff:ff:ff:ff
    RX: bytes  packets  errors  dropped overrun mcast
    320095     2785     0       0       0       0
    RX errors: length   crc     frame   fifo    missed
               0        0       0       0       0
    TX: bytes  packets  errors  dropped carrier collsns
    124242     1232     0       0       0       0
    TX errors: aborted  fifo   window heartbeat
               0        0       0       0

--Example of adding virtual host

[root@lab19 ~]# ip addr add 192.168.132.20/24 dev eth3 brd + scope global label eth3:1
[root@lab19 ~]# ip addr show dev eth3
5: eth3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:01:bd:9f brd ff:ff:ff:ff:ff:ff
    inet 192.168.132.19/24 brd 192.168.132.255 scope global eth3
       valid_lft forever preferred_lft forever
    inet 192.168.132.20/24 brd 192.168.132.255 scope global secondary eth3:1
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe01:bd9f/64 scope link
       valid_lft forever preferred_lft forever
	   
--Example of flushing IP addresses on multiple interfaces
ip addr flush label "eth*"
	   
-- Null Routes

-Option-1

[root@lab19 ~]# ping www.google.com
PING www.google.com (172.217.12.68) 56(84) bytes of data.
64 bytes from dfw28s05-in-f4.1e100.net (172.217.12.68): icmp_seq=1 ttl=53 time=20.9 ms

ip route add 216.58.218.142 via 127.0.0.1
or
[root@lab19 ~]# route add 172.217.12.68 gw 127.0.0.1 lo
[root@lab19 ~]# ip route show
default via 192.168.2.1 dev eth0  proto static  metric 100
172.217.12.68 via 127.0.0.1 dev lo  scope link

[root@lab19 ~]# ping 172.217.12.68 -c 1 -w 1
PING 172.217.12.68 (172.217.12.68) 56(84) bytes of data.

--- 172.217.12.68 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 999ms


-Option-2

[root@lab19 ~]# route add -host 172.217.12.68 reject
[root@lab19 ~]# ip route show
default via 192.168.2.1 dev eth0  proto static  metric 100
unreachable 172.217.12.68  scope host

-Option-3

[root@lab19 ~]# route add -net 17.217.12.0/24 gw 127.0.0.1 lo
[root@lab19 ~]# ip route get 17.217.12.0/24
17.217.12.0 dev lo  src 192.168.2.55
    cache <local>
[root@lab19 ~]# ip route show
default via 192.168.2.1 dev eth0  proto static  metric 100
17.217.12.0/24 via 127.0.0.1 dev lo  scope link

-Option-4 

ip route add unreachable 216.58.218.14

[root@lab19 ~]# ip route add blackhole 172.217.12.68

[root@lab19 ~]# ip route show
default via 192.168.2.1 dev eth0  proto static  metric 100
172.217.12.0/24 via 192.168.2.1 dev eth0
blackhole 172.217.12.68
192.168.2.0/24 dev eth0  proto kernel  scope link  src 192.168.2.55  metric 100


[root@lab19 ~]# ip route get 172.217.12.68
RTNETLINK answers: Network is unreachable
[root@lab19 ~]# ping 172.217.12.68 -c 1 -w 1
connect: Network is unreachable

--Sample net command
ip route add 17.217.12.0/24 via 192.168.2.0/24 dev eth0

--Add NAT
ip route add nat 192.168.132.19 via 192.168.134.19


-Route change example

[root@lab19 ~]# ip route add blackhole 172.217.12.68
[root@lab19 ~]# ip route show
default via 192.168.2.1 dev eth0  proto static  metric 100
blackhole 172.217.12.68

[root@lab19 ~]# ip route get 172.217.12.68
RTNETLINK answers: Network is unreachable

[root@lab19 ~]# ip route change 172.217.12.68 dev eth0
[root@lab19 ~]# ip route get 172.217.12.68
172.217.12.68 dev eth0  src 192.168.2.55
    cache
[root@lab19 ~]# ip route show
default via 192.168.2.1 dev eth0  proto static  metric 100
172.217.12.68 dev eth0  scope link


-Disable ZEROCONFI (169.254.0.0/16) - primarily used for autoconfiguration of routes.

root@panchajanya:~\> cat /etc/sysconfig/network
# Created by anaconda
NOZEROCONF=yes

Different mode of operations 

Round Robin - "mode=balance-rr"
Active Backup - "mode=active-backup"
XOR - "mode=balance-xor" ( Uses source and destination ethernet addresses to transfer network traffic)
Broadcast - "mode=broadcast"  ( Transmits network on all slaves)

=> Generate uuid's (if the interfaces dont' exist already)

uuidgen eth2 
uuidgen eth3 

=> Create bond0 file.

cd /etc/sysconfig/network-scripts
vi ifcfg-bond0
DEVICE=bond0
NAME=bond0
TYPE=bond
BONDING_MASTER=yes
BONDING_OPTS="mode=balance-rr"
ONBOOT=yes
BOOTPROTO=none
IPADDR=192.1

--Static Route to enable connection from VM2 to VM1 running on a different CIDR.

root@panchajanya:~\> ip route show
default via 192.168.2.1 dev br_fe
default via 192.168.2.1 dev enp7s0  proto static  metric 100
192.168.2.0/24 dev br_fe  proto kernel  scope link  src 192.168.2.11
192.168.2.0/24 dev enp7s0  proto kernel  scope link  src 192.168.2.10  metric 100
192.168.122.0/24 dev virbr0  proto kernel  scope link  src 192.168.122.1
192.168.125.0/24 dev virbr1  proto kernel  scope link  src 192.168.125.1
192.168.130.0/24 dev virbr2  proto kernel  scope link  src 192.168.130.1

[root@rhce5 ~]# nc -v team0.intercloudzone.com 7777 -w 1
Ncat: Version 7.50 ( https://nmap.org/ncat )
Ncat: Connection refused.

[root@rhce5 ~]# cat /etc/hosts
192.168.130.40	team0.intercloudzone.com
192.168.125.40	bond0.intercloudzone.com

ip route add 192.168.130.40 via 192.168.122.1 dev virbr0
ip route add 192.168.125.40 via 192.168.122.1 dev virbr0

 
</pre>

</div>


<div class="w3-container">
	<h1><span class="mw-headline" id="APACHE"> Apache </h1>	
<p>
 
</p>

<pre> 

[root@rhce4 conf.d]# httpd -t -D DUMP_VHOSTS
VirtualHost configuration:
192.168.125.40:6666    bond0.intercloudzone.com (/etc/httpd/conf.d/bond0.conf:1)
192.168.130.40:7777    team0.intercloudzone.com (/etc/httpd/conf.d/team0.conf:1)
*:443                  webserver.intercloudzone.com (/etc/httpd/conf.d/ssl.conf:56)
*:8888                 vhost1.intercloudzone.com (/etc/httpd/conf.d/vhost1.conf:1)

[root@rhce4 conf.d]# cat team0.conf
<VirtualHost 192.168.130.40:7777>
    ServerAdmin team0@webserver.intercloudzone.com
    DocumentRoot "/var/www/html/team0"
    ServerName team0.intercloudzone.com
    ErrorLog "/var/log/httpd/team0.error_log"
    CustomLog "/var/log/httpd/team0-access_log" common
</VirtualHost>

[root@rhce4 conf.d]# cat bond0.conf
<VirtualHost 192.168.125.40:6666>
    ServerAdmin bond0@webserver.intercloudzone.com
    DocumentRoot "/var/www/html/bond0"
    ServerName bond0.intercloudzone.com
    ErrorLog "/var/log/httpd/bond0.error_log"
    CustomLog "/var/log/httpd/bond0-access_log" common
</VirtualHost>


--Apache (IncludeOptional does not generate errors if path specified does not match any file.)

[root@rhce4 conf]# grep ^Include httpd.conf
Include conf.modules.d/*.conf
IncludeOptional conf.d/*.conf

--In Directory Container ( to allow explicit access)

Order Allow,Deny 
Allow from intercloudzone.com
Deny from all

--Directive to list the files/dirs if index.html is absent

Options Indexes FollowSymLinks

--Search selinux alerts

[root@rhce4 conf.d]# ausearch -m avc -c httpd
----
time->Fri Apr 20 19:42:26 2018
type=PROCTITLE msg=audit(1524271346.864:748): proctitle=2F7573722F7362696E2F6874747064002D44464F524547524F554E44
type=SYSCALL msg=audit(1524271346.864:748): arch=c000003e syscall=49 success=no exit=-13 a0=6 a1=563c8e71e7c0 a2=1c a3=7fff2ac8ad2c items=0 ppid=1 pid=9402 auid=4294967295 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=4294967295 comm="httpd" exe="/usr/sbin/httpd" subj=system_u:system_r:httpd_t:s0 key=(null)
type=AVC msg=audit(1524271346.864:748): avc:  denied  { name_bind } for  pid=9402 comm="httpd" src=8888 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:unreserved_port_t:s0 tclass=tcp_socket
----


--Apache Manual

elinks http://localhost/manual/vhosts

-- CGI Bin Setup.
semanage boolean -m httpd_can_sendmail --on or setsebool 

--Load CGI Scripts..

[root@rhce4 ~]# cat /var/www/app/email.sh
#!/bin/bash
echo -e "Content-type: text/html \n\n";
echo "<html>";
echo "<body>";
date | /usr/bin/mailx -s Test kuttu;
echo "Email has been sent";
echo "</body>";
echo "</html>";

type=AVC msg=audit(1524521548.542:560): avc:  denied  { read } for  pid=3224 comm="sendmail" path=2F746D702F527347797A764533202864656C6574656429 dev="dm-0" ino=6643073 scontext=system_u:system_r:system_mail_t:s0 tcontext=system_u:object_r:httpd_sys_rw_content_t:s0 tclass=file


semanage fcontext -a -s system_u -t httpd_sys_script_exec_t -r s0 "/var/www/app(/.*)?"
restorecon -vR /var/www/app
semanage boolean -m httpd_can_sendmail --on


[root@rhce4 ~]# ausearch -c 'sendmail' --raw | audit2allow -M my-sendmail
******************** IMPORTANT ***********************
To make this policy package active, execute:

semodule -i my-sendmail.pp

[root@rhce4 ~]# semodule -i my-sendmail.pp

--Enable home directorie - control file /etc/httpd/conf.d/userdir.conf


Either do chmod o+x /home/userdir or
setfacl -R -m u:apache:X  /home/devopsuser1
setfacl -R -m d:u:apache:X  /home/devopsuser1

curl -s http://webserver.intercloudzone.com/~devopsuser1/index.html

-INstall via group install

yum group info
yum group info "Basic Web Server"
yum group install "web-server"

-Check SSL Page via curl (download cacert)
[root@rhce5 ~]# curl -s --cacert cert.pem https://webserver.intercloudzone.com/index.html
This is an ssl/tls protected page

--Prevent access via firewalld
[root@rhce4 ~]# firewall-cmd --add-rich-rule 'rule family="ipv4" source address="192.168.0.0/16" service name=https reject'
success

--Limit Output from Apache
ServerTokens OS

--Available modules location and configured modules directory.
/usr/lib64/httpd/modules/
/etc/httpd/conf.modules.d/

[root@rhce4 ~]# grep modules /etc/httpd/conf/httpd.conf
# LoadModule foo_module modules/mod_foo.so
Include conf.modules.d/*.conf

--AllowOverride options to secure Apache files

<VirtualHost *:80>
    ServerAdmin webmaster@example.intercloudzone.com
    DocumentRoot "/var/www/html/example"
    ServerName example.intercloudzone.com
    ErrorLog "/var/log/httpd/example-host.example.com-error_log"
    CustomLog "/var/log/httpd/example-host.example.com-access_log" common
    <Directory "/var/www/html/example">
         AllowOverride AuthConfig
         AuthType Basic
         AuthName "Password Required"
         AuthUserFile /var/www/html/password.file
         AuthGroupFile /var/www/html/group.file
         Require group admins
    </Directory>
</VirtualHost>


-Enable home directories to execute CGI

in httpd.conf

<Directory "/home/*/public_html/cgi-bin">
        Options ExecCGI
        SetHandler cgi-script
</Directory>

[root@rhce4 conf.d]# ls -lZ /home/devopsuser1/public_html/cgi-bin/
-rwxr-xr-x+ devopsuser1 devopsuser1 unconfined_u:object_r:httpd_user_script_exec_t:s0 email.sh
-rwxr-xr-x+ devopsuser1 devopsuser1 unconfined_u:object_r:httpd_user_script_exec_t:s0 test.pl

[root@rhce4 conf.d]# curl -s http://webserver.intercloudzone.com/cgi-bin/test.pl
Hello


[root@rhce4 conf.d]# httpd -t -D DUMP_VHOSTS
VirtualHost configuration:
192.168.125.40:6666    bond0.intercloudzone.com (/etc/httpd/conf.d/bond0.conf:1)
192.168.130.40:7777    team0.intercloudzone.com (/etc/httpd/conf.d/team0.conf:1)
*:443                  webserver.intercloudzone.com (/etc/httpd/conf.d/ssl.conf:56)
*:8888                 vhost1.intercloudzone.com (/etc/httpd/conf.d/vhost1.conf:1)

[root@rhce4 conf.d]# cat team0.conf
<VirtualHost 192.168.130.40:7777>
    ServerAdmin team0@webserver.intercloudzone.com
    DocumentRoot "/var/www/html/team0"
    ServerName team0.intercloudzone.com
    ErrorLog "/var/log/httpd/team0.error_log"
    CustomLog "/var/log/httpd/team0-access_log" common
</VirtualHost>

[root@rhce4 conf.d]# cat bond0.conf
<VirtualHost 192.168.125.40:6666>
    ServerAdmin bond0@webserver.intercloudzone.com
    DocumentRoot "/var/www/html/bond0"
    ServerName bond0.intercloudzone.com
    ErrorLog "/var/log/httpd/bond0.error_log"
    CustomLog "/var/log/httpd/bond0-access_log" common
</VirtualHost>
 
--Secure reload failure

==> /var/log/httpd/big-error.log <==
[Mon May 14 16:02:49.594562 2018] [ssl:emerg] [pid 11019] AH01910: Oops, no RSA, DSA or ECC server certificate found for 'big.intercloudzone.com:0'?!

** ENusre the ServerName directive contains the port number.

 ServerName big.intercloudzone.com:443

</pre>

</div>


<div class="w3-container">
  <h1><span class="mw-headline" id="MARIADB"> MariaDB </h1>
<p>

</p>


<pre> 

MariaDB Configurations are stored in /etc/my.conf

bind-address 

--Securing MySQL Installation

[root@rhce1 ~]# mysql_secure_installation

NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!

In order to log into MariaDB to secure it, we'll need the current
password for the root user.  If you've just installed MariaDB, and
you haven't set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none):
ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: YES)

--Work-around for the above..

#Start on safe mode
[root@rhce1 ~]# mysqld_safe --skip-grant-tables
180409 09:28:51 mysqld_safe Logging to '/var/log/mariadb/mariadb.log'.


#Login as root and switch to mysql database.

[root@rhce1 ~]# mysql -u root
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 1
Server version: 5.5.56-MariaDB MariaDB Server

Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> use mysql

# Update the password, flush and quit.
MariaDB [mysql]> update user set password=password('oracle') where user='root';
flush privileges;
quit

systemctl restart mariadb

--Dict tables
show variables
use information_schema; show tables;
select @@version;

--Backup & restore
mysqldump --databases rhce -u root -p  > /tmp/rhce.sql

--Allow root/remote login
grant all privileges on *.* to 'root'@'192.168.%.%' identified by 'oracle' with grant option;

--Change password
set password for 'kuttu'@'localhost' = password('oracle');

flush privileges

-There are sample configurations at  /usr/share/mysql/my-small.cnf

</pre>

</div>


<div class="w3-container">
  <h1><span class="mw-headline" id="ISCSI"> ISCSI </h1>
<p>

</p>

<pre> 
--Create block device
/backstores/block> create iscsidisk1 dev=/dev/vdb 

--While mounting add _netdev. Example..
UUID=84c298ec-139a-4a4b-8869-ec7af8615ca2 /tmp/iscsimnt                   xfs     _netdev        0 0

--iscsi wwn = Word Wide Name


--Create IQN, TPG, LUN.

/iscsi> create iqn.2018-01.com.intercloudzone:iscsidisk1
Created target iqn.2018-01.com.intercloudzone:iscsidisk1.
Created TPG 1.

Global pref auto_add_default_portal=true
Created default portal listening on all IPs (0.0.0.0), port 3260.
/iscsi> ls
o- iscsi ..................................................[Targets: 1]
  o- iqn.2018-01.com.intercloudzone:iscsidisk1 ...............[TPGs: 1]
    o- tpg1 .....................................[no-gen-acls, no-auth]
      o- acls ................................................[ACLs: 0]
      o- luns ................................................[LUNs: 0]
      o- portals ..........................................[Portals: 1]
        o- 0.0.0.0:3260 ...........................................[OK]
/iscsi>

/iscsi/iqn.20.../tpg1/portals> create 192.168.122.10
Using default IP port 3260
Could not create NetworkPortal in configFS

/iscsi/iqn.20.../tpg1/portals> ls
o- portals ................................................[Portals: 1]
  o- 0.0.0.0:3260 .................................................[OK]
/iscsi/iqn.20.../tpg1/portals> delete 0.0.0.0 ip_port=3260
Deleted network portal 0.0.0.0:3260

/iscsi/iqn.20.../tpg1/portals> create 192.168.122.10
Using default IP port 3260
Created network portal 192.168.122.10:3260.

/iscsi/iqn.20...sk1/tpg1/luns> create /backstores/block/iscsidisk1
Created LUN 0.

--Create ACL using the initiator name on the client.

[root@rhce2 ~]# cat /etc/iscsi/initiatorname.iscsi
InitiatorName=iqn.1994-05.com.redhat:ab5f22d09eca


/iscsi/iqn.20...sk1/tpg1/acls> create iqn.1994-05.com.redhat:ab5f22d09eca
Created Node ACL for iqn.1994-05.com.redhat:ab5f22d09eca
Created mapped LUN 1.
Created mapped LUN 0.


--Discover targets
[root@rhce2 ~]# iscsiadm --mode discovery --type sendtargets --portal 192.168.122.10
192.168.122.10:3260,1 iqn.2018-01.com.intercloudzone:iscsidisk1

--Try to login
[root@rhce2 ~]# iscsiadm -m node -T iqn.2018-01.com.intercloudzone:iscsidisk1 -l
Logging in to [iface: default, target: iqn.2018-01.com.intercloudzone:iscsidisk1, portal: 192.168.122.10,3260] (multiple)
Login to [iface: default, target: iqn.2018-01.com.intercloudzone:iscsidisk1, portal: 192.168.122.10,3260] successful.

-Check sessions
[root@rhce2 ~]# iscsiadm -m session -P 0
tcp: [1] 192.168.122.10:3260,1 iqn.2018-01.com.intercloudzone:iscsidisk1 (non-flash)

--Check the devices ()
[root@rhce2 ~]# lsblk --scsi
NAME HCTL       TYPE VENDOR   MODEL             REV TRAN
sda  2:0:0:0    disk LIO-ORG  iscsidisk1       4.0  iscsi
sdb  2:0:0:1    disk LIO-ORG  testfile         4.0  iscsi


[root@rhce5 /]# ls -l /dev/disk/by-path/
total 0
lrwxrwxrwx. 1 root root  9 May 17 13:00 ip-192.168.122.40:3260-iscsi-iqn.2015-01.com.example:server1-disk1-lun-0 -> ../../sdb

--Logout 

[root@rhce2 ~]# iscsiadm -m node -u
Logging out of session [sid: 1, target: iqn.2018-01.com.intercloudzone:iscsidisk1, portal: 192.168.122.10,3260]
Logout of [sid: 1, target: iqn.2018-01.com.intercloudzone:iscsidisk1, portal: 192.168.122.10,3260] successful.
[root@rhce2 ~]# lsblk --scsi
[root@rhce2 ~]# iscsiadm -m session -P 0
iscsiadm: No active sessions.

--Example of mapping lun afterwards
/iscsi/iqn.20...ce4-disk1-acl> create mapped_lun=0 tpg_lun_or_backstore=/backstores/block/disk1
Created Mapped LUN 0.

--Create a write-protected LUN (under ACL) 

/iscsi/iqn.20...ce4-disk1-acl> create mapped_lun=1 tpg_lun_or_backstore=/backstores/fileio/file1 write_protect=1
Created Mapped LUN 1.
/iscsi/iqn.20...ce4-disk1-acl> ls
o- iqn.2018-04.com.intercloudzone:rhce4-disk1-acl ....[Mapped LUNs: 2]
  o- mapped_lun0 ..............................[lun0 block/disk1 (rw)]
  o- mapped_lun1 .............................[lun1 fileio/file1 (ro)


--Cleanup nodes if things go wrong

[root@rhce3 ~]# lsblk --scsi
NAME HCTL       TYPE VENDOR   MODEL             REV TRAN
sda  18:0:0:0   disk LIO-ORG  san0             4.0  iscsi
sdb  17:0:0:0   disk LIO-ORG  iscsidisk1       4.0  iscsi
sdc  18:0:0:1   disk LIO-ORG  san1             4.0  iscsi
sdd  17:0:0:1   disk LIO-ORG  testfile         4.0  iscsi


[root@rhce3 ~]# ls -lr /var/lib/iscsi/nodes/
total 0
drw-------. 3 root root 35 Jan 26 12:15 iqn.2018-01.local.rhce.ipa:target
drw-------. 3 root root 35 Jan 26 12:15 iqn.2018-01.com.intercloudzone:iscsidisk1

[root@rhce3 ~]# iscsiadm -m node -T iqn.2018-01.local.rhce.ipa:target -p 192.168.122.10 --logout
Logging out of session [sid: 17, target: iqn.2018-01.local.rhce.ipa:target, portal: 192.168.122.10,3260]
Logout of [sid: 17, target: iqn.2018-01.local.rhce.ipa:target, portal: 192.168.122.10,3260] successful.
[root@rhce3 ~]# iscsiadm -m node -T iqn.2018-01.local.rhce.ipa:target -p 192.168.122.10 -o delete

[root@rhce3 ~]# lsblk --scsi
NAME HCTL       TYPE VENDOR   MODEL             REV TRAN
sdb  17:0:0:0   disk LIO-ORG  iscsidisk1       4.0  iscsi
sdd  17:0:0:1   disk LIO-ORG  testfile         4.0  iscsi

[root@rhce3 ~]# blkid  |grep sdb
/dev/sdb: UUID="2ef58790-64b7-4723-8e04-daa05b040127" TYPE="xfs"


/iscsi/iqn.20...:c3e0e869a66f> set auth userid=client password=client
Parameter password is now 'client'.
Parameter userid is now 'client'.

Note: The device names may vary during reboots, so only the UUID's should be used to mount with _netdev option.
#UUID="4ee8aecb-de46-4d29-9858-811be645a195"     /test ext3     _netdev         0 0

--DIscover (-D should be passed in case of discoverydb mode)
[root@rhce5 doc]# iscsiadm -m discoverydb -t sendtargets -p rhce4.intercloudzone.com -D
192.168.122.40:3260,1 iqn.2018-04.com.intercloudzone:rhce4-disk1

</pre>

</div>


<div class="w3-container">
  <h1><span class="mw-headline" id="LVM"> LVM </h1>
<p>

</p>

<pre>
-How to remove stale volume group entries..
[root@rhce1 ~]# pvscan
  /dev/vgsan/lvsan0: read failed after 0 of 4096 at 0: Input/output error
  /dev/vgsan/lvsan0: read failed after 0 of 4096 at 1073676288: Input/output error
  /dev/vgsan/lvsan0: read failed after 0 of 4096 at 1073733632: Input/output e


[root@rhce1 ~]# dmsetup remove vgsan-lvsan1 -f
[root@rhce1 ~]# dmsetup remove vgsan-lvsan0 -f
[root@rhce1 ~]# dmsetup ls
vgos-home (253:4)
vgos-swap (253:1)
vgos-root (253:0)


[root@server ~]# e2label /dev/mapper/vg01-lvol1
teste2
[root@server ~]# mount LABEL=teste2 /mnt/
[root@server ~]# findmnt -t ext4
TARGET SOURCE                 FSTYPE OPTIONS
/mnt   /dev/mapper/vg01-lvol1 ext4   rw,relatime,seclabel,data=ordered


[root@server ~]# dumpe2fs /dev/mapper/vg01-lvol1 |grep superblock
dumpe2fs 1.42.9 (28-Dec-2013)
  Primary superblock at 1, Group descriptors at 2-3
  Backup superblock at 8193, Group descriptors at 8194-8195
  Backup superblock at 24577, Group descriptors at 24578-24579
  Backup superblock at 40961, Group descriptors at 40962-40963
  Backup superblock at 57345, Group descriptors at 57346-57347
  Backup superblock at 73729, Group descriptors at 73730-73731
  Backup superblock at 204801, Group descriptors at 204802-204803


[root@server ~]# fsck -b 8193 /dev/mapper/vg01-lvol1
fsck from util-linux 2.23.2
e2fsck 1.42.9 (28-Dec-2013)
teste2 was not cleanly unmounted, check forced.
Pass 1: Checking inodes, blocks, and sizes
Pass 2: Checking directory structure
Pass 3: Checking directory connectivity
Pass 4: Checking reference counts
Pass 5: Checking group summary information

teste2: ***** FILE SYSTEM WAS MODIFIED *****
teste2: 11/53248 files (0.0% non-contiguous), 12632/212992 blocks


#Error

[root@server ~]# pvcreate /dev/vdd
  WARNING: Device for PV xdVv91-0Gfz-uzSs-1pzu-CDVQ-34Pm-PwsGBd not found or rejected by a filter.
  Device /dev/vdd not found (or ignored by filtering).


[root@server ~]# uuidgen
c534079b-103f-45ab-9252-839684568fd6


[root@server ~]# tune2fs /dev/vdd -U c534079b-103f-45ab-9252-839684568fd6
tune2fs 1.42.9 (28-Dec-2013)
tune2fs: Bad magic number in super-block while trying to open /dev/vdd
Couldn't find valid filesystem superblock.

[root@server ~]# dumpe2fs /dev/vdd
dumpe2fs 1.42.9 (28-Dec-2013)
dumpe2fs: Bad magic number in super-block while trying to open /dev/vdd
Couldn't find valid filesystem superblock.

[root@server ~]# fsck -b 98304 /dev/vdd
fsck from util-linux 2.23.2
e2fsck 1.42.9 (28-Dec-2013)
fsck.ext2: Invalid argument while trying to open /dev/vdd

The superblock could not be read or does not describe a correct ext2
filesystem.  If the device is valid and it really contains an ext2
filesystem (and not swap or ufs or something else), then the superblock
is corrupt, and you might try running e2fsck with an alternate superblock:
    e2fsck -b 8193 <device>

#Last ditch effort of recreating ONLY superblocks

[root@server ~]# mke2fs -S /dev/vdd -t ext4
mke2fs 1.42.9 (28-Dec-2013)
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
196608 inodes, 786432 blocks
39321 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=805306368
24 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
  32768, 98304, 163840, 229376, 294912

Allocating group tables: done
Skipping journal creation in super-only mode
Writing superblocks and filesystem accounting information: done

Run e2fsck immediately..

root@server ~]# e2fsck /dev/vdd

#Display devices ..
[root@server ~]# lvs -a -o +devices
  WARNING: Device for PV xdVv91-0Gfz-uzSs-1pzu-CDVQ-34Pm-PwsGBd not found or rejected by a filter.
  LV     VG   Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Devices
  lvol0  vg01 -wi-a----- 208.00m                                                     /dev/vde(0)

 
#Another utility
debugfs

[root@server ~]# vgs -a -o +pv_name
  VG   #PV #LV #SN Attr   VSize VFree   PV
  vg01   2   3   0 wz--n- 3.97g   3.36g /dev/vde
  vg01   2   3   0 wz--n- 3.97g   3.36g /dev/vdc1
  vgos   1   2   0 wz--n- 9.76g 996.00m /dev/vda2

[root@server ~]# vgreduce vg01 --removemissing --force
  WARNING: Device for PV xdVv91-0Gfz-uzSs-1pzu-CDVQ-34Pm-PwsGBd not found or rejected by a filter.
  WARNING: Device for PV xdVv91-0Gfz-uzSs-1pzu-CDVQ-34Pm-PwsGBd not found or rejected by a filter.
  Wrote out consistent volume group vg01

 [root@server ~]# pvcreate /dev/vdd
  Physical volume "/dev/vdd" successfully created

-Parted Free block list
parted unit MB print free

-LVM Info.
[root@rhce4 ~]# dmsetup info -C
Name             Maj Min Stat Open Targ Event  UUID
vgos-home        253   2 L--w    1    1      0 LVM-f1f8CpRwz610Z0djw9dOwwwdD1SpQyVKAcHyMlbAi8IJ6He9JQSLl47i3YyyfMN4
vgos-swap        253   1 L--w    2    1      0 LVM-f1f8CpRwz610Z0djw9dOwwwdD1SpQyVKuREdxh9vrSecNuQc0JEurmw6KM9Tt8W7
vgos-root        253   0 L--w    1    1      0 LVM-f1f8CpRwz610Z0djw9dOwwwdD1SpQyVKoyRvRaGTZIMRrz3Hv6kCW4w3PHYAL4pI


-Volume Group missing in /dev/mapper

[root@server ~]# vgscan --mknodes -v
    Wiping cache of LVM-capable devices
    Wiping internal VG cache
  Reading all physical volumes.  This may take a while...
    Using volume group(s) on command line.
  Found volume group "vgdata0" using metadata type lvm2
  Found volume group "vg01" using metadata type lvm2
  Found volume group "vgos" using metadata type lvm2
    Using logical volume(s) on command line.
    Found same device /dev/vdd with same pvid ywDFI8P7iwtvcxw9mE6lcsbC1Wcf38b4
    Found same device /dev/vdc1 with same pvid BqF5eyDAnfn9jWVlYovW21KaYZZJx913
    Found same device /dev/vda2 with same pvid WJJmyni5cuaquhl8FJbyRgQecm2MNcoe

</pre>

</div>


<div class="w3-container">
  <h1><span class="mw-headline" id="NFS"> NFS </h1> 
<p>
 


</p>

<pre> 

--install
yum install nfs-utils
systemctl enable rpcbind nfs nfs-server
selinux
firewall
/etc/fstab ( _netdev)

--Syntax
export host1(options1) host2(options2) host3(options3)

--Mounted directories in /var/lib/nfs/etab

--Defaults
ro,sync,wdelay,root_squash (Squashes power of root)

--all_squash  
To squash every remote user (including root), use all_squash. To specify the user and group IDs that the NFS server should assign to remote
 users from a particular host, use the anonuid and anongid options, respectively, as in:
export host(anonuid=uid,anongid=gid)

-When you are creating a public share will all_squashed, change hte user/group ownership to nfsnobody.
chown nfsnobody:nfsnobody /srv/nfs_pub

--syntax
/home bob.example.com(rw) 
/home bob.example.com (rw)

The first line allows only users from bob.example.com read/write access to the /home directory. The second line allows users from bob.example.com to mount the directory as read-only (the default), while the rest of the world can mount it read/write.

--rpcbind
NFS requires rpcbind, which dynamically assigns ports for RPC services and can cause problems for configuring firewall rules. To allow clients to access NFS shares behind a firewall, edit the /etc/sysconfig/nfs file to set which ports the RPC services run on

--Mounts listed
cat /var/lib/nfs/etab (server) and /etc/mtab (on client)

--NFS configuration
/etc/sysconfig/nfs

--Firewall
firewall-cmd add-service nfs --add-service mountd --add-service rpc-bind

--Check from client
showmount -e rhce1

--SElinux
getsebool -a | egrep '^nfs|^use_nfs'

Any directory/file to be exported on the network should have public_content_ro_t or public_content_rw_t applied if multiple services
like FTP, HTTP etc share the same along with NFS.

--nfs-secure-server (Kerberos)
systemctl start kadmin krb5kdc

kadmin:  addprinc -randkey nfs/rhce1.intercloudzone.com
WARNING: no policy specified for nfs/rhce1.intercloudzone.com@INTERCLOUDZONE.COM; defaulting to no policy
Principal "nfs/rhce1.intercloudzone.com@INTERCLOUDZONE.COM" created.

kadmin:  addprinc -randkey nfs/rhce2.intercloudzone.com
WARNING: no policy specified for nfs/rhce2.intercloudzone.com@INTERCLOUDZONE.COM; defaulting to no policy
Principal "nfs/rhce2.intercloudzone.com@INTERCLOUDZONE.COM" created.

[root@rhce1 ~]# systemctl enable nfs-secure
[root@rhce1 ~]# systemctl start nfs-secure


-rw-------. 1 root root 2258 Jan 19 13:10 /etc/krb5.keytab
[root@rhce2 ~]# kadmin
Authenticating as principal root/admin@INTERCLOUDZONE.COM with password.
Password for root/admin@INTERCLOUDZONE.COM:
kadmin:  ktadd nfs/rhce1.intercloudzone.com
Entry for principal nfs/rhce1.intercloudzone.com with kvno 2, encryption type aes256-cts-hmac-sha1-96 added to keytab FILE:/etc/krb5.keytab
..
...
Entry for principal nfs/rhce1.intercloudzone.com with kvno 2, encryption type des-cbc-md5 added to keytab FILE:/etc/krb5.keytab.
kadmin:  quit
[root@rhce2 ~]# ls -ltr /etc/krb5.keytab
-rw-------. 1 root root 3002 Feb  1 17:02 /etc/krb5.keytab

--Check the client for mounted directories
[root@rhce2 ~]# showmount -e rhce1
Export list for rhce1:
/nfskrb5  rhce2.intercloudzone.com
/nfsdata  rhce2.intercloudzone.com
/nfsrhcsa rhce3.intercloudzone.com
/common   rhce2.intercloudzone.com

--
[root@rhce2 ~]# rpcinfo -p rhce1.intercloudzone.com


root@rhce5 ~]# cd -
/etc/auto.master.d

[root@rhce5 auto.master.d]# ls -ltr
total 8
-rw-r--r--. 1 root root 39 May  7 22:31 tools.autofs
-rw-r--r--. 1 root root 41 May  7 22:31 autofs.tools

[root@rhce5 auto.master.d]# cat tools.autofs
/tools /etc/auto.master.d/autofs.tools

[root@rhce5 auto.master.d]# cat autofs.tools
tsubdir server.intercloudzone.com:/tools

[root@rhce5 auto.master.d]# ls -ltr /tools/tsubdir/
total 0
-rw-r--r--. 1 root root 0 May  7 22:31 afile


[root@rhce5 auto.master.d]# /etc/auto.net rhce4.intercloudzone.com -fstype=nfs
-fstype=nfs,hard,intr,nodev,nosuid \
  /home rhce4.intercloudzone.com:/home \
  /shared rhce4.intercloudzone.com:/shared \
  /tools rhce4.intercloudzone.com:/tools

[root@rhce5 auto.master.d]# cd /net/

[root@rhce5 net]# ls -l
total 0

[root@rhce5 net]# cd rhce4.intercloudzone.com

[root@rhce5 rhce4.intercloudzone.com]# ls -lr
total 0
drwxr-xr-x. 2 root root 0 May  7 22:33 tools
drwxr-xr-x. 2 root root 0 May  7 22:33 shared
drwxr-xr-x. 2 root root 0 May  7 22:33 home

   [root@rhce2 ~]# /etc/auto.net rhce1.intercloudzone.com -fstype=nfs /nfsdata
-fstype=nfs,hard,intr,nodev,nosuid \
  /common rhce1.intercloudzone.com:/common \
  /nfsdata rhce1.intercloudzone.com:/nfsdata \
  /nfskrb5 rhce1.intercloudzone.com:/nfskrb5 \
  /nfsrhcsa rhce1.intercloudzone.com:/nfsrhcsa

</pre>

</div>


<div class="w3-container">
  <h1><span class="mw-headline" id="BOOT"> Boot </h1>
<p>

</p>


<pre> 

--Resuce mode
Mount the DVD, boot - choose the resuce media

chroot /mnt/sysimage
grub2-install /dev/vda
yum reinstall grub2-tools
grub2-mkconfig -o /boot/grub2/grub.cfg
or 
grub2-mkconfig -o /boot/grub2/efi/EFI/redhat/grub.cfg


--Boot into rescue mode
init=/sysroot/bin/sh or systemd-unit=rd.break, or rd.break
chroot /sysroot
mout -o remount,rw /
touch /.autorelabel


 [root@rhce boot]# systemctl --help |grep default
  get-default                     Get the name of the default target
  set-default NAME                Set the default target
  default                         Enter system default mode

[root@rhce boot]# systemctl get-default
multi-user.target

[root@rhce boot]# systemctl set-default rescue.target
Removed symlink /etc/systemd/system/default.target.
Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/rescue.target.

[root@rhce boot]# ls -ltr /etc/systemd/system/default.target
lrwxrwxrwx. 1 root root 37 Jul 18 12:47 /etc/systemd/system/default.target -> /usr/lib/systemd/system/rescue.target

[root@rhce ~]# systemctl set-default multi-user.target
Removed symlink /etc/systemd/system/default.target.
Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/multi-user.target.


Default is controlled by 
[root@rhce grub2]# grep GRUB_DEFAULT /etc/default/grub
GRUB_DEFAULT=saved

Since it's saved - the detail will be in /boot/grub2/grubenv 

This can be seen as 
[root@rhce grub2]# grub2-editenv list
saved_entry=CentOS Linux (3.10.0-514.26.2.el7.x86_64) 7 (Core)

[root@rhce grub2]# grep "^menuentry" /boot/grub2/grub.cfg | cut -d "'" -f2
CentOS Linux (3.10.0-514.26.2.el7.x86_64) 7 (Core)
CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)
CentOS Linux (0-rescue-d458f1266e944ac49077920032339122) 7 (Core)


[root@rhce grub2]# grub2-set-default 0
[root@rhce grub2]# grub2-editenv list
saved_entry=0


-- Boot-time parameters.

[root@lab125a sysctl.d]# cat /proc/cmdline
BOOT_IMAGE=/vmlinuz-3.10.0-327.el7.x86_64 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet LANG=en_US.UTF-8


[root@lab125a ~]# grep CMD /etc/default/grub
GRUB_CMDLINE_LINUX="crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet console=tty0 console=ttyS0 console=ttyS0,115200"
grub2-mkconfig -o /boot/grub2/grub.cfg

[root@lab130a ~]# grep linux16 /boot/grub2/grub.cfg
  linux16 /vmlinuz-3.10.0-327.el7.x86_64 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet LANG=en_US.UTF-8
  linux16 /vmlinuz-0-rescue-6e490d5089bd459881a69cee25bb2294 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet


[root@lab130a ~]# grubby --update-kernel /boot/vmlinuz-3.10.0-327.el7.x86_64 --args="console=tty0,ttyS0,115200"
[root@lab130a ~]# grep linux16 /boot/grub2/grub.cfg
  linux16 /vmlinuz-3.10.0-327.el7.x86_64 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet LANG=en_US.UTF-8 console=tty0 console=ttyS0 console=ttyS0,115200
  linux16 /vmlinuz-0-rescue-6e490d5089bd459881

-- initramfs missing
https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/sec-verifying_the_initial_ram_disk_image

dracut "initramfs-$(uname -r).img" $(uname -r)

-- vmlinuz missing
Boot into rescue mode
chroot /mnt/sysimage
mount /dev/cdrom /tmp/mnt 
cp /tmp/mnt/isolinux/vmlinuz /boot/vmlinuz-$(uname -r) or grub2-install /dev/vda1 --skip-fs-probe --force -v
cd /boot ; dracut initramfs-$(uname -r).img $(uname -r)


--Configure virtual terminals
/etc/systemd/logind.conf


--Restore LVM
https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/logical_volume_manager_administration/mdatarecover

--if rd.break or init=/sysroot/bin/sh isn't working.

rd.break console=tty1 or rd.break console=tty0 (or ttyS0) or enforcing=0

Refer Page 255 for (insmod lvm, contd.)



</pre>

</div>

<div class="w3-container">
  <h1><span class="mw-headline" id="VIRTUALIZATION"> Virtualization </h1>
  
<p>

</p>

  
<pre> 


=> Refere xpath 

yum provides xpath
yum install perl-XML-XPath

root@panchajanya:~\> cat server.xml | xpath domain/devices/interface
Found 4 nodes:
-- NODE --
<interface type="bridge">
      <mac address="52:54:00:2c:19:87" />
      <source bridge="br_fe" />
      <target dev="vnet0" />
      <model type="virtio" />
      <alias name="net0" />
      <address type="pci" domain="0x0000" bus="0x00" slot="0x03" function="0x0" />
    </interface>-- NODE --
<interface type="network">
      <mac address="52:54:00:4b:a2:98" />
      <source network="vnetnat" bridge="vbrnat" />
      <target dev="vnet1" />
      <model type="virtio" />
      <alias name="net1" />
      <address type="pci" domain="0x0000" bus="0x00" slot="0x04" function="0x0" />
    </interface>-- NODE --
<interface type="network">
      <mac address="52:54:00:f1:15:ef" />
      <source network="vnetrou" bridge="vbrrou" />
      <target dev="vnet2" />
      <model type="virtio" />
      <alias name="net2" />
      <address type="pci" domain="0x0000" bus="0x00" slot="0x05" function="0x0" />
    </interface>-- NODE --
<interface type="network">
      <mac address="52:54:00:82:2f:44" />
      <source network="vnetnat" bridge="vbrnat" />
      <target dev="vnet3" />
      <model type="virtio" />
      <alias name="net3" />
      <address type="pci" domain="0x0000" bus="0x00" slot="0x10" function="0x0" />
    </interface>

=> Found from anywhere in doc

root@panchajanya:~\> xpath server.xml //interface
Found 4 nodes:

=> FInd attributes
xpath server.xml //@type


virsh # net-list
 Name                 State      Autostart     Persistent
----------------------------------------------------------
 default              active     yes           yes
 virnet1              active     yes           yes
 virnet2              active     yes           yes
 vnetiso              active     yes           yes
 vnetnat              active     yes           yes
 vnetrou              active     yes           yes

virsh # domiflist server
Interface  Type       Source     Model       MAC
-------------------------------------------------------
vnet0      bridge     br_fe      virtio      52:54:00:2c:19:87
vnet1      network    vnetnat    virtio      52:54:00:4b:a2:98
vnet2      network    vnetrou    virtio      52:54:00:f1:15:ef
vnet3      network    vnetnat    virtio      52:54:00:82:2f:44




=> Supersedes all notes on detach/attach interfaces and recreate the iface files.



virsh # detach-interface --domain server --type network --mac '52:54:00:82:2f:44' --persistent --live
Interface detached successfully

virsh # attach-interface --domain server --type network --source vnetnat --mac '52:54:00:82:2f:44' --model virtio --persistent --live
Interface attached successfully


[root@server network-scripts]# nmcli con delete a9dac657-c4ff-4296-a570-65bf15e54da8

[root@server network-scripts]# nmcli dev connect eth3
Device 'eth3' successfully activated with '19abec3c-668d-4e4a-865c-a49b4a767138'.

=> Create interface file with the below

[root@server network-scripts]# nmcli con add type ethernet con-name eth3 ifname eth3
Connection 'eth3' (d9dc89bc-3cf1-467a-9907-f05ccb7f927b) successfully added.


=> Bonding

[root@server network-scripts]# nmcli con add type bond ifname bond0 bond.options "mode=balance-rr"
Connection 'bond-bond0' (a31cd78a-a51c-43a9-9ba5-4fb4b0e976ae) successfully added.


[root@server network-scripts]# nmcli con add type ethernet ifname eth3 master bond0
Connection 'bond-slave-eth3' (4d2aa71a-b338-4af4-b447-4543fe49bbf6) successfully added.

[root@server network-scripts]# nmcli con add type ethernet ifname eth1 master bond0
Connection 'bond-slave-eth1' (ecc5ac47-7785-4b94-b2ce-5a85f15fa153) successfully added.


=> Reboot

[root@server ~]# nmcli con show
NAME             UUID                                  TYPE            DEVICE
System eth0      b6870dc4-b183-4bdd-b310-6d789c3e9ce0  802-3-ethernet  eth0
System eth2      260c99eb-2a00-44b5-a3d6-e731d936a3b4  802-3-ethernet  eth2
bond-bond0       a31cd78a-a51c-43a9-9ba5-4fb4b0e976ae  bond            bond0
bond-slave-eth1  ecc5ac47-7785-4b94-b2ce-5a85f15fa153  802-3-ethernet  eth1
bond-slave-eth3  4d2aa71a-b338-4af4-b447-4543fe49bbf6  802-3-ethernet  eth3

3: eth1: <BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master bond0 state UP qlen 1000
    link/ether 52:54:00:4b:a2:98 brd ff:ff:ff:ff:ff:ff

5: eth3: <BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master bond0 state UP qlen 1000
    link/ether 52:54:00:4b:a2:98 brd ff:ff:ff:ff:ff:ff

6: bond0: <BROADCAST,MULTICAST,MASTER,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP
    link/ether 52:54:00:4b:a2:98 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.179/24 brd 192.168.134.255 scope global dynamic bond0
       valid_lft 2722sec preferred_lft 2722sec
    inet6 fe80::5054:ff:fe4b:a298/64 scope link tentative dadfailed
       valid_lft forever preferred_lft forever



=> Change IP address to static 

[root@server network-scripts]# nmcli con edit bond-bond0

===| nmcli interactive connection editor |===

Editing existing 'bond' connection: 'bond-bond0'

Type 'help' or '?' for available commands.
Type 'describe [<setting>.<prop>]' for detailed property description.

You may edit the following settings: connection, bond, 802-3-ethernet (ethernet), ipv4, ipv6
nmcli> print ipv4
['ipv4' setting values]
ipv4.method:                            auto

....

root@panchajanya:~\> virsh net-update vnetnat add ip-dhcp-host '<host mac="52:54:00:4b:a2:98" ip="192.168.134.52" />'
Updated network vnetnat live state

nmcli> set ipv4.address 192.168.134.52/24,ipv4.method manual
Do you also want to set 'ipv4.method' to 'manual'? [yes]: yes

nmcli> save
Connection 'bond-bond0' (a31cd78a-a51c-43a9-9ba5-4fb4b0e976ae) successfully updated.



=> Out of context command: dhclient

[root@server network-scripts]# dhclient -v -r eth0
Internet Systems Consortium DHCP Client 4.2.5
Copyright 2004-2013 Internet Systems Consortium.
All rights reserved.
For info, please visit https://www.isc.org/software/dhcp/

Listening on LPF/eth0/52:54:00:2c:19:87
Sending on   LPF/eth0/52:54:00:2c:19:87
Sending on   Socket/fallback


=> Modifying bond options


[root@server network-scripts]# nmcli dev mod bond0 +bond.options mii=100
Connection successfully reapplied to device 'bond0'

[root@server network-scripts]# nmcli dev mod bond0 +bond.options "mode=balance=rr,mii=100"
Error: failed to modify bond.options: 'balance=rr' not among [balance-rr, active-backup, balance-xor, broadcast, 802.3ad, balance-tlb, balance-alb].

[root@server network-scripts]# nmcli dev mod bond0 +bond.options "mode=balance-rr,mii=100"
Connection successfully reapplied to device 'bond0'.



=> Edited via nmtui 


[root@server network-scripts]# nmcli con mod bond-bond0 +bond.options "mode=active-backup"
 
[root@server network-scripts]# grep OPTS ifcfg-bond-bond0
BONDING_OPTS=mode=active-backup

nmcli con load /etc/sysconfig/network-scripts/ifcfg-bond-bond0


[root@server network-scripts]# cat /sys/class/net/bonding_masters
bond0

=> To dynamically change the bonding parameters..
 cd /sys/class/net/bond0/bonding/
 echo 1000 > /sys/class/net/bond0/bonding/miimon


==Channel Bonding

virsh # attach-interface --domain server --type network --source vnetnat --model virtio --persistent --live
Interface attached successfully

virsh # attach-interface --domain server --type network --source vnetnat --model virtio --persistent --live
Interface attached successfully

=> Total number of macs now

root@panchajanya:~\> virsh dumpxml server | xpath "count(//interface)"
6

root@panchajanya:~\> virsh dumpxml server | xpath "//interface/mac/@address"
Found 6 nodes:
-- NODE --
 address="52:54:00:2c:19:87"-- NODE --
 address="52:54:00:4b:a2:98"-- NODE --
 address="52:54:00:f1:15:ef"-- NODE --
 address="52:54:00:82:2f:44"-- NODE --
 address="52:54:00:10:aa:ca"-- NODE --
 address="52:54:00:17:9a:92"


=> Create bonded interface.

[root@server network-scripts]# nmcli con add type bond ifname bond1 bond.options "mode=balance-rr"
Connection 'bond-bond1' (93592271-228b-46a6-b354-3404d779575e) successfully added.
[root@server network-scripts]# ls -lr ifcfg-bond-*
-rw-r--r--. 1 root root 123 Aug  8 22:36 ifcfg-bond-slave-eth3
-rw-r--r--. 1 root root 123 Aug  8 22:36 ifcfg-bond-slave-eth1
-rw-r--r--. 1 root root 359 Aug 10 10:45 ifcfg-bond-bond1
-rw-r--r--. 1 root root 373 Aug  9 17:48 ifcfg-bond-bond0

=> Switch slaves

[root@server network-scripts]# nmcli con add type ethernet ifname eth4 master bond1
Connection 'bond-slave-eth4' (e4b1d9d0-3820-4e70-bf4a-12c023497713) successfully added.
 
[root@server network-scripts]# nmcli con add type ethernet ifname eth5 master bond1
Connection 'bond-slave-eth5' (8a8ce8e0-81c4-43f1-9155-d8c0b2386c28) successfully added.
[root@server network-scripts]# ls -ltr ifcfg-*
-rw-r--r--. 1 root root 254 Sep 16  2015 ifcfg-lo
-rw-r--r--. 1 root root 319 Jul 26 12:46 ifcfg-eth2
-rw-r--r--. 1 root root 335 Jul 26 12:46 ifcfg-eth0
-rw-r--r--. 1 root root 123 Aug  8 22:36 ifcfg-bond-slave-eth3
-rw-r--r--. 1 root root 123 Aug  8 22:36 ifcfg-bond-slave-eth1
-rw-r--r--. 1 root root 373 Aug  9 17:48 ifcfg-bond-bond0
-rw-r--r--. 1 root root 359 Aug 10 10:45 ifcfg-bond-bond1
-rw-r--r--. 1 root root 123 Aug 10 10:57 ifcfg-bond-slave-eth4
-rw-r--r--. 1 root root 123 Aug 10 10:57 ifcfg-bond-slave-eth5

[root@server network-scripts]# cat ifcfg-bond-slave-eth4
TYPE=Ethernet
NAME=bond-slave-eth4
UUID=e4b1d9d0-3820-4e70-bf4a-12c023497713
DEVICE=eth4
ONBOOT=yes
MASTER=bond1
SLAVE=yes

=> Bring connections up.

[root@server network-scripts]# nmcli dev
DEVICE  TYPE      STATE                                  CONNECTION
bond0   bond      connected                              bond-bond0
eth0    ethernet  connected                              System eth0
eth1    ethernet  connected                              bond-slave-eth1
eth2    ethernet  connected                              System eth2
eth3    ethernet  connected                              bond-slave-eth3
eth4    ethernet  connected                              Wired connection 1
eth5    ethernet  connected                              Wired connection 2
bond1   bond      connecting (getting IP configuration)  bond-bond1

[root@server network-scripts]# nmcli con up bond-slave-eth4
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/10)

[root@server network-scripts]# nmcli dev
DEVICE  TYPE      STATE      CONNECTION
bond0   bond      connected  bond-bond0
bond1   bond      connected  bond-bond1


10: bond1: <BROADCAST,MULTICAST,MASTER,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP
    link/ether 52:54:00:10:aa:ca brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.94/24 brd 192.168.134.255 scope global dynamic bond1
       valid_lft 3508sec preferred_lft 3508sec
    inet6 fe80::4ddc:6a30:5cb2:1f24/64 scope link
       valid_lft forever preferred_lft forever


=> CHange the bonded interface to static ip address

edit ifcfg-bond-bond1

IPADDR=192.168.134.53
GATEWAY=192.168.134.1
BOOTPROT=none


=> Reboot


=> View Bonding Master

[root@server network-scripts]# cat /sys/class/net/bonding_masters
bond1 bond0


**Note : Somehow the "mod" on same command isn't working. Cannot use add like below as it would create bond-bond1-1 interface.
nmcli con add type bond ifname bond1 bond.options "mode=balance-rr"


# To load bonding module (Persistent)

# echo "# Load the bonding kernel module at boot" > /etc/modules-load.d/bonding.conf
# echo "bonding" >> /etc/modules-load.d/bonding.conf


=> Monitor the bonded interface via
watch -dc -n 1 netstat -i

=> Change Primary via OPTS to eth1 and check if kernel picked up change

[root@server network-scripts]# grep OPTS ifcfg-bond-bond0
BONDING_OPTS="miimon=100 updelay=200 downdelay=300 mode=active-backup primary=eth1"


=> Check if kernel sees it
[root@server network-scripts]# cat /proc/net/bonding/bond0
Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)

Bonding Mode: fault-tolerance (active-backup)
Primary Slave: None
Currently Active Slave: eth1
MII Status: up
..


=> To check the actual configuration

[root@server network-scripts]# cat /sys/class/net/bond0/bonding/mode
active-backup 1
[root@server network-scripts]# cat /sys/class/net/bond1/bonding/mode
balance-rr 0


=> Check interface status

[root@server network-scripts]# ethtool bond1 | grep "Link detected"
  Link detected: yes

=> Man pages

man 5 nmcli-examples
https://people.freedesktop.org/~lkundrak/nm-docs/nmcli-examples.html
https://www.kernel.org/doc/Documentation/networking/bonding.txt

teamd uses libteam to control one instance of team driver. Logic common to all


[root@server ~]# find /lib/modules/$(uname -r)/kernel/drivers -iname "bond*"
/lib/modules/3.10.0-327.el7.x86_64/kernel/drivers/net/bonding
/lib/modules/3.10.0-327.el7.x86_64/kernel/drivers/net/bonding/bonding.ko
[root@server ~]# find /lib/modules/$(uname -r)/kernel/drivers -iname "team*"
/lib/modules/3.10.0-327.el7.x86_64/kernel/drivers/net/team
/lib/modules/3.10.0-327.el7.x86_64/kernel/drivers/net/team/team.ko
/lib/modules/3.10.0-327.el7.x86_64/kernel/drivers/net/team/team_mode_activebackup.ko
/lib/modules/3.10.0-327.el7.x86_64/kernel/drivers/net/team/team_mode_broadcast.ko
/lib/modules/3.10.0-327.el7.x86_64/kernel/drivers/net/team/team_mode_loadbalance.ko
/lib/modules/3.10.0-327.el7.x86_64/kernel/drivers/net/team/team_mode_random.ko
/lib/modules/3.10.0-327.el7.x86_64/kernel/drivers/net/team/team_mode_roundrobin.ko



[root@server ~]# echo "team" > /etc/modules-load.d/team.conf
[root@server ~]# cat /etc/modules-load.d/team.conf
team

[root@server ~]# lsmod |grep team
[root@server ~]#


[root@server network-scripts]# systemctl status teamd
● teamd.service
   Loaded: not-found (Reason: No such file or directory)
   Active: inactive (dead)

=> Add interface

virsh # attach-interface server --source vnetnat  --type network  --model virtio --persistent --live
Interface attached successfully

virsh # attach-interface server --source vnetnat  --type network  --model virtio --persistent --live
Interface attached successfully

=> Configured via nmtui

[root@server network-scripts]# cat ifcfg-Team-0
DEVICE=team0
BOOTPROTO=none
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=team0
UUID=93d89704-0c10-46fa-a653-02df2eb2cb27
ONBOOT=yes
DEVICETYPE=Team
IPADDR=192.168.134.55
PREFIX=32
GATEWAY=192.168.2.1
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes

[root@server network-scripts]# cat ifcfg-System-eth6
NAME=eth6
UUID=dac2bf67-ecab-47c0-a404-286f19dd4b5e
DEVICE=eth6
ONBOOT=yes
TEAM_MASTER=team0
DEVICETYPE=TeamPort
TEAM_MASTER_UUID=93d89704-0c10-46fa-a653-02df2eb2cb27


[root@server network-scripts]# cat ifcfg-System-eth7
NAME=eth7
UUID=e5be80f7-5806-4673-aca5-9bd378e6058a
DEVICE=eth7
ONBOOT=yes
TEAM_MASTER=team0
DEVICETYPE=TeamPort
TEAM_MASTER_UUID=93d89704-0c10-46fa-a653-02df2eb2cb27

=> Adding team via nmcli

[root@server network-scripts]# nmcli con add type team con-name team0 ifname eth6
Connection 'team0' (d1dfa81c-8b73-48e9-ab61-0a49ff71b7fb) successfully added.

[root@server network-scripts]# cat ifcfg-team0
DEVICE=eth6
BOOTPROTO=dhcp
DEFROUTE=yes
PEERDNS=yes
PEERROUTES=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=team0
UUID=d1dfa81c-8b73-48e9-ab61-0a49ff71b7fb
ONBOOT=yes
DEVICETYPE=Team

[root@server network-scripts]# nmcli con add type team con-name team0 ifname eth7
Connection 'team0' (9ca87de1-3c17-401c-97e3-d8020724ba8a) successfully added.

[root@server network-scripts]# nmcli con edit 5a0dcb56-d2c3-362d-abc0-b2b5ca797851

===| nmcli interactive connection editor |===

Editing existing '802-3-ethernet' connection: '5a0dcb56-d2c3-362d-abc0-b2b5ca797851'

Type 'help' or '?' for available commands.
Type 'describe [<setting>.<prop>]' for detailed property description.

You may edit the following settings: connection, 802-3-ethernet (ethernet), 802-1x, dcb, ipv4, ipv6
nmcli> print ipv4
['ipv4' setting values]
ipv4.method:                            auto
ipv4.dns:
ipv4.dns-search:
ipv4.dns-options:                       (default)
ipv4.dns-priority:                      0
ipv4.addresses:
ipv4.gateway:                           --
ipv4.routes:
ipv4.route-metric:                      -1
ipv4.ignore-auto-routes:                no
ipv4.ignore-auto-dns:                   no
ipv4.dhcp-client-id:                    --
ipv4.dhcp-timeout:                      0
ipv4.dhcp-send-hostname:                yes
ipv4.dhcp-hostname:                     --
ipv4.dhcp-fqdn:                         --
ipv4.never-default:                     no
ipv4.may-fail:                          yes
ipv4.dad-timeout:                       -1 (default)
nmcli> set ipv4.address=192.168.134.56/24
Error: invalid property: 'address=192.168.134.56/24' not among [method, dns, dns-search, dns-options, dns-priority, addresses, gateway, routes, route-metric, ignore-auto-routes, ignore-auto-dns, dhcp-hostname, dhcp-send-hostname, never-default, may-fail, dad-timeout, dhcp-timeout, dhcp-client-id, dhcp-fqdn]

nmcli> set ipv4.addresses 192.168.134.56/24
Do you also want to set 'ipv4.method' to 'manual'? [yes]: yes
nmcli> print ipv4
['ipv4' setting values]
ipv4.method:                            manual
ipv4.dns:
ipv4.dns-search:
ipv4.dns-options:                       (default)
ipv4.dns-priority:                      0
ipv4.addresses:                         192.168.134.56/24
ipv4.gateway:                           --
ipv4.routes:
ipv4.route-metric:                      -1
ipv4.ignore-auto-routes:                no
ipv4.ignore-auto-dns:                   no
ipv4.dhcp-client-id:                    --
ipv4.dhcp-timeout:                      0
ipv4.dhcp-send-hostname:                yes
ipv4.dhcp-hostname:                     --
ipv4.dhcp-fqdn:                         --
ipv4.never-default:                     no
ipv4.may-fail:                          yes
ipv4.dad-timeout:                       -1 (default)
nmcli> save
Connection 'Wired connection 1' (5a0dcb56-d2c3-362d-abc0-b2b5ca797851) successfully updated.
nmcli> quit


=> File name created as 

-rw-r--r--. 1 root root   254 Aug 10 18:37 ifcfg-lo
-rw-r--r--. 1 root root   425 Aug 10 19:31 ifcfg-bond-bond0
-rw-r--r--. 1 root root   421 Aug 10 20:02 ifcfg-mybond
-rw-r--r--. 1 root root   368 Aug 11 18:51 ifcfg-Wired_connection_1

[root@server network-scripts]# nmcli con modify 5a0dcb56-d2c3-362d-abc0-b2b5ca797851 connection.name eth6
Error: invalid property 'name': 'name' not among [id, uuid, interface-name, type, permissions, autoconnect, autoconnect-priority, timestamp, read-only, zone, master, slave-type, autoconnect-slaves, secondaries, gateway-ping-timeout, metered, lldp, stable-id].

Start here: https://access.redhat.com/solutions/2592561


=> Connection 
[root@server network-scripts]# nmcli con add type team con-name team0 ifname team0 ip4  192.168.134.70/24 gw4 192.168.2.1

[root@server network-scripts]# cat ifcfg-team0
DEVICE=team0
BOOTPROTO=none
IPADDR=192.168.134.70
PREFIX=24
GATEWAY=192.168.2.1
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=team0
UUID=ed3d1376-bb3c-448f-8f08-391ecb097506
ONBOOT=yes
DEVICETYPE=Team

Bestway to edit/create team configurations is to copy a templaet and edit 

[root@server network-scripts]# ls -ltr /usr/share/doc/teamd-1.17/example_configs/
total 64
-rw-r--r--. 1 root root  97 Apr  2  2015 roundrobin.conf
-rw-r--r--. 1 root root 244 Apr  2  2015 roundrobin_2.conf
-rw-r--r--. 1 root root  93 Apr  2  2015 random.conf
-rw-r--r--. 1 root root 183 Apr  2  2015 loadbalance_3.conf
-rw-r--r--. 1 root root 140 Apr  2  2015 loadbalance_2.conf
-rw-r--r--. 1 root root  98 Apr  2  2015 loadbalance_1.conf
-rw-r--r--. 1 root root 209 Apr  2  2015 lacp_1.conf
-rw-r--r--. 1 root root  96 Apr  2  2015 broadcast.conf
-rw-r--r--. 1 root root 318 Apr  2  2015 activebackup_tipc.conf
-rw-r--r--. 1 root root 285 Apr  2  2015 activebackup_nsna_ping_1.conf
-rw-r--r--. 1 root root 447 Apr  2  2015 activebackup_multi_lw_1.conf
-rw-r--r--. 1 root root 241 Apr  2  2015 activebackup_ethtool_3.conf
-rw-r--r--. 1 root root 212 Apr  2  2015 activebackup_ethtool_2.conf
-rw-r--r--. 1 root root 194 Apr  2  2015 activebackup_ethtool_1.conf
-rw-r--r--. 1 root root 465 Apr  2  2015 activebackup_arp_ping_2.conf
-rw-r--r--. 1 root root 305 Apr  2  2015 activebackup_arp_ping_1.conf

=> Team89 example

virsh # attach-interface server --source vnetnat  --type network  --model virtio --persistent --live
Interface attached successfully

virsh # attach-interface server --source vnetnat  --type network  --model virtio --persistent --live
Interface attached successfully

19: eth8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:02:c3:a1 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.5/24 brd 192.168.134.255 scope global dynamic eth8
       valid_lft 3600sec preferred_lft 3600sec
    inet6 fe80::5506:7254:be0:f513/64 scope link
       valid_lft forever preferred_lft forever
20: eth9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:4b:3b:c6 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.43/24 brd 192.168.134.255 scope global dynamic eth9
       valid_lft 3600sec preferred_lft 3600sec
    inet6 fe80::d594:df13:9875:802/64 scope link
       valid_lft forever preferred_lft forever


       -rw-r--r--. 1 root root 374 Aug 14 12:29 ifcfg-eth6
-rw-r--r--. 1 root root 339 Aug 14 12:39 ifcfg-team89
[root@server network-scripts]# cat ifcfg-team89
DEVICE=team89
BOOTPROTO=none
IPADDR=192.168.134.75
PREFIX=24
GATEWAY=192.168.2.1
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=team89
UUID=9a44fa39-d1d7-486d-b9b5-ca331b9c230e
ONBOOT=yes
DEVICETYPE=Team


[root@server network-scripts]# nmcli con add type team-slave con-name eth8 ifname eth8 master team89
Connection 'eth8' (26151597-6a17-4b55-baef-8a9e2126e1bb) successfully added.
[root@server network-scripts]# nmcli con add type team-slave con-name eth9 ifname eth9 master team89
Connection 'eth9' (a00735db-35a7-4fad-b387-c13c5cc0a79e) successfully added.
[root@server network-scripts]# ls -ltr ifcfg-eth
ifcfg-eth0    ifcfg-eth2    ifcfg-eth6    ifcfg-eth6-1  ifcfg-eth7    ifcfg-eth7-1  ifcfg-eth8    ifcfg-eth9

[root@server network-scripts]# cat ifcfg-eth8
NAME=eth8
UUID=26151597-6a17-4b55-baef-8a9e2126e1bb
DEVICE=eth8
ONBOOT=yes
TEAM_MASTER=team89
DEVICETYPE=TeamPort
[root@server network-scripts]# cat ifcfg-eth9
NAME=eth9
UUID=a00735db-35a7-4fad-b387-c13c5cc0a79e
DEVICE=eth9
ONBOOT=yes
TEAM_MASTER=team89
DEVICETYPE=TeamPort

nmcli con up team89

21: team89: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN
    link/ether ea:53:89:b1:c7:cf brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.75/24 brd 192.168.134.255 scope global team89
       valid_lft forever preferred_lft forever

19: eth8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:02:c3:a1 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.5/24 brd 192.168.134.255 scope global dynamic eth8
       valid_lft 3312sec preferred_lft 3312sec
    inet6 fe80::5506:7254:be0:f513/64 scope link
       valid_lft forever preferred_lft forever
20: eth9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:4b:3b:c6 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.43/24 brd 192.168.134.255 scope global dynamic eth9
       valid_lft 3312sec preferred_lft 3312sec
    inet6 fe80::d594:df13:9875:802/64 scope link
       valid_lft forever preferred_lft forever


=> eth8 & eth9 still using IP's (dhcp). Reload did not work. 

[root@server network-scripts]# ifdown eth8
Device 'eth8' successfully disconnected.
[root@server network-scripts]# ifdown eth9
Device 'eth9' successfully disconnected.

Use nmcli to bring the devices up

[root@server network-scripts]# nmcli con up eth8
[root@server network-scripts]# nmcli con up eth9

19: eth8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master team89 state UP qlen 1000
    link/ether 52:54:00:02:c3:a1 brd ff:ff:ff:ff:ff:ff
20: eth9: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master team89 state UP qlen 1000
    link/ether 52:54:00:02:c3:a1 brd ff:ff:ff:ff:ff:ff


    [root@server network-scripts]# teamdctl team89 state
setup:
  runner: roundrobin
ports:
  eth8
    link watches:
      link summary: up
      instance[link_watch_0]:
        name: ethtool
        link: up
        down count: 0
  eth9
    link watches:
      link summary: up
      instance[link_watch_0]:
        name: ethtool
        link: up
        down count: 0


[root@server network-scripts]# teamnl team89 ports
 20: eth9: up 0Mbit HD
 19: eth8: up 0Mbit HD

 [root@server network-scripts]# teamnl team0 setoption mode activebackup
[root@server network-scripts]# teamnl team0 options
 activeport 0
 mcast_rejoin_interval 0
 mcast_rejoin_count 0
 notify_peers_interval 0
 notify_peers_count 0
 mode activebackup

=> Add ip address to existing team

[root@server network-scripts]# ip addr show team0
18: team0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN
    link/ether 7e:71:79:28:e3:05 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.70/24 brd 192.168.134.255 scope global team0
       valid_lft forever preferred_lft forever
[root@server network-scripts]# ip addr add 192.168.134.78/24 dev team0
[root@server network-scripts]# ip addr show team0
18: team0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN
    link/ether 7e:71:79:28:e3:05 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.70/24 brd 192.168.134.255 scope global team0
       valid_lft forever preferred_lft forever
    inet 192.168.134.78/24 scope global secondary team0
       valid_lft forever preferred_lft forever

=> To add/remove ports

teamdctl team0 port add eth9
teamdctl team0 port remove eth9

--To send keys to hung guests
root@panchajanya:~\> virsh send-key lab125a KEY_LEFTALT KEY_SYSRQ KEY_H

#Verify an installed package against the attributes of files in the package..

[root@lab11 ~]# rpm -qf /usr/bin/netstat
net-tools-2.0-0.17.20131004git.el7.x86_64
[root@lab11 ~]# rpm -Vf /usr/bin/netstat
[root@lab11 ~]# ls -ltr /usr/bin/netstat
-rwxr-xr-x. 1 root root 154968 Jun  9  2014 /usr/bin/netstat
[root@lab11 ~]# chmod ugo-x /usr/bin/netstat
[root@lab11 ~]# rpm -Vf /usr/bin/netstat
.M.......    /bin/netstat

=> Indicates mode changed

[root@lab11 ~]# chown user100:user100 /usr/bin/netstat
[root@lab11 ~]# rpm -Vf /usr/bin/netstat
.M...UG..    /bin/netstat

=> Indicates User/Group Changed


[root@lab11 ~]# rpm -Vfv /usr/bin/netstat
.M...UG..    /bin/netstat
.........    /sbin/arp
.........    /sbin/ether-wake
.........    /sbin/ifconfig

#References:
https://documentation.meraki.com/MS/Layer_3_Switching/Layer_3_versus_Layer_2_Switch_for_VLANs


</pre>

</div>
  
  
<div class="w3-container">
  <h1><span class="mw-headline" id="PERFORMANCE"> Performance </h1>
<p>

A four-processor machine can be visualized as a four-lane freeway. Each lane provides the path on which instructions can execute. A vehicle can represent those instructions. Additionally, there are vehicles on the entrance lanes ready to travel down the freeway, and the four lanes either are ready to accommodate that demand or they're not. If all freeway lanes are jammed, the cars entering have to wait for an opening. If we now apply the CPU percentage and CPU load-average measurements to this situation, percentage examines the relative amount of time each vehicle was found occupying a freeway lane, which inherently ignores the pent-up demand for the freeway—that is, the cars lined up on the entrances. So, for example, vehicle license XYZ 123 was found on the freeway 30% of the sampling time. Vehicle license ABC 987 was found on the freeway 14% of the time. That gives a picture of how each vehicle is utilizing the freeway, but it does not indicate demand for the freeway.

Moreover, the percentage of time these vehicles are found on the freeway tells us nothing about the overall traffic pattern except, perhaps, that they are taking longer to get to their destination than they would like. Thus, we probably would suspect some sort of a jam, but the CPU percentage would not tell us for sure. The load averages, on the other hand, would.

This brings us to the point. It is the overall traffic pattern of the freeway itself that gives us the best picture of the traffic situation, not merely how often cars are found occupying lanes. The load average gives us that view because it includes the cars that are queuing up to get on the freeway. It could be the case that it is a nonrush-hour time of day, and there is little demand for the freeway, but there just happens to be a lot of cars on the road. The CPU percentage shows us how much the cars are using the freeway, but the load averages show us the whole picture, including pent-up demand. Even more interesting, the more recent that pent-up demand is, the more the load-average value reflects it.

Taking the discussion back to the machinery at hand, the load averages tell us by increasing duration whether our physical CPUs are over- or under-utilized. The point of perfect utilization, meaning that the CPUs are always busy and, yet, no process ever waits for one, is the average matching the number of CPUs. If there are four CPUs on a machine and the reported one-minute load average is 4.00, the machine has been utilizing its processors perfectly for the last 60 seconds. This understanding can be extrapolated to the 5- and 15-minute averages.
  <BR>
Reference: 
  <BR>
http://www.linuxjournal.com/article/9001?page=0,0

</p>


<pre> 
http://www.binarytides.com/linux-ss-command/

yum install iproute2-doc


--ss examples
ss -t4 src 192.168.2.0/24 dst 192.168.1.0/24 '( sport = :ssh or dport \> :4000 )'


--Find memory used by a single process
ps aux --sort -rss

https://stackoverflow.com/questions/7880784/what-is-rss-and-vsz-in-linux-memory-management
https://techtalk.intersec.com/2013/07/memory-part-2-understanding-process-memory/



--CPU Overloaded in last minute
   
[root@lab125a yum.repos.d]# cat /proc/cpuinfo  |grep processor
processor : 0

[root@lab125a yum.repos.d]# stress --cpu 2 --timeout 60
stress: info: [3764] dispatching hogs: 2 cpu, 0 io, 0 vm, 0 hdd
stress: info: [3764] successful run completed in 60s

[root@lab125a yum.repos.d]# uptime
14:19:58 up  4:21,  2 users,  load average: 1.24, 0.40, 0.17


--Load CPU via stress 

[root@lab125a yum.repos.d]# stress --cpu 1 --timeout 5
stress: info: [3761] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd

[root@lab125a ~]# dstat -cmdnt
----total-cpu-usage---- ------memory-usage----- -dsk/total- -net/total- ----system----
usr sys idl wai hiq siq| used  buff  cach  free| read  writ| recv  send|     time
  0   0  99   0   0   0| 192M  952k  278M  522M|  11k 9864B|   0     0 |22-09 14:18:10
  0   0 100   0   0   0| 192M  952k  278M  522M|   0     0 | 170B  102B|22-09 14:18:11
  0   0 100   0   0   0| 192M  952k  278M  522M|   0     0 |  66B  166B|22-09 14:18:12
  0   0 100   0   0   0| 192M  952k  278M  522M|   0     0 | 170B  118B|22-09 14:18:13
  0   0 100   0   0   0| 192M  952k  278M  522M|   0     0 |  66B  118B|22-09 14:18:14
 32   0  68   0   0   0| 192M  952k  278M  522M|   0     0 | 170B  118B|22-09 14:18:15
100   0   0   0   0   0| 192M  952k  278M  522M|   0     0 |  66B  118B|22-09 14:18:16
100   0   0   0   0   0| 192M  952k  278M  522M|   0     0 | 170B  118B|22-09 14:18:17
100   0   0   0   0   0| 192M  952k  278M  522M|   0     0 |  66B  118B|22-09 14:18:18
100   0   0   0   0   0| 192M  952k  278M  522M|   0     0 | 170B  102B|22-09 14:18:19
 66   0  34   0   0   0| 192M  952k  278M  522M|   0     0 |  66B  102B|22-09 14:18:20
  0   0 100   0   0   0| 192M  952k  278M  522M|   0     0 | 170B  118B|22-09 14:18:21
  0   0 100   0   0   0| 192M  952k  278M  522M|   0     0 |  66B  134B|22-09 14:18:22^C


--More granular

dstat -cmdn ( c = cpu, m = memory, d= disk, n = network)
dstat -gyprs ( g = paging, y = system stats, p = process stats, r = read/write stats, s = swap stats)


-- Memory details (flag = htm )

[root@lab125a yum.repos.d]# free -htm
        total        used        free      shared  buff/cache   available
Mem:           993M         62M        852M        1.4M         78M        822M
Swap:          511M         98M        413M
Total:         1.5G        161M        1.2G

[root@lab125a yum.repos.d]# cat /proc/sys/vm/drop_caches
0

[root@lab125a yum.repos.d]# echo 3 > /proc/sys/vm/drop_caches

[root@lab125a yum.repos.d]# cat /proc/sys/vm/drop_caches
3

--Notice the buff/cache drop afer the flush!

[root@lab125a yum.repos.d]# free -htm
        total        used        free      shared  buff/cache   available
Mem:           993M         61M        876M        1.4M         55M        835M
Swap:          511M         98M        413M
Total:         1.5G        160M        1.3G


[root@lab125a yum.repos.d]# swapoff -a

[root@lab125a yum.repos.d]# free -htm
        total        used        free      shared  buff/cache   available
Mem:           993M        127M        801M        7.2M         63M        762M
Swap:            0B          0B          0B
Total:         993M        127M        801M


--To free pagecache:
# echo 1 > /proc/sys/vm/drop_caches

To free dentries and inodes:
# echo 2 > /proc/sys/vm/drop_caches

To free pagecache, dentries and inodes:
# echo 3 > /proc/sys/vm/drop_caches

--ss syntax

[root@rhce1 samba]# ss -nt sport \< :1024
State      Recv-Q Send-Q                  Local Address:Port                                 Peer Address:Port
ESTAB      0      0                      192.168.122.10:22                                  192.168.122.1:60664

--Stress-ng example
[root@lab125a ~]# stress-ng -c 2 --cpu-ops 10000 -t 10 --metrics
stress-ng: info:  [2744] dispatching hogs: 2 cpu
stress-ng: info:  [2744] successful run completed in 10.01s





</pre>

</div>


  
<div class="w3-container">
  <h1><span class="mw-headline" id="SECURITY"> Security </h1>
<p>

</p>


<pre> 

--Login/Logout Details
Data Stored @ /var/log/wtmp 
last
last reboot

--Failed User attempts
Data stored @ /var/log/btmp
lastb

--Users who has never logged in
lastlog


--setuid/setgid/stickybit (4 - 2 - 1)
  
-setuid 
[root@lab125a ~]# ll /usr/bin/su
-rwsr-xr-x. 1 root root 32072 Nov 20  2015 /usr/bin/su

#When the setuid bit is used, the behavior described above it's modified so that when an executable is launched, it does not run with the
privileges of the user who launched it, but with that of the file owner insteadsetuid is bit so other users can execute su with 'root' privileges. (chmod 4755)

find / -perm -4000 

#setgid
Non-owners can execute with exact privileges that the group members have.(chmod 2755)
find / -perm -4000 

-setgid

Unlike the setuid bit, the setgid bit has effect on both files and directories. In the first case, the file which has the setgid bit set, 
when executed, instead of running with the privileges of the group of the user who started it, 
runs with those of the group which owns the file: in other words, the group ID of the process will be the same of that of the file.
Can also be set on group-shared directories to allow files/sub-dirs to inherit the owning group. The standard behavior 
when a directory/file is created to always receive the creator's group.


find / -perm -2000

[root@lab125a ~]# ll /usr/bin/wall
-r-xr-sr-x. 1 root tty 15344 Jun  9  2014 /usr/bin/wall
 
-stickybit 

The sticky bit works in a different way: while it has no effect on files, when used on a directory, all the files in said directory
 will be modifiable only by their owners. A typical case in which it is used, involves the /tmp directory. 
Typically this directory is writable by all users on the system, so to make impossible for one user to delete the files of another one, the sticky bit is set:


[root@lab125a ~]# ll -d /tmp/
drwxrwxrwt. 12 root root 4096 Sep 25 19:52 /tmp/

Protects the files being removed/deleted by non-owners even though the directory has the rw permissions.

--passwd/shadow/group/gshadow

Limits are defined in /etc/login.defs
[root@lab125a etc]# cat /etc/login.defs | grep -v ^# |grep -v ^$
MAIL_DIR  /var/spool/mail
PASS_MAX_DAYS 99999
PASS_MIN_DAYS 0
PASS_MIN_LEN  5
..

--shadow
!! at the beginning of 2nd field(password filed) means user is locked.
root:$6$CYV0wm.5tR7eWgd4fRFGVmWrdD8vQwIavP.::0:99999:7:::
bin:*:16659:0:99999:7:::
babu:!!:17396:0:99999:7:::

Lock password (passwd -l babu), Unlock(passwd -u babu), Lock Account(usermod -L babu), Unlock Account(usermod -U babu)

[root@lab125a etc]# passwd -S babu
babu NP 2017-08-17 0 99999 7 -1 (Empty password.)
[root@lab125a etc]# passwd -S user1
user1 LK 2017-08-21 0 99999 7 -1 (Password locked.)

--Number of days before which the passwords should be changed
change -m user 10
passwd -n user 15

--Perms on gshadow file is 000
[root@lab125a etc]# ls -ltr gshadow
----------. 1 root root 658 Sep 19 09:42 gshadow

-VErify integrity of passwd/shadow files
pwck
grpck

--vipwd and vigr

--Activate & Deactivate shadow mechanism
pwconv, pwunconv , grpconv, grpunconv

--/etc/skel
[root@lab125a etc]# echo "Welcome to Lab125a" > /etc/skel/readme.txt

[root@lab125a etc]# useradd usertest

[root@lab125a etc]# ls -l /home/usertest/
total 4
-rw-r--r--. 1 usertest usertest 19 Sep 29 16:43 readme.txt

--useradd
Picks default values from /etc/default/useradd and /etc/login.defs

--.bashrc/.bash_profile/.bash_logout behaviour during su and su -


[root@lab125a ~]# su user3
 This is from .bashrc
[user3@lab125a root]$ exit
exit

[root@lab125a profile.d]# su - user3
Last login: Sat Sep 30 11:08:48 CDT 2017 on pts/0
This is set in /etc/profile.d/runme.sh : Setting vi editor for shell
 This is from .bashrc
This is from .bash_profile
[user3@lab125a ~]$ exit
logout
This is from .bash_logout

Note:When you login (type username and password) via console, either sitting at the machine,
or remotely via ssh: .bash_profile is executed to configure your shell before the initial command prompt.
But, if you’ve already logged into your machine and open a new terminal window (xterm) inside Gnome or KDE,
then .bashrc is executed before the window command prompt. .bashrc is also run when you start a new bash instance by typing /bin/bash in a terminal.

--Example (Expire users passwod and prompt it to change at next login (-d 0) , be unable to change the password within 5 days following last
password change (-m 5) and disable account expiration ( -E -1 )

[root@lab125a ~]# chage -E -1 -d 0 -m 5 user3


--su - (Hypen) ensures that directory is switched to the homedirectory of new user , changes environment variables to that of new user.

--System wide scripts 
/etc/bashrc and /etc/profile executes scripts in /etc/profile.d for all users.
Env variables like HOSTNAME, HISTSIZE, HISTCONTROL are set in /etc/profile


/etc/hosts.allow is parsed first followed by /etc/hosts/deny. <BR> 
netcat not a good tool to validate the connectivity as it will show connected but the ssh itself wouldn't work. <BR>
This can only be used to restrict wrapper-aware programs like finger,sssh,telnet, rsh, talk. <BR>
  
service : user@source

--suoders reference
http://sleepyhead.de/howto/?href=sudo
http://toroid.org/sudoers-syntax

User Host = (Runas) Command

Runas
If you also specify a target group, e.g., (postgres:postgres), sudo will accept any combination of the listed 
users and groups (see the section on aliases below). If you specify only a target group, e.g., (:postgres),
 sudo will accept and act on “-g postgres” but run commands only as the invoking user.

ams ALL=/bin/ls, /bin/df -h /, /bin/date ""
Double quotes implies command can be executed only without arguments.

Options
Before the command, you can specify zero or more options to control how it will be executed. The most important options are NOPASSWD (to not require a password) and SETENV (to allow the user to set environment variables for the command).
ams ALL=(ALL) NOPASSWD: SETENV: /bin/ls


-- Limit access to su

Add ID's to the wheel group

-bash-4.2$ grep wheel /etc/group
wheel:x:10:arjun,oracle

Enable PAM module ( Uncomment below line )
[root@server1 security]# cat /etc/pam.d/su
#%PAM-1.0
...
# Uncomment the following line to require a user to be in the "wheel" group.
auth    required  pam_wheel.so use_uid

--Two ways to check whether a library supports the tcpwrapper


[root@lab19 ~]# ldd /usr/sbin/sshd | grep libwrap
  libwrap.so.0 => /lib64/libwrap.so.0 (0x00007f51bb5ba000)

or

[root@lab125a ~]# strings -f /usr/sbin/* | grep hosts_access
/usr/sbin/auditd: hosts_access
/usr/sbin/rpcbind: hosts_access
/usr/sbin/rpc.mountd: hosts_access
/usr/sbin/rpc.rquotad: hosts_access
/usr/sbin/rpc.statd: hosts_access
/usr/sbin/sshd: hosts_access

-How to check if TCPDB would behave 

[root@rhce1 exports.d]# grep rpc /etc/hosts.deny
rpcbind,rpc.mountd :  192.168.122.20

[root@rhce1 exports.d]# tcpdmatch rpcbind 192.168.122.20
client:   address  192.168.122.20
server:   process  rpcbind
access:   denied
[root@rhce1 exports.d]# tcpdmatch rpcbind 192.168.122.30
client:   address  192.168.122.30
server:   process  rpcbind
access:   granted



 ausearch -c "httpd" -m AVC
 time->Tue Nov 14 20:43:36 2017
type=PROCTITLE msg=audit(1510713816.781:964): proctitle=2F7573722F7362696E2F6874747064002D44464F524547524F554E44
type=SYSCALL msg=audit(1510713816.781:964): arch=c000003e syscall=4 success=no exit=-13 a0=55d49b0f2100 a1=7ffc0a425640 a2=7ffc0a425640 a3=7f04064e9792 items=0 ppid=11184 pid=11188 auid=4294967295 uid=48 gid=48 euid=48 suid=48 fsuid=48 egid=48 sgid=48 fsgid=48 tty=(none) ses=4294967295 comm="httpd" exe="/usr/sbin/httpd" subj=system_u:system_r:httpd_t:s0 key=(null)
type=AVC msg=audit(1510713816.781:964): avc:  denied  { getattr } for  pid=11188 comm="httpd" path="/custom/index.html" dev="dm-0" ino=149255 scontext=system_u:system_r:httpd_t:s0 tcontext=unconfined_u:object_r:default_t:s0 tclass=file


--Example usecase-1 ( The 'twist' directive is used to replace the service with a selected command )

Lead to the discovery of hte SELINUX NIS context error...


[root@lab125a ~]# tail -1 /etc/hosts.allow
sshd: user1@192.168.2.55

[root@lab125a ~]# tail -1 /etc/hosts.deny
sshd : ALL : twist /bin/echo "Service suspended for abuse!"

--Use spawn directive to spawn a command capture messages from the host
sshd : ALL : spawn /bin/echo VSFTP requested to %h >> /var/log/vsftp.log


--Ideally user1 should have allowed..

[root@lab19 ~]# ssh user1@lab125a
ssh_exchange_identification: read: Connection reset by peer

==> /var/log/messages <==
Oct  3 19:14:18 lab125a dbus[596]: [system] Successfully activated service 'org.fedoraproject.Setroubleshootd'
Oct  3 19:14:18 lab125a dbus-daemon: dbus[596]: [system] Successfully activated service 'org.fedoraproject.Setroubleshootd'
Oct  3 19:14:18 lab125a setroubleshoot: SELinux is preventing /usr/sbin/sshd from name_connect access on the tcp_socket port 113. For complete SELinux messages. 
run sealert -l cd9b7da6-cb08-43ae-81e0-dbd7dd928036
Oct  3 19:14:18 lab125a python: SELinux is preventing /usr/sbin/sshd from name_connect access on the tcp_socket port 113.#012#012*****  Plugin catchall_boolean (47.5 confidence) suggests   
******************#012#012If you want to allow nis to enabled#012Then you must tell SELinux about this by enabling the 'nis_enabled' boolean.#012
You can read 'None' man page for more details.#012Do#012setsebool -P nis_enabled 1#012#012*****  Plugin catchall_boolean (47.5 confidence) suggests   ******************#012#012
If you want to allow daemons to use tcp wrapper#012Then you must tell SELinux about this by enabling the 'daemons_use_tcp_wrapper' boolean.#012

--Run sealert

[root@lab125a ~]# sealert -l cd9b7da6-cb08-43ae-81e0-dbd7dd928036
SELinux is preventing /usr/sbin/sshd from name_connect access on the tcp_socket port 113.

*****  Plugin catchall_boolean (47.5 confidence) suggests   ******************

If you want to allow nis to enabled
Then you must tell SELinux about this by enabling the 'nis_enabled' boolean.
You can read 'None' man page for more details.
Do
setsebool -P nis_enabled 1

*****  Plugin catchall_boolean (47.5 confidence) suggests   ******************

If you want to allow daemons to use tcp wrapper
Then you must tell SELinux about this by enabling the 'daemons_use_tcp_wrapper' boolean.
You can read 'None' man page for more details.
Do
setsebool -P daemons_use_tcp_wrapper 1

*****  Plugin catchall (6.38 confidence) suggests   **************************

If you believe that sshd should be allowed name_connect access on the port 113 tcp_socket by default.
Then you should report this as a bug.
You can generate a local policy module to allow this access.
Do
allow this access for now by executing:
# ausearch -c 'sshd' --raw | audit2allow -M my-sshd
# semodule -i my-sshd.pp


Additional Information:
Source Context                system_u:system_r:sshd_t:s0-s0:c0.c1023
Target Context                system_u:object_r:auth_port_t:s0
Target Objects                port 113 [ tcp_socket ]
Source                        sshd
Source Path                   /usr/sbin/sshd
Port                          113
Host                          lab125a
Source RPM Packages
Target RPM Packages
Policy RPM                    selinux-policy-3.13.1-102.el7_3.16.noarch
Selinux Enabled               True
Policy Type                   targeted
Enforcing Mode                Enforcing
Host Name                     lab125a
Platform                      Linux lab125a 3.10.0-327.el7.x86_64 #1 SMP Thu Nov
                              19 22:10:57 UTC 2015 x86_64 x86_64
Alert Count                   24
First Seen                    2017-10-03 18:37:56 CDT
Last Seen                     2017-10-03 19:14:17 CDT
Local ID                      cd9b7da6-cb08-43ae-81e0-dbd7dd928036

Raw Audit Messages
type=AVC msg=audit(1507076057.918:1493): avc:  denied  { name_connect } for  pid=3693 comm="sshd" dest=113 scontext=system_u:system_r:sshd_t:s0-s0:c0.c1023 tcontext=system_u:object_r:auth_port_t:s0 tclass=tcp_socket


Hash: sshd,sshd_t,auth_port_t,tcp_socket,name_connect

AllowTCPForwarding
This tells whether or not the tunneled connections are allowed.

--Disable login for all users ..
[root@rhce4 ~]# cat /etc/nologin
LOgins temporarily disabled for maintanence


[root@server ssh]# grep banner sshd_config
# no default banner path
Banner /etc/banner

root@panchajanya:~\> ssh rhce5
 This is from banner
Last login: Tue Jun 26 12:48:31 2018 from 192.168.122.1
This is from motd


-sshd_config parameters.

ClientAliveCountMax
This sets the number of attempts the OpenSSH server should make contacting the client before issuing a disconnect ( Zero means session stays connected indefinitely.) and will be sent in intervals defined by ClientAliveInterval.

TCPKeepAlive
sshd will send keep-alive requests to the clients. So in case of a client crash, the server side process will be terminated.

X11Forwarding
Will establish a tunnel and automatically set the $DISPLAY variable. eg 10:1 (Where X11DisplayOffset 10) If a user resets the DISPLAY variable to use a different one for eg.rack:0.1
then encryption is defeated.

#Enabling Port 99 in addition to port 22 and restart of sshd.

*******************#012#012If you believe that sshd should be allowed name_bind access on the port 99 tcp_socket by default.#012Then you should report this as a bug.#012You can generate a local policy module to allow this access.#012Do#012allow this access for now by executing:#012# ausearch -c 'sshd' --raw | audit2allow -M my-sshd#012# semodule -i my-sshd.pp#012
Aug  1 14:32:18 server setroubleshoot: SELinux is preventing /usr/sbin/sshd from name_bind access on the tcp_socket port 99. For complete SELinux messages. run sealert -l fc07953e-1392-421e-a4db-21705ffa9df1
Aug  1 14:32:18 server python: SELinux is preventing /usr/sbin/sshd from name_bind access on the tcp_socket port 99.#012#012*****  Plugin bind_ports (99.5 confidence) suggests   ************************#012#012If you want to allow /usr/sbin/sshd to bind to network port 99#012Then you need to modify the port type.#012Do#012# semanage port -a -t PORT_TYPE -p tcp 99#012    where PORT_TYPE is one of the following: ssh_port_t, vnc_port_t, xserver_port_t.#012#012*****  Plugin catchall (1.49 confidence) suggests   **************************#012#012If you believe that sshd should be allowed name_bind access on the port 99 tcp_socket by default.#012Then you should report this as a bug.#012You can generate a local policy module to allow this access.#012Do#012allow this access for now by executing:#012# ausearch -c 'sshd' --raw | audit2allow -M my-sshd#012# semodule -i my-sshd.pp#012


[root@server ~]# sealert -l fc07953e-1392-421e-a4db-21705ffa9df1
SELinux is preventing /usr/sbin/sshd from name_bind access on the tcp_socket port 99.

*****  Plugin bind_ports (99.5 confidence) suggests   ************************

If you want to allow /usr/sbin/sshd to bind to network port 99
Then you need to modify the port type.
Do
# semanage port -a -t PORT_TYPE -p tcp 99
    where PORT_TYPE is one of the following: ssh_port_t, vnc_port_t, xserver_port_t.

*****  Plugin catchall (1.49 confidence) suggests   **************************

If you believe that sshd should be allowed name_bind access on the port 99 tcp_socket by default.
Then you should report this as a bug.
You can generate a local policy module to allow this access.
Do
allow this access for now by executing:
# ausearch -c 'sshd' --raw | audit2allow -M my-sshd
# semodule -i my-sshd.pp


Additional Information:
Source Context                system_u:system_r:sshd_t:s0-s0:c0.c1023
Target Context                system_u:object_r:reserved_port_t:s0
Target Objects                port 99 [ tcp_socket ]
Source                        sshd
Source Path                   /usr/sbin/sshd
Port                          99
Host                          server
Source RPM Packages
Target RPM Packages
Policy RPM                    selinux-policy-3.13.1-102.el7_3.16.noarch
Selinux Enabled               True
Policy Type                   targeted
Enforcing Mode                Enforcing
Host Name                     server
Platform                      Linux server 3.10.0-327.el7.x86_64 #1 SMP Thu Nov
                              19 22:10:57 UTC 2015 x86_64 x86_64
Alert Count                   5
First Seen                    2017-08-01 12:38:53 CDT
Last Seen                     2017-08-01 14:32:04 CDT
Local ID                      fc07953e-1392-421e-a4db-21705ffa9df1

Raw Audit Messages
type=AVC msg=audit(1501615924.31:403): avc:  denied  { name_bind } for  pid=3067 comm="sshd" src=99 scontext=system_u:system_r:sshd_t:s0-s0:c0.c1023 tcontext=system_u:object_r:reserved_port_t:s0 tclass=tcp_socket


Hash: sshd,sshd_t,reserved_port_t,tcp_socket,name_bind


# Update semanage context.

[root@server ~]# semanage port -a -t ssh_port_t -p tcp 99
[root@server ~]# semanage port -l |grep ssh
ssh_port_t                     tcp      99, 22


-TCPWrappers 

Makes use of /etc/hosts.allow and /etc/hosts.deny ( allow consulted first by tcpd)

[root@server etc]# vi hosts.deny
[root@server etc]# tcpdmatch -d sshd hosts.deny
client:   address  198.105.244.228
server:   process  sshd
access:   denied

client:   address  198.105.254.228
server:   process  sshd
access:   denied

--To enable IPTables disable firwalld and install iptables-service.

[root@lab125a ~]# systemctl disable firewalld
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.
Removed symlink /etc/systemd/system/basic.target.wants/firewalld.service.

[root@lab125a ~]# systemctl enable iptables
Failed to execute operation: Access denied


[root@lab125a yum.repos.d]# yum install iptables-services -y

[root@lab125a yum.repos.d]# systemctl enable iptables
Created symlink from /etc/systemd/system/basic.target.wants/iptables.service to /usr/lib/systemd/system/iptables.service.
[root@lab125a yum.repos.d]# systemctl start iptables
[root@lab125a yum.repos.d]# systemctl status iptables
● iptables.service - IPv4 firewall with iptables
   Loaded: loaded (/usr/lib/systemd/system/iptables.service; enabled; vendor preset: disabled)
   Active: active (exited) since Fri 2017-10-06 14:32:16 CDT; 3s ago
  Process: 3096 ExecStart=/usr/libexec/iptables/iptables.init start (code=exited, status=0/SUCCESS)
 Main PID: 3096 (code=exited, status=0/SUCCESS)

Oct 06 14:32:16 lab125a systemd[1]: Starting IPv4 firewall with iptables...
Oct 06 14:32:16 lab125a iptables.init[3096]: iptables: Applying firewall rules: [  OK  ]
Oct 06 14:32:16 lab125a systemd[1]: Started IPv4 firewall with iptables.


--Rich rules are the ones with greater level of control. Firewalld has the ability to pass security rules
directly through iptables using direct interface mode but rules arent persistent. rich language rules come in
place to address this problem.

man firewalld.richlanguage

example:
firewall-cmd --zone=public --add-rich-rule="rule family="ipv4" source address="192.168.2.0/24" log prefix="ftp_firewalld" level="info" accept"

--Temporary rule that expires in 24 hours

  [root@lab125a zones]# firewall-cmd --add-rich-rule 'rule family="ipv4" source address="192.168.130.0/24" service name="telnet" log prefix="telnet blocked:" level="info" reject' --timeout="86400" --zone myzone
success


--Change context type of /etc/shadow

[root@server ~]# ls -lZ /etc/shadow
----------. root root system_u:object_r:shadow_t:s0    /etc/shadow

[root@server ~]# chcon -t public_content_t /etc/shadow

[root@server ~]# ls -lZ /etc/shadow
----------. root root system_u:object_r:public_content_t:s0 /etc/shadow

--Try to change the password

[root@server ~]# passwd user3
Changing password for user user3.
New password:
BAD PASSWORD: The password is shorter than 8 characters
Retype new password:
passwd: Authentication token manipulation error

--Check logs..

systemctl status auditd states it's running. So instead of rsyslogd sending messages to /var/log/messages auditd would be sending it to audit.log


type=AVC msg=audit(1501520443.317:502): avc:  denied  { read } for  pid=3069 comm="unix_chkpwd" name="shadow" dev="dm-0" ino=16970057 scontext=unconfined_u:unconfined_r:chkpwd_t:s0-s0:c0.c1023 tcontext=system_u:object_r:public_content_t:s0 tclass=file
type=SYSCALL msg=audit(1501520443.317:502): arch=c000003e syscall=2 success=no exit=-13 a0=7f3e393350b3 a1=80000 a2=1b6 a3=24 items=0 ppid=3068 pid=3069 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=(none) ses=1 comm="unix_chkpwd" exe="/usr/sbin/unix_chkpwd" subj=unconfined_u:unconfined_r:chkpwd_t:s0-s0:c0.c1023 key=(null)

type=AVC msg=audit(1501520449.941:504): avc:  denied  { read } for  pid=3068 comm="passwd" name="shadow" dev="dm-0" ino=16970057 scontext=unconfined_u:unconfined_r:passwd_t:s0-s0:c0.c1023 tcontext=system_u:object_r:public_content_t:s0 tclass=file
type=SYSCALL msg=audit(1501520449.941:504): arch=c000003e syscall=2 success=no exit=-13 a0=7f1c854832d4 a1=0 a2=1 a3=7f1c8d23bc8c items=0 ppid=2550 pid=3068 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts2 ses=1 comm="passwd" exe="/usr/bin/passwd" subj=unconfined_u:unconfined_r:passwd_t:s0-s0:c0.c1023 key=(null)


--Check the selinux 

[root@server ~]# sestatus
SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   enforcing
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Max kernel policy version:      28

--It's enforcing, let's temporarily set the context types to permissive

[root@server ~]# semanage permissive -a chkpwd_t
[root@server ~]# semanage permissive -a passwd_t
[root@server ~]# semanage permissive -l

--Customized Permissive Types

chkpwd_t
httpd_t
passwd_t

-Retry password change

[root@server ~]# passwd user3
Changing password for user user3.
New password:
BAD PASSWORD: The password is shorter than 8 characters
Retype new password:
passwd: all authentication tokens updated successfully.

-Password change worked, although avc_denied re-appers since permissive allows access bug logs the denials.


--Backout policy changes 

[root@server ~]# semanage permissive -d chkpwd_t
libsemanage.semanage_direct_remove_key: Removing last permissive_chkpwd_t module (no other permissive_chkpwd_t module exists at another priority).
[root@server ~]# semanage permissive -d passwd_t
libsemanage.semanage_direct_remove_key: Removing last permissive_passwd_t module (no other permissive_passwd_t module exists at another priority).


--What happens on context preservation

a) IF file is copied over on same directory or different directory the context will be switched to the destination file's attributes.

b) If a file is copied to a new directory as a new file - the context of the destination directory is preserved.

c) If a file is moved to same or different directory the user attribute (subject) will be changed to unconfined_u

d) For tar archives use --selinux opttion to preserve contexts


[root@server ~]# ls -ldZ /usr/bin/
dr-xr-xr-x. root root system_u:object_r:bin_t:s0       /usr/bin/

[root@server ~]# ls -ldZ /usr/etc/
drwxr-xr-x. root root system_u:object_r:etc_t:s0       /usr/etc/

[root@server ~]# cd /usr/bin/

[root@server bin]# touch afile
[root@server bin]# ls -lZ afile
-rw-r--r--. root root unconfined_u:object_r:bin_t:s0   afile

[root@server bin]# cp afile ../etc/
[root@server bin]# cd ../etc/

[root@server etc]# ls -lZ afile
-rw-r--r--. root root unconfined_u:object_r:etc_t:s0   afile
-rw-r--r--. root root unconfined_u:object_r:etc_t:s0   ../etc/afile

[root@server bin]# cp afile ../etc/ --preserve=context
cp: overwrite ‘../etc/afile’? y
[root@server bin]# ls -lZ ../etc/afile
-rw-r--r--. root root unconfined_u:object_r:bin_t:s0   ../etc/afile

[root@server bin]# ls -lZ zcat.test
-rwxr-xr-x. root root system_u:object_r:bin_t:s0       zcat.test

[root@server bin]# ls -lZ zcat.test
-rwxr-xr-x. root root unconfined_u:object_r:bin_t:s0   zcat.test

--To set booleans 

setsebool 
sestatus -b


root@panchajanya:/var/ftp\> ls -Z vnetiso.xml
-rw-r--r--. root root unconfined_u:object_r:unlabeled_t:s0 vnetiso.xml

root@panchajanya:/var/ftp\> chcon -t public_content_t vnetiso.xml
root@panchajanya:/var/ftp\> ls -Z vnetiso.xml
-rw-r--r--. root root unconfined_u:object_r:public_content_t:s0 vnetiso.xml

#Adding a user
[root@server bin]# semanage login -a -s user_u user4
[root@server bin]# semanage login -l

Login Name           SELinux User         MLS/MCS Range        Service

__default__          unconfined_u         s0-s0:c0.c1023       *
root                 unconfined_u         s0-s0:c0.c1023       *
system_u             system_u             s0-s0:c0.c1023       *
user4                user_u               s0                   *
user5                staff_u              s0-s0:c0.c1023       *

#change default selinux login context
 
[root@server bin]# semanage login -m -S targeted -s staff_u __default__
[root@server bin]# semanage login -l

Login Name           SELinux User         MLS/MCS Range        Service

__default__          staff_u              s0-s0:c0.c1023       *
root                 unconfined_u         s0-s0:c0.c1023       *
system_u             system_u             s0-s0:c0.c1023       *
user4                user_u               s0                   *
user5                staff_u              s0-s0:c0.c1023       *

[root@server bin]# semanage login -m -S targeted -r s0:c0 -s staff_u __default__


[root@server bin]# semanage login -l

Login Name           SELinux User         MLS/MCS Range        Service$
se$


__default__          staff_u              s0:c0                *
root                 unconfined_u         s0-s0:c0.c1023       *
system_u             system_u             s0-s0:c0.c1023       *
user4                user_u               s0                   *
user5                staff_u              s0-s0:c0.c1023       *



--Add persistent context for a file
[root@server ~]# semanage fcontext -a  -S targeted -s user_u -t public_content_t /root/afile

[root@server ~]# cat /etc/selinux/targeted/contexts/files/file_contexts.local | grep afile
/root/afile    user_u:object_r:public_content_t:s0

[root@server ~]# ls -Zd /root/
dr-xr-x---. root root system_u:object_r:admin_home_t:s0 /root/
[root@server ~]# chcon -u user_u -t var_run_t /root
[root@server ~]# ls -Zd /root/
dr-xr-x---. root root user_u:object_r:var_run_t:s0     /root/

[root@server ~]# restorecon -Fv /root/
restorecon reset /root context user_u:object_r:var_run_t:s0->system_u:object_r:admin_home_t:s0
[root@server ~]# ls -Zd /root/
dr-xr-x---. root root system_u:object_r:admin_home_t:s0 /root/

[root@server ~]# semanage port -a -t http_port_t -p tcp 8010
[root@server ~]# semanage port -l |grep http_port_t
http_port_t                    tcp      8010, 80, 81, 443, 488, 8008, 8009, 8443, 9000
pegasus_http_port_t            tcp      5988
[root@server ~]# semanage port -d -t http_Port_t -p tcp 8010
[root@server ~]# semanage port -l |grep http_port_t
http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000
pegasus_http_port_t            tcp      5988

--Quick Reference
https://wiki.centos.org/HowTos/SELinux
https://wiki.gentoo.org/wiki/SELinux/Users_and_logins
 

--Add User/login example.
semanage user --add -r s0:c0 -R "auditadm_r sysadm_r" auditor_u
semanage login --add -s auditor_u phil
    

[root@server phil]# semanage permissive -a httpd_t
[root@server phil]# seinfo --permissive

Permissive Types: 7
   httpd_t
   blkmapd_t
   hsqldb_t
   ipmievd_t
   sanlk_resetd_t
   systemd_hwdb_t
   targetd_t

--Triaging a SEALERT

-Error message.
type=AVC msg=audit(1218128130.653:334): avc:  denied  { connectto } for  pid=9111 comm="smtpd" path="/var/spool/postfix/postgrey/socket"
scontext=system_u:system_r:postfix_smtpd_t:s0 tcontext=system_u:system_r:initrc_t:s0 tclass=unix_stream_socket

--Check the scontext, which is postfix_smtpd_t
semanage permissive -a postfix_smtpd_t

Watch the audit logs to see what postfix_smtpd_t needs to be allowed to do in order to succesfully operate. Once we're finished we can put that type back into enforcing mode:


--Allow apache to listen on port 81
semanage port -a -t http_port_t -p tcp 81 
    
semanage permissive -d postfix_smtpd_t
This approach doesn't suffer from the heavy-handedness of setenforce 0 and allows all other services on the system to keep benefiting from the access controls of SELinux.


    
Set correct SELInux port 

yum whatprovides semanage
yum whatprovides seinfo

[root@lab125a ~]# seinfo -t  |grep syslogd |grep port
   syslogd_port_t

[root@lab125a ~]# semanage port -l | grep syslogd
syslogd_port_t                 tcp      601
syslogd_port_t                 udp      514, 601

[root@lab125a ~]# semanage port -m -t syslogd_port_t -p tcp 514


[root@lab125a ~]# semanage port -l | grep syslogd
syslogd_port_t                 tcp      514, 601
syslogd_port_t                 udp      514, 601


#Accessing a resource.

[root@server1 ~]# cd /var/www/html/
[root@server1 html]# ls -lZ *
-rw-r--r--. root root unconfined_u:object_r:httpd_sys_content_t:s0 index.html


[root@server1 html]# ps -eZ |grep httpd
system_u:system_r:httpd_t:s0     4266 ?        00:00:00 httpd
system_u:system_r:httpd_t:s0     4267 ?        00:00:00 httpd


[root@server1 ~]# sesearch --allow --source httpd_t --target httpd_sys_content_t --class dir
Found 16 semantic av rules:
   allow httpd_t httpd_sys_content_t : dir { ioctl read getattr lock search open } ;
   
[root@server1 html]# chcon -t var_t index.html
[root@server1 html]# ls -lZ index.html
-rw-r--r--. root root unconfined_u:object_r:var_t:s0   index.html

[root@server1 ~]# curl -s http://localhost/index.html
..
<p>You don't have permission to access /index.html
..

-In audit log
type=AVC msg=audit(1508807842.331:542): avc:  denied  { getattr } for  pid=4270 comm="httpd" path="/var/www/html/index.html" dev="dm-0" ino=137566 
scontext=system_u:system_r:httpd_t:s0 tcontext=unconfined_u:object_r:var_t:s0 tclass=file
type=SYSCALL msg=audit(1508807842.331:542): arch=c000003e syscall=6 success=no exit=-13 
a0=7fc5ba752c08 a1=7ffffad80a30 a2=7ffffad80a30 a3=ffffffe0 items=0 ppid=4266 pid=4270 auid=4294967295 uid=48 gid=48 euid=48 
suid=48 fsuid=48 egid=48 sgid=48 fsgid=48 tty=(none) ses=4294967295 comm="httpd" exe="/usr/sbin/httpd" subj=system_u:system_r:httpd_t:s0 key=(null)

-Temporarily reset to permissive for triaging
[root@server1 ~]# semanage permissive -a httpd_t
[root@server1 ~]# semanage permissive -l

Customized Permissive Types

httpd_t

Builtin Permissive Types

sanlk_resetd_t
hsqldb_t
systemd_hwdb_t
blkmapd_t
ipmievd_t
targetd_t

[root@server1 ~]# curl -s http://localhost/index.html
Hello this is from server1.intercloudzone.com

-Scan the audit.log

sealert -a /var/log/audit/audit.log

...
If you want to fix the label.
/var/www/html/index.html default label should be httpd_sys_content_t.
Then you can run restorecon.
Do
# /sbin/restorecon -v /var/www/html/index.html
  
...

[root@server1 html]# restorecon -vR index.html
restorecon reset /var/www/html/index.html context unconfined_u:object_r:var_t:s0->unconfined_u:object_r:httpd_sys_content_t:s0

--Context Inheritance for Files and Directories
SELinux enforces something we can term as "context inheritance". What this means is that unless specified by the policy, processes and files are created with the contexts of their parents.

This inheritance is not preserved when files are copied to another location. In a copy operation, the copied file or directory will assume the type context of the target location.

-- Changing the fcontext 

[root@server1 ~]# ls -lZ /www/html/
-rw-r--r--. root root unconfined_u:object_r:default_t:s0 index.html


[root@server1 ~]# curl -s http://localhost/index.html
...
<p>You don't have permission to access /index.html
..


[root@server1 html]# matchpathcon -V index.html
index.html has context unconfined_u:object_r:var_t:s0, should be system_u:object_r:httpd_sys_content_t:s0


[root@server1 ~]# matchpathcon -V /www/html/index.html
/www/html/index.html verified.

Reference 
https://www.digitalocean.com/community/tutorials/an-introduction-to-selinux-on-centos-7-part-2-files-and-processes#how-processes-access-resources

time->Tue Oct 24 17:35:24 2017
type=SYSCALL msg=audit(1508884524.050:482): arch=c000003e syscall=6 success=no exit=-13 a0=7f248c01fbf0 a1=7ffd21904f00 a2=7ffd21904f00 a3=7ffd21904c80 items=0 ppid=3385 pid=3391 auid=4294967295 uid=48 gid=48 euid=48 suid=48 fsuid=48 egid=48 sgid=48 fsgid=48 tty=(none) ses=4294967295 comm="httpd" exe="/usr/sbin/httpd" subj=system_u:system_r:httpd_t:s0 key=(null)
type=AVC msg=audit(1508884524.050:482): avc:  denied  { getattr } for  pid=3391 comm="httpd" path="/www/html/index.html" dev="dm-0" ino=136145 scontext=system_u:system_r:httpd_t:s0 tcontext=unconfined_u:object_r:default_t:s0 tclass=file
[root@server1 ~]# ausearch -m avc -c httpd


</pre>

</div>
  
  


<div class="w3-container">
  <h1><span class="mw-headline" id="KICKSTART"> Kickstart </h1> 
<p>

</p>

<pre> 




virt-install -n rhce1 --memory 1024 --vcpus 1 --os-variant rhel7 --disk vol=virspd01/rhce1.img --network network=default --location ftp://192.168.2.20/pub/rhel74 --extra-args ks=ftp://192.168.2.20/pub/ksconfig/rhce1.cfg



root@mayura:/var/ftp/pub/ksconfig\> cat rhce1.cfg | grep -v ^# |grep -v ^$
auth --enableshadow --passalgo=sha512
url --url="ftp://192.168.2.21/pub/rhel74"
firstboot --enable
ignoredisk --only-use=vda
keyboard --vckeymap=us --xlayouts='us'
lang en_US.UTF-8
reboot
network  --bootproto=static --device=eth0 --gateway=192.168.122.1 --ip=192.168.122.10 --netmask=255.255.255.0 --ipv6=auto --activate
network  --hostname=rhce1.intercloudzone.com
services --enabled="chronyd"
rootpw --plaintext oracle
timezone America/Chicago --isUtc
bootloader --location=mbr --boot-drive=vda --append=" console=ttyS0,115200,tty0"
clearpart --all --initlabel --drives=vda
part /boot --fstype="xfs" --ondisk=vda --size=500
part pv.1 --fstype="lvmpv" --ondisk=vda --size=8000
volgroup vgos --pesize=4096 pv.1
logvol /home  --fstype="xfs" --size=1000 --name=home --vgname=vgos
logvol /  --fstype="xfs" --size=4000 --name=root --vgname=vgos
logvol swap  --fstype="swap" --size=500 --name=swap --vgname=vgos
%packages
@^minimal
@core
chrony
kexec-tools
%end
%addon com_redhat_kdump --enable --reserve-mb='auto'
%end
%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end


root@mayura:/var/ftp/pub/ksconfig\> diff rhce1.cfg rhce2.cfg
18,19c18,19
< network  --bootproto=static --device=eth0 --gateway=192.168.122.1 --ip=192.168.122.10 --netmask=255.255.255.0 --ipv6=auto --activate
< network  --hostname=rhce1.intercloudzone.com
---
> network  --bootproto=static --device=eth0 --gateway=192.168.122.1 --ip=192.168.122.20 --netmask=255.255.255.0 --ipv6=auto --activate
> network  --hostname=rhce2.intercloudzone.com



--Two interfaces with console
virt-install --name "server1" --memory=1024 --disk vol=virspd00/server1.img --vcpus=1 --os-variant=rhel7 --os-type=linux --location=ftp://192.168.2.20/pub/rhel7 --network bridge=virbr1 --network bridge=virbr1 -x "ks=ftp://192.168.2.20/pub/ksconfig/server1.cfg console=ttyS0,115200,tty0"

--How to configure 4 interfaces, all on DHCP. Note that there is NO 'network' specific configuration in the ks.cfg.All the IP's were configured as eth0, eth1, eth2, eth3 - with dynamic IP's

virsh # vol-create-as virpool0 server10.img 8G
Vol server10.img created

virt-install --name=server10 --ram=1024 --vcpus=1 --autostart --os-type=linux --os-variant=rhel7 --location=ftp://192.168.2.11/pub/rhel7 --network bridge=br_fe --network bridge=virbr0 --network bridge=virbr1 --network bridge=virbr2 --disk vol=virpool0/server10.img --extra-args ks=ftp://192.168.2.11/pub/rhel7/ks.cfg

--Configure STATIC ip address for the bridges configured via libvirt and br_fe bridge on the physical net is connected to the netgear router on the 192.168.2.0/24 subnet which is always dhcp.

root@panchajanya:/var/ftp/pub/rhel7\> grep network ks.cfg
# Use network installation
network --device=eth0 --bootproto=dhcp --ipv6=auto --activate
network --device=eth1 --bootproto=dhcp --ipv6=auto --activate
network --device=eth2 --bootproto=static --ip=192.168.125.10 --netmask=255.255.255.0 --ipv6=auto --activate
network --device=eth3 --bootproto=static --ip=192.168.130.10 --netmask=255.255.255.0 --ipv6=auto --activate
network  --hostname=server10
 


</pre>

</div>

  
  
<div class="w3-container">
  <h1><span class="mw-headline" id="DHCP"> DHCP </h1> 
<p>
DHCP addresses can be converted to static ones by editing the net files   
</p>

<pre> 
root@panchajanya:/etc/libvirt/qemu\> virsh dumpxml server3  | grep -A1 mac
&lt;partition&gt;/machine&lt;/partition&gt;
&lt;/resource&gt;
--
    &lt;type arch='x86_64' machine='pc-i440fx-rhel7.0.0'&gt;hvm&lt;/type&gt;
    &lt;boot dev='hd'/&gt;
--
      &lt;mac address='52:54:00:66:0f:5c'/&gt;
      &lt;source bridge='br_fe'/&gt;
--
      &lt;mac address='52:54:00:92:75:f2'/&gt;
      &lt;source network='default' bridge='virbr0'/&gt;
--
      &lt;mac address='52:54:00:d4:23:62'/&gt;
      &lt;source network='mvirnet0' bridge='mvirbr0'/&gt;

&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;b4b845ef-b92c-411e-9b62-e4bec3160a21&lt;/uuid&gt;
  &lt;forward mode='nat'/&gt;
  &lt;bridge name='virbr0' stp='on' delay='0'/&gt;
  &lt;mac address='52:54:00:5c:45:35'/&gt;
  &lt;ip address='192.168.122.1' netmask='255.255.255.0'&gt;
    &lt;dhcp&gt;
      &lt;range start='192.168.122.2' end='192.168.122.254'/&gt;
      &lt;host mac='52:54:00:66:ab:13' name='server2' ip='192.168.122.3'/&gt;
      &lt;host mac='52:54:00:92:75:f2' name='server3' ip='192.168.122.4'/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;



root@panchajanya:/etc/libvirt/qemu\> virsh net-destroy mvirnet0
Network mvirnet0 destroyed

root@panchajanya:/etc/libvirt/qemu\> virsh net-destroy default
Network default destroyed

root@panchajanya:/etc/libvirt/qemu\> virsh shutdown server3
Domain server3 is being shutdown

root@panchajanya:/etc/libvirt/qemu\> virsh net-start default
Network default started

root@panchajanya:/etc/libvirt/qemu\> virsh net-start mvirnet0
Network mvirnet0 started

        
&lt;network&gt;
  &lt;name&gt;mvirnet0&lt;/name&gt;
  &lt;uuid&gt;f8d83856-2c18-4688-a128-679bbf9937ce&lt;/uuid&gt;
  &lt;forward mode='nat'&gt;
    &lt;nat&gt;
      &lt;port start='1024' end='65535'/&gt;
    &lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge name='mvirbr0' stp='on' delay='0'/&gt;
  &lt;mac address='52:54:00:fd:63:7f'/&gt;
  &lt;ip address='192.168.123.1' netmask='255.255.255.0'&gt;
    &lt;dhcp&gt;
      &lt;range start='192.168.123.2' end='192.168.123.254'/&gt;
      &lt;host mac='52:54:00:d4:23:62' name='server3' ip='192.168.123.4'/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;

=> Create two VM's with two different networks.

virsh # vol-create-as vspd2 lab125a.img 13G
virsh # vol-create-as vspd2 lab130a.img 13G



virt-install --name lab125a --memory 1024 --vcpus=1 --disk vol=vspd2/lab125a.img --os-type=linux --os-variant=rhel7 --location=ftp://192.168.2.11/pub/rhel7 --network bridge=br_fe --network network=virnet1 --extra-args ks=ftp://192.168.2.11/pub/ksconfig/lab125a.cfg

virt-install --name lab130a --memory 1024 --vcpus=1 --disk vol=vspd2/lab130a.img --os-type=linux --os-variant=rhel7 --location=ftp://192.168.2.11/pub/rhel7 --network bridge=br_fe --network network=virnet2 --extra-args ks=ftp://192.168.2.11/pub/ksconfig/lab130a.cfg

</pre>

</div>
  
  
<div class="w3-container">
  <h1><span class="mw-headline" id="INTERFACES"> Interfaces </h1>
  
<p>

</p>

  
<pre> 
[root@server ~]# nmcli d show eth3
GENERAL.DEVICE:                         eth3
GENERAL.TYPE:                           ethernet
GENERAL.HWADDR:                         52:54:00:82:2F:44     ==> MAC we are interested in..
....

virsh # domiflist server
Interface  Type       Source     Model       MAC
-------------------------------------------------------
vnet0      bridge     br_fe      virtio      52:54:00:2c:19:87
vnet1      network    vnetnat    virtio      52:54:00:4b:a2:98
vnet2      network    vnetrou    virtio      52:54:00:f1:15:ef
vnet3      network    vnetiso    virtio      52:54:00:82:2f:44

=> From server

13: vbriso: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000
    link/ether 52:54:00:ec:60:6e brd ff:ff:ff:ff:ff:ff
    inet 192.168.132.1/24 brd 192.168.132.255 scope global vbriso
       valid_lft forever preferred_lft forever

14: vbriso-nic: <BROADCAST,MULTICAST> mtu 1500 qdisc pfifo_fast master vbriso state DOWN qlen 1000
    link/ether 52:54:00:ec:60:6e brd ff:ff:ff:ff:ff:ff


[root@server network-scripts]# cat ifcfg-eth3
# Generated by parse-kickstart
UUID=a9dac657-c4ff-4296-a570-65bf15e54da8
IPV6_AUTOCONF=yes
BOOTPROTO=none
DEVICE=eth3
ONBOOT=yes
IPV6INIT=yes
TYPE=Ethernet
IPADDR=192.168.132.50
PREFIX=24
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6_DEFROUTE=yes
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes
IPV6_FAILURE_FATAL=no
NAME="System eth3"

=> Detach and attach interfaces

virsh # detach-interface --domain server --type network --mac 52:54:00:82:2f:44 --persistent
Interface detached successfully

root@panchajanya:~\> virsh dumpxml server | egrep 'source network'
      <source network='vnetnat' bridge='vbrnat'/>
      <source network='vnetrou' bridge='vbrrou'/>

virsh # attach-interface --domain server --type network --source vnetiso --model virtio --mac 52:54:00:82:2f:44 --persistent --live
Interface attached successfully


root@panchajanya:~\> virsh dumpxml server | egrep 'source network'
      <source network='vnetnat' bridge='vbrnat'/>
      <source network='vnetrou' bridge='vbrrou'/>
      <source network='vnetiso' bridge='vbriso'/>


#Remove file ifcfg-eth3, once interface is added it will show up and running on the server 

# Recreate the file via nmcli

[root@server network-scripts]# nmcli con add type ethernet con-name eth3 ifname eth3
Connection 'eth3' (116655f8-71c3-4063-9a11-1fbafef00296) successfully added.


[root@server network-scripts]# ls -l ifcfg-eth3
-rw-r--r--. 1 root root 274 Aug  7 16:53 ifcfg-eth3

[root@server network-scripts]# nmcli con delete eth3
Connection 'eth3' (f816ae72-a947-4eb2-be7f-f434a121f18f) successfully deleted.


[root@server network-scripts]# nmcli con add type ethernet con-name eth3 ifname eth3 ip4 192.168.132.50/24
Connection 'eth3' (ce3bf3c8-f3b2-42d0-ab94-7c8771d335bd) successfully added.

[root@server network-scripts]# cat ifcfg-eth3
TYPE=Ethernet
BOOTPROTO=none
IPADDR=192.168.132.50
PREFIX=24
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes
IPV6_FAILURE_FATAL=no
NAME=eth3
UUID=ce3bf3c8-f3b2-42d0-ab94-7c8771d335bd
DEVICE=eth3
ONBOOT=yes


[root@server network-scripts]# nmcli con add type ethernet con-name eth3 ifname eth3
Connection 'eth3' (f816ae72-a947-4eb2-be7f-f434a121f18f) successfully added.

[root@server network-scripts]# nmcli con load $(pwd)/ifcfg-eth3
 
[root@server network-scripts]# nmcli general logging
LEVEL  DOMAINS INFO   PLATFORM,RFKILL,ETHER,WIFI,BT,MB,DHCP4,DHCP6,PPP,IP4,IP6,AUTOIP4,DNS,VPN,SHARING,
SUPPLICANT,AGENTS, SETTINGS,SUSPEND,CORE,DEVICE,OLPC,WIMAX,INFINIBAND,FIREWALL,ADSL,
BOND,VLAN,BRIDGE,TEAM,CONCHECK,DCB,DISPATCH


[root@server network-scripts]# nmcli con delete a9dac657-c4ff-4296-a570-65bf15e54da8
Connection 'System eth3' (a9dac657-c4ff-4296-a570-65bf15e54da8) successfully deleted.

[root@server network-scripts]# nmcli dev
DEVICE  TYPE      STATE         CONNECTION
eth0    ethernet  connected     System eth0
eth1    ethernet  connected     System eth1
eth2    ethernet  connected     System eth2
eth3    ethernet  disconnected  --



# Delete the interface..
[root@server network-scripts]# nmcli con down a9dac657-c4ff-4296-a570-65bf15e54da8
 
[root@server network-scripts]# nmcli con delete a9dac657-c4ff-4296-a570-65bf15e54da8


# Re-added the interface as eth4 instead of eth3, hence removing it again.

virsh # attach-interface --domain server --type network --source vnetnat --model virtio --mac 52:54:00:82:2f:44 --persistent --live
Interface attached successfully

7: eth3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:82:2f:44 brd ff:ff:ff:ff:ff:ff
8: eth4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:82:2f:44 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.188/24 brd 192.168.134.255 scope global dynamic eth4
       valid_lft 3471sec preferred_lft 3471sec
    inet6 fe80::5054:ff:fe82:2f44/64 scope link
       valid_lft forever preferred_lft forever


virsh # detach-interface --domain server --type network --mac 52:54:00:82:2f:44 --persistent
error: Domain has multiple interfaces matching MAC address 52:54:00:82:2f:44. You must use detach-device and specify the device pci address to remove it.

#if two devices are mapped with same mac, to remove 
 
    <interface type='network'>
      <mac address='52:54:00:82:2f:44'/>
      <source network='vnetnat' bridge='vbrnat'/>
      <target dev='eth4'/>
      <model type='virtio'/>
      <alias name='net6'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x13' function='0x0'/>
    </interface>
 
root@panchajanya:~\> virsh dumpxml server | egrep -A7  "interface type"

virsh # attach-interface --domain server --type network --source vnetnat --model virtio --mac 52:54:00:82:2f:44 --persistent --live eth3
Interface attached successfully

virsh # attach-interface --domain server --type network --source vnetnat --model virtio --mac 52:54:00:82:2f:44 --persistent --live eth4
Interface attached successfully


virsh dumpxml server | egrep -A7  "interface type"


Note: Always do persistent

root@panchajanya:~\> virsh detach-device server remove.xml --persistent
Device detached successfully

root@panchajanya:~\> cat remove.xml
<interface type='network'>
      <mac address='52:54:00:82:2f:44'/>
      <source network='vnetnat' bridge='vbrnat'/>
      <target dev='eth4'/>
      <model type='virtio'/>
      <alias name='net6'/>
      <address type='pci' domain='0x0000' bus='0x00' slot='0x13' function='0x0'/>
    </interface>


#Change it to a different network 
virsh # attach-interface --domain server --type network --source vnetnat --model virtio --mac 52:54:00:82:2f:44 --persistent --live eth3
Interface attached successfully


[root@server network-scripts]# nmcli con show
NAME                UUID                                  TYPE            DEVICE
System eth1         dbfe8c4c-abc6-4a98-b953-d8475dd2217d  802-3-ethernet  eth1
System eth2         260c99eb-2a00-44b5-a3d6-e731d936a3b4  802-3-ethernet  eth2
Wired connection 1  2463dcd8-dca0-478e-9843-81c23a2de560  802-3-ethernet  eth3
System eth0         b6870dc4-b183-4bdd-b310-6d789c3e9ce0  802-3-ethernet  eth0



[root@server network-scripts]# nmcli dev connect eth3
Device 'eth3' successfully activated with '2463dcd8-dca0-478e-9843-81c23a2de560'.


=> vnet3 is usinv vnetiso , for bonding experiment switch it to vnetnat prior


virsh # detach-interface --persistent server --mac 52:54:00:82:2f:44 --type network

virsh # attach-interface server --source vnetnat  --type network --target vnet3 --mac 52:54:00:82:2f:44 --model virtio --persistent --live
Interface attached successfully



=> Change the IP address to static : 192.168.134.51

3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:4b:a2:98 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.50/24 brd 192.168.134.255 scope global eth1
       valid_lft forever preferred_lft forever


7: eth3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:82:2f:44 brd ff:ff:ff:ff:ff:ff
    inet 192.168.134.188/24 brd 192.168.134.255 scope global dynamic eth3


=> Option-1
  root@panchajanya:~\> virsh net-edit vnetnat, append below line
    <host mac='52:54:00:82:2f:44' ip='192.168.134.51' />

  Network vnetnat XML configuration not changed.

=> Option-2

root@panchajanya:~\> virsh net-update vnetnat add ip-dhcp-host '<host mac="52:54:00:82:2f:44" ip="192.168.134.51" />' --live --config
Updated network vnetnat persistent config and live state


root@panchajanya:~\> virsh net-dumpxml vnetnat
<network>
  <name>vnetnat</name>
  <uuid>f1ab3ba4-18a7-412f-8904-daa4e1d65526</uuid>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <bridge name='vbrnat' stp='on' delay='0'/>
  <mac address='52:54:00:a0:e1:86'/>
  <ip address='192.168.134.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.134.2' end='192.168.134.254'/>
      <host mac='52:54:00:82:2f:44' ip='192.168.134.51'/>
    </dhcp>
  </ip>
</network>


#Ways to find the IP address of hte VM running


virsh # domiflist lab11
Interface  Type       Source     Model       MAC
-------------------------------------------------------
vnet4      bridge     br_fe      virtio      52:54:00:86:73:f2
vnet5      network    vnetnat    virtio      52:54:00:57:e4:ff
vnet6      network    vnetrou    virtio      52:54:00:a0:8e:2e
vnet7      network    vnetiso    virtio      52:54:00:ba:e7:ce


domifaddr lab11 - isn't returning anything (BUG ) - so going for fallback option

# Try to get access to console 
virsh console lab11 

#Doesn't work until the console access is enabled. Enable via kpartx


root@panchajanya:~\> virsh domblklist lab11
Target     Source
------------------------------------------------
vda        /data/sdd01/vspd1/lab11.img

root@panchajanya:~\> kpartx -av /data/sdd01/vspd1/lab11.img
add map loop0p1 (253:14): 0 1048576 linear /dev/loop0 2048
add map loop0p2 (253:15): 0 20971520 linear /dev/loop0 1050624
add map loop0p3 (253:16): 0 1048576 linear /dev/loop0 22022144


root@panchajanya:~\> mount /dev/mapper/loop0p1 /mnt/
root@panchajanya:~\> cd /mnt/
root@panchajanya:/mnt\> ls
config-3.10.0-327.el7.x86_64                             initrd-plymouth.img
grub                                                     symvers-3.10.0-327.el7.x86_64.gz
grub2                                                    System.map-3.10.0-327.el7.x86_64
initramfs-0-rescue-d88dc0e9818b405383649087000b224a.img  vmlinuz-0-rescue-d88dc0e9818b405383649087000b224a
initramfs-3.10.0-327.el7.x86_64.img                      vmlinuz-3.10.0-327.el7.x86_64
initramfs-3.10.0-327.el7.x86_64kdump.img

root@panchajanya:/mnt\> vi grub2/grub.cfg

root@panchajanya:/mnt\> grep console grub2/grub.cfg
terminal_output console
  linux16 /vmlinuz-3.10.0-327.el7.x86_64 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet LANG=en_US.UTF-8 console=ttyS0

umount /dev/mapper/loop0p1
kpartx -dv /data/sdd01/vspd1/lab11.img



#Option 2, once logged into the server

--Example-1: Update all kernels with same arguments
grubby --update-kernel=ALL --args=console=ttyS0,115200

--Example-2: Remove args,add args - update kernel
grubby --remove-args="rhgb quiet" --args=console=ttyS0,115200 --update-kernel /boot/vmlinuz-4.2.0-1.fc23.x86_64


[root@lab11 ~]# grubby --help |grep kernel |grep update
                                      new arguments for kernel being updated
                                      kernel being updated
  --update-kernel=kernel-path         updated information for the specified


[root@lab11 ~]# grubby --default-kernel
/boot/vmlinuz-3.10.0-327.el7.x86_64
[root@lab11 ~]# grubby --default-index
0
[root@lab11 ~]# grubby --info=ALL
index=0
kernel=/boot/vmlinuz-3.10.0-327.el7.x86_64
args="ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet LANG=en_US.UTF-8 console=ttyS0"
root=/dev/mapper/vgos-lvroot
initrd=/boot/initramfs-3.10.0-327.el7.x86_64.img
title=CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)
index=1
kernel=/boot/vmlinuz-0-rescue-d88dc0e9818b405383649087000b224a
args="ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet"
root=/dev/mapper/vgos-lvroot
initrd=/boot/initramfs-0-rescue-d88dc0e9818b405383649087000b224a.img
title=CentOS Linux (0-rescue-d88dc0e9818b405383649087000b224a) 7 (Core)
index=2
non linux entry


[root@lab11 ~]# grep linux16 /etc/grub2.cfg
  linux16 /vmlinuz-3.10.0-327.el7.x86_64 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet LANG=en_US.UTF-8 console=ttyS0
  linux16 /vmlinuz-0-rescue-d88dc0e9818b405383649087000b224a root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet

[root@lab11 ~]# grubby --remove-args="console=ttys0" --update-kernel=/boot/vmlinuz-3.10.0-327.el7.x86_64
[root@lab11 ~]# grep linux16 /etc/grub2.cfg
  linux16 /vmlinuz-3.10.0-327.el7.x86_64 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet LANG=en_US.UTF-8
  linux16 /vmlinuz-0-rescue-d88dc0e9818b405383649087000b224a root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet

[root@lab11 ~]# grubby --update-kernel=/boot/vmlinuz-3.10.0-327.el7.x86_64 --args="console=ttyS0 console=tty0 console=ttyS0,115200"
[root@lab11 ~]# grep linux16 /boot/grub2/grub.cfg
  linux16 /vmlinuz-3.10.0-327.el7.x86_64 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet LANG=en_US.UTF-8 console=ttyS0 console=tty0 console=ttyS0,115200
  linux16 /vmlinuz-0-rescue-d88dc0e9818b405383649087000b224a root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet

#Option-3

[root@lab11 default]# grep CMD grub
GRUB_CMDLINE_LINUX="crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet console=ttyS0 console=tty0 console=ttyS0,115200 "

[root@lab11 default]# grep linux16 /boot/grub2/grub.cfg
  linux16 /vmlinuz-3.10.0-327.el7.x86_64 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet
  linux16 /vmlinuz-0-rescue-d88dc0e9818b405383649087000b224a root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet

[root@lab11 default]# grub2-mkconfig -o /boot/grub2/grub.cfg
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-3.10.0-327.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-327.el7.x86_64.img
Found linux image: /boot/vmlinuz-0-rescue-d88dc0e9818b405383649087000b224a
Found initrd image: /boot/initramfs-0-rescue-d88dc0e9818b405383649087000b224a.img
done

[root@lab11 default]# grep linux16 /boot/grub2/grub.cfg
  linux16 /vmlinuz-3.10.0-327.el7.x86_64 root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet console=ttyS0 console=tty0 console=ttyS0,115200
  linux16 /vmlinuz-0-rescue-d88dc0e9818b405383649087000b224a root=/dev/mapper/vgos-lvroot ro crashkernel=auto rd.lvm.lv=vgos/lvroot rhgb quiet console=ttyS0 console=tty0 console=ttyS0,115200  

</pre>

</div>
  
  


<div class="w3-container">
  <h1><span class="mw-headline" id="STORAGE"> Storage </h1> 
<p>

</p>

<pre> 


--Create Directory Pool 
root@mayura:/var/ftp/pub/ksconfig\> virsh pool-define-as --name="vpoolsdd02" --type=dir --target=/data/sdd02
Pool vpoolsdd02 defined

root@mayura:/var/ftp/pub/ksconfig\> virsh pool-start vpoolsdd02
Pool vpoolsdd02 started

root@mayura:/var/ftp/pub/ksconfig\> virsh pool-list --all
 Name                 State      Autostart
-------------------------------------------
 default              active     yes
 u01                  inactive   yes
 virpool0             active     yes
 virpool1             active     yes
 vpoolsdd02           active     no

root@mayura:/var/ftp/pub/ksconfig\> virsh pool-autostart vpoolsdd02
Pool vpoolsdd02 marked as autostarted
                                                                            
root@mayura:/var/ftp/pub/ksconfig\> virsh vol-create-as vpoolsdd02 rhce_hdd0.img 10G
Vol rhce_hdd0.img created
                                                                                                             

root@mayura:/var/ftp/pub/ksconfig\> virsh vol-create-as vpoolsdd02 rhce_hdd0.img 10G
Vol rhce_hdd0.img created

root@mayura:/var/ftp/pub/ksconfig\> virt-install --name=rhce --ram=1024 --vcpus=1 --autostart --os-type=linux --os-variant=rhel7 --location=ftp://192.168.2.21/pub/rhel7 --network bridge=br_fe --network bridge=virbr0 --network bridge=virbr1 --network bridge=virbr2 --disk vol=vpoolsdd02/rhce_hdd0.img --extra-args ks=ftp://192.168.2.21/pub/ksconfig/rhce.cfg
WARNING  Graphics requested but DISPLAY is not set. Not running virt-viewer.
WARNING  No console to launch for the guest, defaulting to --wait -1


                  
virsh # pool-define-as --name="virpool0" --type=dir --target=/data/sdd00/
Pool virpool0 defined

virsh # pool-start virpool0
Pool virpool0 started

virsh # pool-dumpxml virpool0
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;pool type=&quot;dir&quot;&gt;
   &lt;name&gt;virpool0&lt;/name&gt;
   &lt;uuid&gt;7da5a3d1-1b95-4ec2-9585-ebcfa22deaac&lt;/uuid&gt;
   &lt;capacity unit=&quot;bytes&quot;&gt;52710309888&lt;/capacity&gt;
   &lt;allocation unit=&quot;bytes&quot;&gt;54550528&lt;/allocation&gt;
   &lt;available unit=&quot;bytes&quot;&gt;52655759360&lt;/available&gt;
   &lt;source /&gt;
   &lt;target&gt;
      &lt;path&gt;/data/sdd00&lt;/path&gt;
      &lt;permissions&gt;
         &lt;mode&gt;0755&lt;/mode&gt;
         &lt;owner&gt;0&lt;/owner&gt;
         &lt;group&gt;0&lt;/group&gt;
         &lt;label&gt;system_u:object_r:unlabeled_t:s0&lt;/label&gt;
      &lt;/permissions&gt;
   &lt;/target&gt;
&lt;/pool&gt;

--Create Volume Group pool

virsh # pool-define-as --name virpool50 --type logical --target /dev/vgdatae --source-name vgdatae --source-format lvm2
Pool virpool50 defined

virsh # pool-start virpool50
Pool virpool50 started

virsh # vol-create-as --pool virpool50 --name lvdatae00 --capacity 25G --allocation 10G
Vol lvdatae00 created

root@panchajanya:/etc/libvirt/storage\> cat virpool50.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;pool type=&quot;dir&quot;&gt;
   &lt;name&gt;virpool0&lt;/name&gt;
   &lt;uuid&gt;7da5a3d1-1b95-4ec2-9585-ebcfa22deaac&lt;/uuid&gt;
   &lt;capacity unit=&quot;bytes&quot;&gt;52710309888&lt;/capacity&gt;
   &lt;allocation unit=&quot;bytes&quot;&gt;54550528&lt;/allocation&gt;
   &lt;available unit=&quot;bytes&quot;&gt;52655759360&lt;/available&gt;
   &lt;source /&gt;
   &lt;target&gt;
      &lt;path&gt;/data/sdd00&lt;/path&gt;
      &lt;permissions&gt;
         &lt;mode&gt;0755&lt;/mode&gt;
         &lt;owner&gt;0&lt;/owner&gt;
         &lt;group&gt;0&lt;/group&gt;
         &lt;label&gt;system_u:object_r:unlabeled_t:s0&lt;/label&gt;
      &lt;/permissions&gt;
   &lt;/target&gt;
&lt;/pool&gt;


virsh # vol-create-as --pool mdatad03 --name lvdatad04 --capacity 9G --allocation 1G
Vol lvdatad04 created

root@panchajanya:/etc/libvirt/storage\> lvs
LV        VG      Attr       LSize  Pool Origin              Data%  Meta%  Move Log Cpy%Sync Convert
..
lvdatad02 vgdatad -wi-ao---- 50.00g
lvdatad03 vgdatad -wi-ao---- 50.00g
lvdatae00 vgdatae swi-a-s--- 10.00g      [lvdatae00_vorigin] 0.00

virsh # vol-dumpxml --pool virpool50 lvdatae00
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;pool type=&quot;dir&quot;&gt;
   &lt;name&gt;virpool0&lt;/name&gt;
   &lt;uuid&gt;7da5a3d1-1b95-4ec2-9585-ebcfa22deaac&lt;/uuid&gt;
   &lt;capacity unit=&quot;bytes&quot;&gt;52710309888&lt;/capacity&gt;
   &lt;allocation unit=&quot;bytes&quot;&gt;54550528&lt;/allocation&gt;
   &lt;available unit=&quot;bytes&quot;&gt;52655759360&lt;/available&gt;
   &lt;source /&gt;
   &lt;target&gt;
      &lt;path&gt;/data/sdd00&lt;/path&gt;
      &lt;permissions&gt;
         &lt;mode&gt;0755&lt;/mode&gt;
         &lt;owner&gt;0&lt;/owner&gt;
         &lt;group&gt;0&lt;/group&gt;
         &lt;label&gt;system_u:object_r:unlabeled_t:s0&lt;/label&gt;
      &lt;/permissions&gt;
   &lt;/target&gt;
&lt;/pool&gt;


--
root@mayura:/data/sdd00\> virsh attach-disk server10 --source /data/sdd00/server10-sdb.img --target vdb --persistent --live
Disk attached successfully



</pre>

</div>



<div class="w3-container">
  <h1><span class="mw-headline" id="VNET"> VNET </h1>
<p>

     
</p>


<pre> 

--Add a virtual network interface

virsh # net-define /data/sdc01/rhsa/stage/virnet1.xml
Network virnet1 defined from /data/sdc01/rhsa/stage/virnet1.xml

virsh # net-list --all
Name                 State      Autostart     Persistent
----------------------------------------------------------
default              active     yes           yes
virnet1              inactive   no            yes

virsh # net-start virnet1
Network virnet1 started

virsh # net-define /data/sdc01/rhsa/stage/virnet2.xml
Network virnet2 defined from /data/sdc01/rhsa/stage/virnet2.xml

virsh # net-start virnet2
Network virnet2 started

virsh # net-list --all
Name                 State      Autostart     Persistent
----------------------------------------------------------
default              active     yes           yes
virnet1              active     no            yes
virnet2              active     no            yes


root@panchajanya:/data/sdc01/rhsa/stage\> cat virnet1.xml
&lt;network&gt;
  &lt;name&gt;virnet1&lt;/name&gt;
  &lt;forward mode=&apos;nat&apos;&gt;
    &lt;nat&gt;&lt;port start=&apos;1024&apos; end=&apos;65535&apos;/&gt;&lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge name=&apos;virbr1&apos; stp=&apos;on&apos; delay=&apos;0&apos;/&gt;
  &lt;ip address=&apos;192.168.125.1&apos; netmask=&apos;255.255.255.0&apos;&gt;
    &lt;dhcp&gt; &lt;range start=&apos;192.168.125.2&apos; end=&apos;192.168.125.254&apos;/&gt;&lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;

root@panchajanya:/data/sdc01/rhsa/stage\> cat virnet2.xml
&lt;network&gt;
  &lt;name&gt;virnet2&lt;/name&gt;
  &lt;forward mode=&apos;nat&apos;&gt;
    &lt;nat&gt;&lt;port start=&apos;1024&apos; end=&apos;65535&apos;/&gt;&lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge name=&apos;virbr2&apos; stp=&apos;on&apos; delay=&apos;0&apos;/&gt;
  &lt;ip address=&apos;192.168.130.1&apos; netmask=&apos;255.255.255.0&apos;&gt;
    &lt;dhcp&gt; &lt;range start=&apos;192.168.130.2&apos; end=&apos;192.168.130.254&apos;/&gt;&lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;

root@panchajanya:/data/sdc01/rhsa/stage\> brctl show
bridge name bridge id   STP enabled interfaces
br_fe   8000.001fbc020167 no    enp8s0
virbr0    8000.5254005c4535 yes   virbr0-nic
virbr1    8000.525400d1bdd6 yes   virbr1-nic
virbr2    8000.525400b5c764 yes   virbr2-nic

--Update network (live)

https://wiki.libvirt.org/page/Networking#NAT_forwarding_.28aka_.22virtual_networks.22.29
net-update live


#Before

&lt;network&gt;
  &lt;name&gt;virnet2&lt;/name&gt;
  &lt;uuid&gt;3faf7664-46f9-49fa-938c-654d257dfe44&lt;/uuid&gt;
  &lt;forward mode=&apos;nat&apos;&gt;
    &lt;nat&gt;
      &lt;port start=&apos;1024&apos; end=&apos;65535&apos;/&gt;
    &lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge name=&apos;virbr2&apos; stp=&apos;on&apos; delay=&apos;0&apos;/&gt;
  &lt;mac address=&apos;52:54:00:10:66:8e&apos;/&gt;
  &lt;ip address=&apos;192.168.230.1&apos; netmask=&apos;255.255.255.0&apos;&gt;
    &lt;dhcp&gt;
      &lt;range start=&apos;192.168.230.2&apos; end=&apos;192.168.230.254&apos;/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;



#Update live
virsh net-update virnet2 add ip-dhcp-host "<host mac='52:54:00:5c:dc:c3' name='server10' ip='192.168.230.11' />" --live --config

#After
&lt;network&gt;
  &lt;name&gt;virnet2&lt;/name&gt;
  &lt;uuid&gt;3faf7664-46f9-49fa-938c-654d257dfe44&lt;/uuid&gt;
  &lt;forward mode=&apos;nat&apos;&gt;
    &lt;nat&gt;
      &lt;port start=&apos;1024&apos; end=&apos;65535&apos;/&gt;
    &lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge name=&apos;virbr2&apos; stp=&apos;on&apos; delay=&apos;0&apos;/&gt;
  &lt;mac address=&apos;52:54:00:10:66:8e&apos;/&gt;
  &lt;ip address=&apos;192.168.230.1&apos; netmask=&apos;255.255.255.0&apos;&gt;
    &lt;dhcp&gt;
      &lt;range start=&apos;192.168.230.2&apos; end=&apos;192.168.230.254&apos;/&gt;
      &lt;host mac=&apos;52:54:00:5c:dc:c3&apos; name=&apos;server10&apos; ip=&apos;192.168.230.11&apos;/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;


root@mayura:~\> virsh net-update virnet2 delete ip-dhcp-host "<host mac='52:54:00:5c:dc:c3' name='server10' ip='192.168.230.11' />" --live --config
Updated network virnet2 persistent config and live state


virsh # attach-interface --domain lab125a --type network --source vnetrou --model virtio --persistent --live
Interface attached successfully



[root@lab125a network-scripts]# nmcli con add type ethernet con-name eth2 ifname eth2 ip4 192.168.133.10/24
Connection 'eth2' (95fc4e46-552b-44da-941a-74b6f9c6b33b) successfully added.



[root@lab125a network-scripts]# ls -ltr ifcfg-eth2
-rw-r--r--. 1 root root 279 Aug 21 10:05 ifcfg-eth2
[root@lab125a network-scripts]# cat ifcfg-eth2
TYPE=Ethernet
BOOTPROTO=none
IPADDR=192.168.133.10
PREFIX=24
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes
IPV6_FAILURE_FATAL=no
NAME=eth2
UUID=95fc4e46-552b-44da-941a-74b6f9c6b33b
DEVICE=eth2
ONBOOT=yes


[root@lab125a network-scripts]# ip addr show eth2
4: eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:35:b1:cd brd ff:ff:ff:ff:ff:ff
    inet 192.168.133.227/24 brd 192.168.133.255 scope global dynamic eth2

    [root@lab125a network-scripts]# nmcli con show
NAME                UUID                                  TYPE            DEVICE
Wired connection 1  9ca6cb23-dcf5-44b6-a93d-70040727aa6c  802-3-ethernet  eth2
System eth0         8ee556e1-20f7-4637-8e2e-1eeb03010504  802-3-ethernet  eth0
System eth1         f204d5f4-a485-4b9e-822d-d596ce99940d  802-3-ethernet  eth1
eth2                95fc4e46-552b-44da-941a-74b6f9c6b33b  802-3-ethernet  --


virsh net-update vnetrou add ip-dhcp-host "<host mac='52:54:00:35:b1:cd' name='lab125a' ip='192.168.133.10' /> " --live --config


--Exammple (Decoding/Escaping XML for display)
root@mayura:/data/sdd02\> perl -p -e 'BEGIN { use CGI qw(escapeHTML); } $_ = escapeHTML($_); ' virnet3.xml
&lt;network&gt;
&lt;name&gt;virnet3&lt;/name&gt;
&lt;bridge name=&quot;virbr3&quot;&gt;&lt;/bridge&gt;
&lt;forward mode=&quot;nat&quot;&gt;&lt;/forward&gt;
&lt;ip address=&quot;192.168.125.1&quot; netmask=&quot;255.255.255.0&quot;&gt;
  &lt;dhcp&gt;
    &lt;range start=&quot;192.168.125.10&quot; end=&quot;192.168.125.254&quot;&gt;&lt;/range&gt;
  &lt;/dhcp&gt;
&lt;/ip&gt;
&lt;/network&gt;



--Example: attacing network interface

virsh # attach-interface --domain lab130a --type network --source vnetrou --model virtio --persistent --config
Interface attached successfully

[root@lab130a network-scripts]# ip addr show eth2
4: eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 52:54:00:40:5d:67 brd ff:ff:ff:ff:ff:ff
    
root@panchajanya:~\> virsh dumpxml lab130a | xpath "//interface[2]"
Found 1 nodes:
-- NODE --
<interface type="network">
      <mac address="52:54:00:77:03:6f" />
      <source network="virnet2" bridge="virbr2" />
      <target dev="vnet4" />
      <model type="virtio" />
      <alias name="net1" />
      <address type="pci" domain="0x0000" bus="0x00" slot="0x04" function="0x0" />
    </interface>

virsh # net-update vnetrou add ip-dhcp-host "<host name='lab130a' mac='52:54:00:77:03:6f' ip='192.168.133.11' />"  --live --config
Updated network vnetrou persistent config and live state

virsh # net-dumpxml vnetrou
<network>
  <name>vnetrou</name>
  <uuid>c51060e5-77cc-4756-8d5c-01a041b5c52c</uuid>
  <forward mode='route'/>
  <bridge name='vbrrou' stp='on' delay='0'/>
  <mac address='52:54:00:47:0a:a3'/>
  <ip address='192.168.133.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.133.2' end='192.168.133.254'/>
      <host mac='52:54:00:35:b1:cd' name='lab125a' ip='192.168.133.10'/>
      <host mac='52:54:00:77:03:6f' name='lab130a' ip='192.168.133.11'/>
    </dhcp>
  </ip>
</network>




[root@lab130a network-scripts]# nmcli con down b1ecc890-55bd-4b21-b920-7c5a0bb73c0e
Connection 'Wired connection 1' successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/2)

 [root@lab130a network-scripts]# nmcli con add con-name eth2 ifname eth2 type ethernet ip4 192.168.133.11
Connection 'eth2' (9dcc9258-3c3a-4ff0-81dd-eaf4a9aa0315) successfully added.
[root@lab130a network-scripts]# cat ifcfg-eth2
TYPE=Ethernet
BOOTPROTO=none
IPADDR=192.168.133.11
PREFIX=32
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes
IPV6_FAILURE_FATAL=no
NAME=eth2
UUID=9dcc9258-3c3a-4ff0-81dd-eaf4a9aa0315
DEVICE=eth2
ONBOOT=yes


--Find the network interfaces

virsh # net-list --all
 Name                 State      Autostart     Persistent
----------------------------------------------------------
 default              active     yes           yes
 virnet1              active     yes           yes
 virnet2              active     yes           yes
 vnetiso              active     yes           yes
 vnetnat              active     yes           yes
 vnetrou              active     yes           yes


--Find the interface list on the VM itself

virsh # domiflist lab19
Interface  Type       Source     Model       MAC
-------------------------------------------------------
vnet3      bridge     br_fe      virtio      52:54:00:45:56:5e
vnet4      network    vnetnat    virtio      52:54:00:e2:a5:a7
vnet5      network    vnetrou    virtio      52:54:00:4b:23:3e
vnet6      network    vnetiso    virtio      52:54:00:01:bd:9f

--Attach the interface 

virsh # attach-interface lab19 network vnetnat --model virtio --persistent --config --live
Interface attached successfully

--Verify the config file to ensure it's added (persistent)
root@panchajanya:~\> virsh dumpxml lab19 | xpath "//interface"
Found 5 nodes:
-- NODE --

--Print the one that just got added

root@panchajanya:~\> virsh dumpxml lab19 | xpath "//interface[5]"
Found 1 nodes:
-- NODE --
<interface type="network">
      <mac address="52:54:00:0b:26:70" />
      <source network="vnetnat" bridge="vbrnat" />
      <target dev="vnet7" />
      <model type="virtio" />
      <alias name="net4" />
      <address type="pci" domain="0x0000" bus="0x00" slot="0x0c" function="0x0" />
 </interface>
  
--Create the interface configuration file.

[root@lab19 network-scripts]# nmcli con del a1204c59-b274-4e1f-9fd5-f4082a04d6d2
Connection 'Wired connection 1' (a1204c59-b274-4e1f-9fd5-f4082a04d6d2) successfully deleted.


nmcli con add type ethernet con-name eth4  ifname eth4 autoconnect yes save yes ip4 192.168.134.54 gw4 192.168.2.1
Connection 'eth4' (0f9192f1-b16d-4aaa-85be-07b8ebd2c6a8) successfully added

systemctl reboot

</pre>  

<div class="w3-container">
  <h1><span class="mw-headline" id="LDAP"> ldap </h1>
  
<p>

</p>

  
<pre> 
yum install openldap openldap-clients nss-pam-ldapd sssd authconfig authconfig-gtk


 [root@lab11 conf.d]# authconfig --enableldap --enableldapauth --ldapserver=ldap://server --enablesssd --ldapbasedn="dc=example,dc=com" --update

 [root@lab11 sssd]# grep -v ^# /etc/openldap/ldap.conf
 
TLS_CACERTDIR /etc/openldap/cacerts

SASL_NOCANON  on
URI ldap://server
BASE dc=example,dc=com

# https://www.certdepot.net/rhel7-configure-ldap-directory-service-user-connection/ 
https://www.lisenet.com/2016/ldap-and-kerberos-client-authentication-on-rhel-7-using-sssd/

Configuration
Open the file /etc/sysconfig/authconfig and ensure the following are set:

USESSSDAUTH=yes
FORCELEGACY=no
USESSSD=yes

-Set in /etc/sssd/sssd.conf ( Note: Refer man page  sssd-ldap )

ldap_tls_reqcert = never


#Server setup
yum install -y openldap openldap-clients openldap-servers migrationtools

#Generate ldap password from a secret key.

[root@server ~]# slappasswd -s redhat -n  > /etc/openldap/passwd
[root@server ~]# cat /etc/openldap/passwd
{SSHA}yB19hMMrLO+O2wPaIl3ZXk5qqjL8zaRb


#Generate a self-signed cert 

[root@server ~]# openssl req -new -x509 -nodes -out /etc/openldap/certs/cert.pem -keyout  /etc/openldap/certs/priv.pem -days 365
Generating a 2048 bit RSA private key
.......................................+++
...............+++
writing new private key to '/etc/openldap/certs/priv.pem'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:us
State or Province Name (full name) []:texas
Locality Name (eg, city) [Default City]:round rock
Organization Name (eg, company) [Default Company Ltd]:intercloudzone.com
Organizational Unit Name (eg, section) []:dba
Common Name (eg, your name or your server's hostname) []:server.intercloudzone.com



#Secure the contents 

[root@server certs]# chown ldap:ldap *
[root@server certs]# chmod 600 priv.pem
[root@server certs]# pwd
/etc/openldap/certs


#Prepare the database
[root@server certs]# cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG

#Generate database files.

[root@server certs]# slaptest
59822d10 hdb_db_open: database "dc=my-domain,dc=com": db_open(/var/lib/ldap/id2entry.bdb) failed: No such file or directory (2).
59822d10 backend_startup_one (type=hdb, suffix="dc=my-domain,dc=com"): bi_db_open failed! (2)
slap_startup failed (test would succeed using the -u switch)


[root@server certs]# chown ldap:ldap /var/lib/ldap/*

#Enable and start slapd

[root@server certs]# systemctl enable slapd
Created symlink from /etc/systemd/system/multi-user.target.wants/slapd.service to /usr/lib/systemd/system/slapd.service.
[root@server certs]# systemctl start slapd
[root@server certs]# systemctl status slapd



[root@server certs]# netstat -lt |grep ldap
tcp        0      0 0.0.0.0:ldap            0.0.0.0:*               LISTEN
tcp6       0      0 [::]:ldap               [::]:*                  LISTEN

## Ss another tool to investigate sockets

[root@server certs]# ss -ltap | grep ldap
LISTEN     0      128        *:ldap                     *:*                     users:(("slapd",pid=2828,fd=8))
LISTEN     0      128       :::ldap                    :::*                     users:(("slapd",pid=2828,fd=9))



#To start the configuration of the LDAP server, add the cosine & nis LDAP schemas:


cd /etc/openldap/schema/


[root@server schema]# ldapadd -Y EXTERNAL -H ldapi:/// -D "cn=config" -f cosine.ldif
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
adding new entry "cn=cosine,cn=schema,cn=config"
 
[root@server schema]# ldapadd -Y EXTERNAL -H ldapi:/// -D "cn=config" -f nis.ldif
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
adding new entry "cn=nis,cn=schema,cn=config"


#Create changes.ldif file

[root@server schema]# cat /etc/openldap/changes.ldif
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=intercloudzone,dc=com

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=Manager,dc=intercloudzone,dc=com

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: {SSHA}yB19hMMrLO+O2wPaIl3ZXk5qqjL8zaRb

dn: cn=config
changetype: modify
replace: olcTLSCertificateFile
olcTLSCertificateFile: /etc/openldap/certs/cert.pem

dn: cn=config
changetype: modify
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/openldap/certs/priv.pem

dn: cn=config
changetype: modify
replace: olcLogLevel
olcLogLevel: -1

dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" read by dn.base="cn=Manager,dc=intercloudzone,dc=com" read by * none

#Send changes to LDAP DB

[root@server schema]# ldapmodify -Y EXTERNAL -H ldapi:/// -f /etc/openldap/changes.ldif
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "olcDatabase={2}hdb,cn=config"

modifying entry "olcDatabase={2}hdb,cn=config"

modifying entry "olcDatabase={2}hdb,cn=config"

modifying entry "cn=config"

modifying entry "cn=config"

modifying entry "cn=config"

modifying entry "olcDatabase={1}monitor,cn=config"


#Create base ldif file

[root@server schema]# cat /etc/openldap/base.ldif
dn: dc=intercloudzone,dc=com
dc: intercloudzone
objectClass: top
objectClass: domain

dn: ou=People,dc=intercloudzone,dc=com
ou: People
objectClass: top
objectClass: organizationalUnit

dn: ou=Group,dc=intercloudzone,dc=com
ou: Group
objectClass: top
objectClass: organizationalUnit

#Create base directory structure in ldap

[root@server schema]# ldapadd -x -w redhat -D cn=Manager,dc=intercloudzone,dc=com -f /etc/openldap/base.ldif
adding new entry "dc=intercloudzone,dc=com"

adding new entry "ou=People,dc=intercloudzone,dc=com"

adding new entry "ou=Group,dc=intercloudzone,dc=com"

#Create two users for testing

[root@server schema]# mkdir /home/guests
[root@server schema]# useradd -d /home/guests/ldapuser01 ldapuser01
[root@server schema]# useradd -d /home/guests/ldapuser02 ldapuser02


[root@server migrationtools]# egrep '^\$DEFAULT_BASE|^\$DEFAULT_MAIL_DOMAIN' migrate_common.ph
$DEFAULT_MAIL_DOMAIN = "intercloudzone.com";
$DEFAULT_BASE = "dc=intercloudzone,dc=com";


#Migrate users to ldap

[root@server migrationtools]# grep ":10[0-9][0-9]" /etc/passwd > passwd
[root@server migrationtools]# ./migrate_passwd.pl passwd users.ldif


[root@server migrationtools]# ldapadd -x -w redhat -D cn=Manager,dc=intercloudzone,dc=com -f users.ldif
adding new entry "uid=kuttu,ou=People,dc=intercloudzone,dc=com"


[root@server migrationtools]# ldapsearch -x cn=ldapuser01 -b dc=intercloudzone,dc=com
# extended LDIF
#
# LDAPv3
# base <dc=intercloudzone,dc=com> with scope subtree
# filter: cn=ldapuser01
# requesting: ALL
#

# ldapuser01, People, intercloudzone.com
dn: uid=ldapuser01,ou=People,dc=intercloudzone,dc=com
uid: ldapuser01
cn: ldapuser01
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword:: e2NyeXB0fSQ2JER5elgwQlMwJDBEUzZJVy9ET1lReG9FRWdQYThrZXhLMmgzSGZ
 BcmxzbTZRQWExTkRiOGo2bzFhWGVVMnBiL3NPN1FyU1IyUzdLTU1uZWxRQ2dzYnpIS0ZCalc3WlYu
shadowLastChange: 17380
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 1012
gidNumber: 1012
homeDirectory: /home/guests/ldapuser01

# search result
search: 2
result: 0 Success

#Migrate groups 

cd /usr/share/migrationtools
cat /etc/group > group
./migrate_group.pl group groups.ldif


[root@server migrationtools]# ldapadd -x -w redhat -D "cn=Manager,dc=intercloudzone,dc=com" -f groups.ldif
adding new entry "cn=root,ou=Group,dc=intercloudzone,dc=com"

-- Generate rsyslog messages
[root@server1 rsyslog.d]# echo "*.debug /var/log/messages-debug" > /etc/rsyslog.d/debug.conf
[root@server1 rsyslog.d]# cat debug.conf
*.debug /var/log/messages-debug
[root@server1 rsyslog.d]# systemctl restart rsyslog
[root@server1 rsyslog.d]# logger -p user.debug "Debug message test"

--Make journals permanent.
[root@server1 html]# systemd-tmpfiles --create --prefix /var/log/journal/
[root@server1 html]# ls -ld /var/log/journal/
drwxr-sr-x+ 2 root systemd-journal 4096 Nov 17 16:58 /var/log/journal/
[root@server1 html]# systemctl restart systemd-journald

[root@server1 html]# ls -ltr /var/log/journal/
total 8
drwxr-xr-x+ 2 root systemd-journal 4096 Nov 17 16:59 d3c8d48d2a8343fbb7674d25dd8da8e0
[root@server1 html]# cat /etc/machine-id
d3c8d48d2a8343fbb7674d25dd8da8e0

#Add service to fw

firewall-cmd --permanent --add-service=ldap


Edit the /etc/rsyslog.conf file and add the following line:

local4.* /var/log/ldap.log

systemctl restart rsyslog


# On the client
authconfig --enableldap --enableldapauth --ldapserver=ldap://server --enablesssd --ldapbasedn="dc=intercloudzone,dc=com" --update

[root@lab11 ~]# getent passwd ldapuser01
ldapuser01:*:1012:1012:ldapuser01:/home/guests/ldapuser01:/bin/bash

[root@lab11 ~]# su - ldapuser01
su: warning: cannot change directory to /home/guests/ldapuser01: No such file or directory
id: cannot find name for group ID 1012

[root@lab11 ~]# authconfig --enablemkhomedir --update
[root@lab11 ~]# su - ldapuser01
Creating directory '/home/guests/ldapuser01'.
Last login: Wed Aug  2 15:50:08 CDT 2017 on pts/0
id: cannot find name for group ID 1012


#On Server - adding a user

[root@server migrationtools]# ldapadd -x -W -D cn=Manager,dc=intercloudzone,dc=com -f babu.ldif
Enter LDAP Password:
adding new entry "uid=babu,ou=People,dc=intercloudzone,dc=com"

[root@server migrationtools]# cat babu.ldif
dn: uid=babu,ou=People,dc=intercloudzone,dc=com
uid: babu
cn: babu
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}$6$/3bu6bR7$kDwUZNT88YMB3dScmfm2xEHYLLKYA9O.O3MJi1jMQDSg7asebqtoPGoio2LV.2ZkfZguwWoVamjbk2meNgPqN1
shadowLastChange: 17380
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 1013
gidNumber: 1013
homeDirectory: /home/guests/babu


#USER ADD

[root@server migrationtools]# ldapadd -x -w redhat -D "cn=Manager,dc=intercloudzone,dc=com" -f radha.ldif
adding new entry "uid=radha,ou=People,dc=intercloudzone,dc=com"


[root@lab11 ~]# su - radha
Creating directory '/home/guests/radha'.
id: cannot find name for group ID 2000


Adding OpenLDAP POSIX groups


[root@server migrationtools]# cat radha-group.ldif
dn: cn=radha,ou=Group,dc=intercloudzone,dc=com
objectClass: top
objectClass: posixGroup
cn: radha
userPassword: {crypt}$6$/3bu6bR7$kDwUZNT88YMB3dScmfm2xEHYLLKYA9O.O3MJi1jMQDSg7asebqtoPGoio2LV.2ZkfZguwWoVamjbk2meNgPqN1
gidNumber: 2000


[root@server migrationtools]# ldapadd -x -w redhat -D "cn=Manager,dc=intercloudzone,dc=com" -f radha-group.ldif
adding new entry "cn=radha,ou=Group,dc=intercloudzone,dc=com"


[root@lab11 ~]# su - radha
Last login: Wed Aug  2 16:54:53 CDT 2017 on pts/0


https://techhelplist.com/index.php/tech-tutorials/34-openldap/48-user-management-in-openldap

#Change Password

[root@lab11 ~]# ldappasswd -x -D "cn=Manager,dc=intercloudzone,dc=com" -w redhat "uid=radha,ou=People,dc=intercloudzone,dc=com"
New password: OQMBvAHI
[root@lab11 ~]# ldappasswd -x -D "cn=Manager,dc=intercloudzone,dc=com" -w redhat "uid=radha,ou=People,dc=intercloudzone,dc=com" -s radha

[root@lab11 ~]# ldapsearch -x -D "cn=Manager,dc=intercloudzone,dc=com" -w redhat -s sub "cn=*radha*"
# extended LDIF
#
# LDAPv3



#Search every entry
[root@lab11 ~]# ldapsearch -x -D "cn=Manager,dc=intercloudzone,dc=com" -w redhat -s sub "objectclass=*"

#Display only dn
ldapsearch -x -D "cn=Manager,dc=intercloudzone,dc=com" -w redhat -s sub "objectclass=*" dn

#Change admin password

[root@server cn=config]# grep ldapadm olcDatabase\=\{2\}hdb.ldif
olcRootDN: cn=ldapadm,dc=intercloudzone,dc=com
[root@server cn=config]# pwd
/etc/openldap/slapd.d/cn=config

[root@lab11 ~]# ldapsearch -x -D "cn=ldapadm,dc=intercloudzone,dc=com" -w redhat -s sub "objectclass=*" dn



</pre>

</div>




<div class="w3-container">
  <h1><span class="mw-headline" id="GENERIC"> Generic </h1> 
<p>

</p>

<pre> 

--Histformat

export HISTTIMEFORMAT="%d/%m/%y %T "
export PS1='\u@\h:\w\> '


set -o vi
shopt -s histappend
PROMPT_COMMAND='history -a'
export HISTCONTROL=ignoredups:erasedups
export HISTIGNORE="pwd:ls:ls -ltr:"
export HISTSIZE=900000

-Terminal vs Shell
Terminal converts keys into control sequences (e.g. Left → \e[D). 
The shell converts control sequences into commands (e.g. \e[D → backward-char).

--Run simple HTTP Server for testing
python -m SimpleHTTPServer 8000

--Debug SSHD
 /usr/sbin/sshd -d -p99
 
--How to install selinux specific man pages

yum install -y selinux-policy-devel -y
sepolicy booleans # Gives details of all boolean variables.
sepolicy network  $ Gives details of all context domains for network.


sepolicy manpage -a -p /usr/share/man/man8
mandb

--Debug NFS
automountd -f d

--Notes
resize2fs vs xfs_grow is former uses the device and later uses the mountpoint.

--Example of flushing IP addresses on multiple interfaces
ip addr flush label "eth*"

-Disable ICMP's

[root@rhce5 network-scripts]# sysctl -w net.ipv4.icmp_echo_ignore_all=1
net.ipv4.icmp_echo_ignore_all = 1

[root@rhce5 network-scripts]# cat /proc/sys/net/ipv4/icmp_echo_ignore_all
1

[root@rhce5 network-scripts]# sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1
net.ipv4.icmp_echo_ignore_broadcasts=1


--Static Route

Static route configuration can be stored per-interface in a /etc/sysconfig/network-scripts/route-interface file.

For example, static routes for the eth0 interface would be stored in the /etc/sysconfig/network-scripts/route-eth0 
[root@rhce5 network-scripts]# cat route-eth0
ADDRESS0=192.168.125.0
NETMASK0=255.255.255.0
GATEWAY0=192.168.122.1


[root@rhce5 network-scripts]# ip -6 addr show eth0
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 state UP qlen 1000
    inet6 2001:db8:7a::50/64 scope global noprefixroute
       valid_lft forever preferred_lft forever
    inet6 fe80::3b8:ce7c:2c4c:d8b8/64 scope link noprefixroute
       valid_lft forever preferred_lft forever

[root@rhce5 network-scripts]# ping6 -I eth0 2001:db8:7a::50
PING 2001:db8:7a::50(2001:db8:7a::50) from 2001:db8:7a::50 eth0: 56 data bytes
64 bytes from 2001:db8:7a::50: icmp_seq=1 ttl=64 time=0.064 ms
^C
--- 2001:db8:7a::50 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.064/0.064/0.064/0.000 ms

--Add permanent static routes 
nmcli ipv4> set routes 192.168.130.0/24 192.168.122.1


--Useful commands..
pinfo (instead of info)

yum list * - doc* ( Softwares providing doc as a separate package)

&> file (Combines stdout and stderr to one file)

>> file 2>&1 (Sends stderr to stdout through a pipe )

userdel -r ( always run with -r )

--IF userdel -r not used, the UID/GID is re-used for the future users..
find / -nouser -o -nogroup 2>/dev/null

usermod -aG newgroup ( without -a , the existing groups will be removed)

nlogin will prevent only interactive use of the system, does not prevent upload/retrieve logs via applications, ftp's etc.
/etc/login.defs has all login default parameters

Divide the load-average with number of logical CPU's ( grep "model name" /proc/cpuinfo )
top - z (Color) , C (Absoulte Path), x (Highlight Sorted column), b (Highlight Sorted Column ),
u (User filter),P ( Sort by CPU),M (Sort by Memory),m (Memory bar),
 V (Forest Mode), O (%MEM > 1, %CPU >1 etc.), "=" to clear all filters, save this with W

--List all groups from the variant file (Under RepoPackage)
cat variant.xml | xpath comps/environment/grouplist/groupid

--systemd-tmpfiles 

When systemd starts a system, one of the first service units launched is systemd-tmpfiles-setup. This service runs the command
systemd-tmpfiles --create --remove. 
This command reads configuration files from /usr/lib/tmpfiles.d/*.conf, /run/tmpfiles.d/*.conf and
/etc/tmpfiles.d/*.conf


[root@server1 demo]# cat /etc/tmpfiles.d/demo.conf
d /var/run/demo 0700 root root 5s

[root@server1 tmpfiles.d]# cd /var/run/demo/

[root@server1 demo]# touch afile bfile

[root@server1 demo]# ls -ltr
total 0
-rw-rw-r--. 1 root root 0 Nov 29 16:37 bfile
-rw-rw-r--. 1 root root 0 Nov 29 16:37 afile

[root@server1 demo]# systemd-tmpfiles --clean /etc/tmpfiles.d/demo.conf

[root@server1 demo]# ls -ltr
total 0

[root@server1 demo]# cat /etc/tmpfiles.d/demo.conf
d /var/run/demo 0700 root root 5s

-Suspend User
pkill -STOP -u vivek
pkill -CONT -u vivek

--Commands to find the terminals

[root@lab125a ~]# tty
/dev/ttyS0

--Run who -a
[root@lab125a ~]# who -a
           system boot  2017-09-22 09:58
LOGIN      tty1         2017-09-22 09:58               637 id=tty1
root     + ttyS0        2017-09-22 10:03   .           638
           run-level 3  2017-09-22 09:58
root     + pts/0        2017-09-22 10:00 00:01        2527 (192.168.125.1)

--Better than who, is what - w
[root@lab125a ~]# w
 11:28:51 up  1:30,  2 users,  load average: 0.01, 0.02, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
root     ttyS0                     10:03    2:35   0.28s  0.28s -bash
root     pts/0    192.168.125.1    10:46    3.00s  0.03s  0.02s w

--Sent message to terminal
#console terminal
[root@lab125a ~]# echo &quot;test&quot; > /dev/ttyS0   
[root@lab125a ~]# echo &quot;You will be kicked out soon &quot; | write root pts/0

#pts terminal
[root@lab125a ~]# tty
/dev/pts/0
[root@lab125a ~]# echo &quot;test&quot; > /dev/pts/0
test

--Reset the size of the console/terminal
virsh console lab125a

[root@lab125a ~]# stty rows 80 columns 120
[root@lab125a ~]# echo "This is to test the line-folds wont happen on a console after stty reset " | write root pts/0

--Commands to display screen-size/options
stty size
tputs columns

--Save the current command using CTRL+E , run new and use CTRL+Y to bring back the old one back..

[root@lab125a ~]# echo "This is a test "^C
CTRL+E  => Gives a new line to execute the command
ls -lr  => Run that command
CTRL+Y  => Puts back the previous command which is "echo"


--rpm
rpm -qi (Information on an installed package)
rpm -ql (List files of an installed package)
rpm -q --whatrequires iproute ( What packages require iproute inorder for them to operate properly).

--Lost file /etc/ntp.conf
root@panchajanya:/tmp\> rpm -q --whatprovides /etc/ntp.conf
ntp-4.2.6p5-22.el7.centos.x86_64

root@panchajanya:/tmp\> rpm -qf /etc/ntp.conf
ntp-4.2.6p5-22.el7.centos.x86_64

--rpm2cpio, cpio -id => i = extract files, d= create directories

root@panchajanya:/tmp/extract\> ls -ltr
total 544
-r--r--r--. 1 root root 556104 Sep 28 12:13 ntp-4.2.6p5-22.el7.centos.x86_64.rpm

root@panchajanya:/tmp/extract\> rpm2cpio ntp-4.2.6p5-22.el7.centos.x86_64.rpm | cpio -id
2812 blocks

root@panchajanya:/tmp/extract\> ls -ltr
total 544
-r--r--r--. 1 root root 556104 Sep 28 12:13 ntp-4.2.6p5-22.el7.centos.x86_64.rpm
drwxr-xr-x. 5 root root     58 Sep 28 12:16 etc
drwxr-xr-x. 6 root root     49 Sep 28 12:16 usr
drwxr-xr-x. 4 root root     26 Sep 28 12:16 var

--Verify signature
root@panchajanya:/tmp/extract\> rpm -K --nosignature ntp-4.2.6p5-22.el7.centos.x86_64.rpm
ntp-4.2.6p5-22.el7.centos.x86_64.rpm: sha1 md5 OK

-- PKI files
/etc/pki/rpm-gpg

--Verify if the package is altered.
root@panchajanya:/tmp/extract\> rpm -Vv ntp-4.2.6p5-22.el7.centos.x86_64
.........    /etc/dhcp/dhclient.d
.........    /etc/dhcp/dhclient.d/ntp.sh
.........  c /etc/ntp.conf
.........    /etc/ntp/crypto
.........  c /etc/ntp/crypto/pw
.........  c /etc/sysconfig/ntpd
.M...UG..    /usr/bin/ntpstat

root@panchajanya:/tmp/extract\> rpm -Vf /usr/bin/ntpstat
.M...UG..    /usr/bin/ntpstat

-- Terminates the shell if there's no activity on specified number of seconds, in /etc/profile.
export TMOUT=120
readonly TMOUT

--PRevent root user login
echo > /etc/securetty, PermitRootLogin no (sshd_config), /sbin/nologin (passwd) and PAM


-- (( double open paranthesis )) for arithmetic, [ square brackets for conditionl expression ], [[ double square paranthesis for regular expressions like =~ ]]

[root@server1 rpm-gpg]# echo $((1+4))
5

[root@server1 rpm-gpg]# [ $(date +%d -d -100days) -le 30 ] && echo "Test passed"
Test passed

[root@server1 rpm-gpg]# if  [[ "xyz" =~ "x" ]]; then echo "True" ; fi
True

--Expressions : == looks for exact string equality vs eq looks for arithmetic equality.

[root@rhce4 ~]#  [ " 1 " == 1 ]  && echo equal || echo not
not

[root@rhce4 ~]#  [ " 1 " -eq 1 ]  && echo equal || echo not
equal


Difference between command and space!
--Logical "AND" implied
pgrep -u root sshd

--Logical &quot;OR&quot; implied
pgrep -u root,sshd

Files (chattr) - Immutable and only can append data.
[root@lab125a ~]# chattr +ai afile
[root@lab125a ~]# lsattr afile
----ia---------- afile

Find command
find / -size -1M (Files smaller than 1MB)
find / -size +1M (Files larger than 1MB)
find / -user root -not group wheel 
find / -mtime +10 (Files modified more than 10 days ago)
find / -mtime 10  (Files modified exactly 10 days ago)
find . -mtime +0 # find files modified greater than 24 hours ago
find . -mtime 0 # find files modified between now and 1 day ago
# (i.e., in the past 24 hours only)
find . -mtime -1 # find files modified less than 1 day ago (SAME AS -mtime 0)
find . -mtime 1 # find files modified between 24 and 48 hours ago
find . -mtime +1 # find files modified more than 48 hours ago

--Nice
Range -20 to +19 (Higher nice, lower execution priority!)

--kill
kill -l lists all signals
pgrep -u apache httpd | xargs kill
killall httpd

--Cron

-cron.deny
By default only cron.deny exists - all users not listed in it are pemitted.

-cron.allow - Takes priority over cron.deny.
* If neither file exist, no users are allowed to run crons only root user can access cron.
/etc/cron.allow takes precedence.


--setuid
rwS = (Executable permission bit not set, this is an error) vs rws (setuid and x set) 

--Find files by reference
touch -d '1 day ago' cutoff

[root@rhcsa1 ~]# ls -ltr
total 8
-rw-------. 1 root root 1504 Nov 22 18:47 anaconda-ks.cfg
-rw-r--r--. 1 root root 2771 Nov 23 18:34 configfiles.txt
-rw-r--r--. 1 root root    0 Nov 25 22:23 cutoff
-rw-r--r--. 1 root root    0 Nov 26 22:23 bfile
[root@rhcsa1 ~]# date
Sun Nov 26 22:24:22 EST 2017

[root@rhcsa1 ~]# find . -newer cutoff
.
./bfile

--Find older files (excluding the cutoff)
[root@rhcsa1 ~]# find . ! -newer cutoff --samefile cutoff
.
./bfile

-- Schedule a cron to execute on first sunday of every month.
  0 2 * * sun  [ $(date +%d) -le 07 ] && /script/script.sh

When you specify */5 in minute field means every 5 minutes.
When you specify 0-10/2 in minute field mean every 2 minutes in the first 10 minute.


-- Generate SHA512 crypt passwords

[root@server1 ~]# python
Python 2.7.5 (default, Nov 20 2015, 02:00:19)
[GCC 4.8.5 20150623 (Red Hat 4.8.5-4)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import crypt
>>> print (crypt.crypt("oracle",crypt.mksalt(crypt.METHOD_SHA512)))
$6$mS0WeRwcJtXUprd8$Gg3PbM/x5yopaBZ57Hk9atr5W/vDdcfr5tegM28XhjNAkxOpl8DyFe17RHJmtpO.7f21v609r6l0nQUwBXmf60
>>>

$6 = SHA512, $5 = SHA256, $1 = MD5 ( Format = $ENCRYPTION $SALT $ENCRYPTED PASSWORD)

[root@server1 ~]# doveadm pw -s SHA512-CRYPT -p oracle
{SHA512-CRYPT}$6$SfFdJ4r.ZiTAqIPj$OXhFnIIJpEU/1.WwSgLv/EOhPtEAbIjm/oFrtHC4ISC4Gn87wQSg9HWtGBsUutQWZCGB5FJrMAkaD/uEuhJsN.

page-out and page-in are called demand paging.
excessive amount of paging that affects performance is called thrashing

--Create swap

[root@server ~]# lvcreate -L 1G -n swapvol vgdata0
WARNING: ext4 signature detected on /dev/vgdata0/swapvol at offset 1080. Wipe it? [y/n]: y
  Wiping ext4 signature on /dev/vgdata0/swapvol.
  Logical volume "swapvol" created.

[root@server ~]# mkswap /dev/vgdata0/swapvol
Setting up swapspace version 1, size = 1048572 KiB
no label, UUID=b4bb1977-2a2d-4d9d-8f91-2eb1efc01156

[root@server ~]# swapon -v /dev/vdb2
swapon /dev/vdb2
swapon: /dev/vdb2: found swap signature: version 1, page-size 4, same byte order
swapon: /dev/vdb2: pagesize=4096, swapsize=1048576, devsize=1048576
[root@server ~]# swapon -v /dev/vgdata0/swapvol
swapon /dev/vgdata0/swapvol
swapon: /dev/mapper/vgdata0-swapvol: found swap signature: version 1, page-size 4, same byte order
swapon: /dev/mapper/vgdata0-swapvol: pagesize=4096, swapsize=1073741824, devsize=1073741824

swapon -s

/dev/device-nodes

#Character(raw) devices are accessed serially - printers, mice, keyboards, terminals, etc and block devices are accessed in parallel via blocks - HDD, optical drives etc.


chattr +i afile # Immutable, can't be deleted, renamed or changed
chattr +a afile # Can only be appended.

Files metadata includes several piece of informaiton, such as files type, size, permissions, owners name, group name, last access/mod time, ACL, link count , bloks and pointers to the location where actual data is stored. This takes 128-byte space in the FS for each file and this tiny storage space is reerred to as inode (index node). inode is assigned a unique
identifier that is used by kernel to access, track and manage the file.

the file name and corresponding inode number is maintained in directories metadata. 

inode doesn't store file name. 

Hardlinked files share same data location and and unlike soft-links cannot cross file system boundaries and link directories.

#umask
default umask is 0022 for root and system users and 0002 for all regular users with a bash shell.

[radha@lab11 ~]$ umask
0002

[radha@lab11 ~]$ umask -S
u=rwx,g=rwx,o=rx

Linux assigns default permissions by using "preset value" -  "umask value"

For files 666 - umask , directories 777 - umask.


#setuid - set's on files. Gives ability for non-owenrs and non-group members the ability to run executables with the privileges of owner.

Find all files in teh system with setuid bit set

[root@server ~]# find / -perm -4000


[radha@lab11 ~]$ ll /usr/bin/su
-rwsr-xr-x. 1 root root 32072 Nov 20  2015 /usr/bin/su
[radha@lab11 ~]$ su - root
Password:
Last login: Thu Aug  3 08:30:04 CDT 2017 from 192.168.134.1 on pts/0
[root@lab11 ~]# chmod u-s /usr/bin/su
[root@lab11 ~]# ll /usr/bin/su
-rwxr-xr-x. 1 root root 32072 Nov 20  2015 /usr/bin/su
[root@lab11 ~]# su - radha
Last login: Thu Aug  3 14:17:44 CDT 2017 on pts/0
[radha@lab11 ~]$ su - root
Password:
su: Authentication failure


#setgid is set at group level

File can be executed by non-owners by exact same privileges that group members have.
[root@server ~]# ll /usr/bin/wall
-r-xr-sr-x. 1 root tty 15344 Jun  9  2014 /usr/bin/wall

wall is used for broadcasting message to all logged in users.

chmod 2555 /usr/bin/wall

Also used for group collaboration

user100@lab11 ~]$ cd /sdata
[user100@lab11 sdata]$ touch afile
[user100@lab11 sdata]$ ls -al
total 4
drwxrwxr-x.  2 root    sdatagrp   18 Aug  3 14:47 .
dr-xr-xr-x. 19 root    root     4096 Aug  3 14:43 ..
-rw-rw-r--.  1 user100 user100     0 Aug  3 14:47 afile
[user100@lab11 sdata]$ exit
logout
[root@lab11 ~]# chmod g+s /sdata
[root@lab11 ~]# su - user100
Last login: Thu Aug  3 14:47:48 CDT 2017 on pts/0
[user100@lab11 ~]$ cd /sdata
[user100@lab11 sdata]$ ls -l
total 0
-rw-rw-r--. 1 user100 user100 0 Aug  3 14:47 afile
[user100@lab11 sdata]$ touch afile
[user100@lab11 sdata]$ ls -l
total 0
-rw-rw-r--. 1 user100 user100 0 Aug  3 14:48 afile
[user100@lab11 sdata]$ touch bfile
[user100@lab11 sdata]$ ls -l
total 0
-rw-rw-r--. 1 user100 user100  0 Aug  3 14:48 afile
-rw-rw-r--. 1 user100 sdatagrp 0 Aug  3 14:48 bfile
[user100@lab11 sdata]$

Owning group get's automatically changed to the sdatagrp with setgid.


#stickybit 
chmod 1755 public_writable_directory

Set on directories where rw exists for everyone and prevents from moving/dpurging of files owned by other users.

#ACL's
Before ACL's can be enabled hte FS should be mounted with ACL support.

chacl, getacl, setacl

eg:
[root@server data]# getfacl afile
# file: afile
# owner: root
# group: root
user::rw-
group::r--
other::r--

1. user:1000:r-  # Means that a user with UID 1000, who is no tthe owner of the file nor member of the owning group is allowed only read access to this file.

sefacl mask permissions - max permissions a specific user/group can have on a file/dir. If it's set to rw_ no specific user/group can have more permissions than read-write

setfacl switches (-b = remove all acl settings, -d applies to default acl's, -k = remove all default acls, -m = modify , -x = remove specific ACL setting)


eg:

[root@lab11 sdata]# getfacl -c afile
user::rw-
group::rw-
other::r--

[user200@lab11 sdata]$ echo test > bfile


[root@lab11 sdata]# setfacl -m u:user200:r bfile

[root@lab11 sdata]# getfacl bfile
# file: bfile
# owner: user100
# group: sdatagrp
user::rw-
user:user200:r--
group::rw-
mask::rw-
other::r--

[user200@lab11 sdata]$ echo test > bfile
-bash: bfile: Permission denied

#Removes just that permission

[root@lab11 sdata]# setfacl -x u:user200 bfile
[root@lab11 sdata]# getfacl -c bfile
user::rw-
group::rw-
mask::rw-
other::r--

#Sets the max permission

[root@lab11 sdata]# setfacl -m m:r bfile
[root@lab11 sdata]# getfacl -c bfile
user::rw-
group::rw-      #effective:r--
mask::r--
other::r--


[user200@lab11 sdata]$ echo test > bfile
-bash: bfile: Permission denied

# No need to check acl option for XFS file systems as they are integral part of it.

[user100@lab11 sdata]$ ls -l bfile
-rw-r--r--. 1 user100 sdatagrp 5 Aug  3 16:17 bfile

[user200@lab11 sdata]$ echo test > bfile
-bash: bfile: Permission denied

[user100@lab11 sdata]$ getfacl -c bfile
user::rw-
group::r--
other::r--

[user100@lab11 sdata]$ setfacl -m g:sdatagrp:rw bfile
[user100@lab11 sdata]$ getfacl -c bfile
user::rw-
group::r--
group:sdatagrp:rw-
mask::rw-
other::r--

[user200@lab11 sdata]$ echo test > bfile

[user100@lab11 sdata]$ setfacl -x group:sdatagrp bfile

Also, XFS enables user_xattr (extended user attributes) and acl (POSIX access control lists) as default mount options, unlike ext3 or ext4

#Basic file system commands

[root@server ~]# findmnt -t xfs
TARGET  SOURCE                  FSTYPE OPTIONS
/       /dev/mapper/vgos-lvroot xfs    rw,relatime,seclabel,attr2,inode64,noquota
├─/boot /dev/vda1               xfs    rw,relatime,seclabel,attr2,inode64,noquota
└─/home /dev/mapper/vgos-lvhome xfs    rw,relatime,seclabel,attr2,inode64,noquota

#/etc/fstab - The last column is fsck

Pass (fsck order)
Fsck order is to tell fsck what order to check the file systems, if set to "0" file system is ignored.

Often a source of confusion, there are only 3 options :

0 == do not check.
1 == check this partition first.
2 == check this partition(s) next


--RHEL7 subscription activation
subscription-manager register --username=raj.anju --password='Kxxx' --force --auto-attach
subscription-manager register --username=baburaj.k --password='Kxxx' --force --auto-attach

subscription-manager repos --list-enabled 
yum update -y


vol-create-as --pool virspd01 rhce4.img --capacity 12G 
virt-install -n rhce4 --memory 1024 --vcpus 1 --os-variant rhel7 --disk vol=virspd01/rhce4.img --network network=default --location ftp://192.168.2.11/pub/rhel74 --extra-args ks=ftp://192.168.2.11/pub/ksconfig/rhce4.cfg
  
-- To change default kernel order
grub2-set-default index or grubby --set-default-index=entry-index


--SELINUX
matchpathcon -V filename

--Repo Syntax
 [dvd]
 name=dvd repo
 baseurl=file:///tmp/mnt
 enabled=1
 gpgcheck=0

 yum-config-manager --add-repo URL

 
--Append inst.txt to vmlinuz for text based install.

--While attaching interface always supply --model=virtio
attach-interface --domain rhce1 --type network --source virnet1 --model virtio --persistent --live --print-xml


--Add bonded interface.
virsh attach-interface( use the --model and do not use the target), nmcli d connect the interface ,  add bonded interface (nmcli con add type bond mode 0 ifname bond0 con-name bond0 autoconnect yes save yes ip4 192.168.110.13 gw4 192.168.110.1), edit eth1/eth2 (nmtui/nmcli con edit, set ipv4.master, ipv4.slave_type as bond )

Hint: To know various modes use below
[root@rhce1 ~]# modinfo bonding |grep operation
parm:           mode:Mode of operation; 0 for balance-rr, 1 for active-backup, 2 for balance-xor, 3 for broadcast, 4 for 802.3ad, 5 for balance-tlb, 6 for balance-alb (charp)


Create  ifcfg-ethX (manual)
DEVICE=ethX
NAME=ethX
TYPE=Ethernet
UUID= (use uuidgen eth1)
MASTER=bond0
SLAVE=yes

Create ifcfg-bondX(manual)
DEVICE=bondX
NAME=bondX
TYPE=Bond
BONDING_MASTER="yes"
BONDING_OPTS="mode=balance-rr"
IPADDR=
GATEWAY=

Hint: To disable Network Manager updating resolv.conf

[root@rhce1 network-scripts]# find /etc/ -name "NetworkManager.conf"
/etc/NetworkManager/NetworkManager.conf

Add below under the [main] section, cannot append.
dns=none

Hint: For adding team (do man -k team or cp /usr/share/doc/teamd-1.25/example_configs/*.conf  )
nmcli con add type team config /root/backup/team0.json ifname team0 con-name team0 autoconnect yes ip4 192.168.110.23 gw4 192.168.110.1

nmcli con edit eth3
set connection.master team0
set connection.slave-type team

--For APACHE, things to remember to override for restricting pages..

<Directory "/var/privgroup">
    AllowOverride AuthConfig
    AuthType Basic
    AuthName "This is for prviate group DBA only"
    AuthUserFile "/var/privgroup/userdb"
    AuthGroupFile "/var/privgroup/groupdb"
    Require group dba
    # Allow open access:
</Directory>

--Example of generating a self-signed cert
[root@rhce1 ~]# grep answers /etc/pki/tls/certs/make-dummy-cert
answers() {
  answers | /usr/bin/openssl req -newkey rsa:2048 -keyout $PEM1 -nodes -x509 -days 365 -out $PEM2 2> /dev/null

--Without x509 here will generate a CSR and KEY.
openssl req -newkey rsa:2048 -keyout rhce1.intercloudzone.com.key -nodes -x509 -days 365 -out rhce1.intercloudzone.com.crt
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509  -keyout test.key -out test.pem

--3 Step process 

a) Generate a key ( man genpkey)
openssl genpkey -algorithm RSA -out key.pem -pkeyopt rsa_keygen_bits:2048

b) Generate a CSR
openssl req -new -key key.pem -out req.pem

c) Generate a cert
openssl x509 -req -in req.pem -signkey key.pem -out cert.pem

or 

--Generate key one shot
genkey webserver.intercloudzone.com 

Note: Make sure to give PortNumber on the ServerName directive.

[root@rhce4 conf.d]# cat secure.conf
<VirtualHost *:443>
    ServerAdmin secure@webserver.intercloudzone.com
    DocumentRoot "/var/www/html/secure"
    ServerName webserver.intercloudzone.com:443
    ErrorLog "/var/log/httpd/secure.error_log"
    CustomLog "/var/log/httpd/secure-access_log" common
    SSLCertificateFile /etc/pki/tls/certs/secure.pem
    SSLCertificateKeyFile /etc/pki/tls/private/secure.key
</VirtualHost>

[root@rhce5 ~]# echo | openssl s_client -showcerts -servername webserver.intercloudzone.com -connect webserver.intercloudzone.com:443 > cert.pem

[root@rhce5 ~]# curl --cacert cert.pem https://webserver.intercloudzone.com/index.html
This is an ssl/tls protected page

--Allows binary to bind on low numbered ports.

setcap CAP_NET_BIND_SERVICE=+eip /path/to/binary
 
--To install the man pages for httpd_linux

yum install httpd-manual
elinks http://localhost/manual


yum install selinux-policy-devel -y
sepolicy manpage -a -p /usr/share/man/man8
mandb
man httpd_selinux
yum install -y httpd-manual
man -k _selinux 

--postfix

# less /usr/share/doc/postfix-2.10.1/README_FILES/STANDARD_CONFIGURATION_README

postfix check ( Syntax checks)
postconfpost d ( Load defaults)

postconf -e disable_dns_lookup=yes

--Disable DNS lookups


[root@rhce2 postfix]# postconf -e smtp_host_lookup=native
[root@rhce2 postfix]# grep smtp_host main.cf
smtp_host_lookup = native

-Addition settings is above isn't working ( Square brakets prevents dns lookups)

[root@rhce2 postfix]# tail -2 transport
intercloudzone.com  :[rhce1.intercloudzone.com]

[root@rhce2 postfix]# postmap transport

 --Locate is run once daily

root@mayura:~\> cat /etc/cron.daily/mlocate
#!/bin/sh
nodevs=$(< /proc/filesystems awk '$1 == "nodev" && $2 != "rootfs" { print $2 }')
renice +19 -p $$ >/dev/null 2>&1
ionice -c2 -n7 -p $$ >/dev/null 2>&1
/usr/bin/updatedb -f "$nodevs"


--sar vs sadf 
sadf can display in multiple formats, to use options for sar in sadf use "--" followed by sar options

sadf sa12 -- -A 

--Enable IPV4 and IPV6 forwarding

root@panchajanya:~\> sysctl -a |egrep -w 'net.ipv4.ip_forward|net.ipv6.conf.all.forwarding'
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

--If IP Forwarding is enabled, below flag makes sure the packets coming in
are from an external network are in fact external by doing a reverse path forwarding check.

net.ipv4.conf.default.rp_filter = 1


--Following setting avoids the overload or otherwise called 'ping of death', by flooding of SYN packets.
net.ipv4.tcp_syncookies = 1

The maximum allowable IP packet size is 65,535 bytes, including the packet header, which is typically 20 bytes.
An ICMP echo request is an IP packet with a pseudo header, which is 8 bytes. 
Therefore, the maximum allowable size of the data area of an ICMP echo request is 65,507 bytes (65,535 - 20 - 8 = 65,507).


--Disable ICMP's from within the VM
[root@rhce4 sysctl.d]# sysctl -w net.ipv4.icmp_echo_ignore_all=1
net.ipv4.icmp_echo_ignore_all = 1

--Disable ping broadcasts.
[root@rhce4 sysctl.d]# sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1
net.ipv4.icmp_echo_ignore_broadcasts = 1

--Default configuration files are in /usr/lib/sysctl.d

--If this directive is enabled , failure with IPV6 will result in interface being down even if IPV4 configuration is working fine.

IPV6_FAILURE_FATAL=no

--Error on the teamd configuration

 set team-port.config '{ "runner" : "loadbalance" }'


 #Create local yum repository.

[root@server ~]# mkdir -pv /var/localrepo
mkdir: created directory ‘/var/localrepo’
[root@server ~]# cd /var/localrepo/
[root@server localrepo]# cp /tmp/net-tools-2.0-0.17.20131004git.el7.x86_64.rpm .
[root@server localrepo]# yum -y install createrepo


[root@server localrepo]# createrepo -v /var/localrepo/
Spawning worker 0 with 1 pkgs

-page-out and page-in are called demand paging.
excessive amount of paging that affects performance is called thrashing

-#Character(raw) devices are accessed serially - printers, mice, keyboards, terminals, 
etc and block devices are accessed in parallel via blocks - HDD, optical drives etc.


chattr +i afile # Immutable, can't be deleted, renamed or changed
chattr +a afile # Can only be appended.


Files metadata includes several piece of informaiton, such as files type, size, permissions, owners name, 
group name, last access/mod time, ACL, link count , bloks and pointers to the location 
where actual data is stored. This takes 128-byte space in the FS for each file and this tiny storage space is reerred to as inode (index node). inode is assigned a unique
identifier that is used by kernel to access, track and manage the file.

the file name and corresponding inode number is maintained in directories metadata. 

inode doesn't store file name. 

Hardlinked files share same data location and and unlike soft-links 
cannot cross file system boundaries and link directories.

#umask
default umask is 0022 for root and system users and 0002 for all regular users with a bash shell.

[radha@lab11 ~]$ umask
0002

[radha@lab11 ~]$ umask -S
u=rwx,g=rwx,o=rx

Linux assigns default permissions by using "preset value" -  "umask value"

For files 666 - umask , directories 777 - umask.


#setuid - set's on files. Gives ability for non-owenrs and non-group members the ability to run executables with the privileges of owner.

Find all files in teh system with setuid bit set

[root@server ~]# find / -perm -4000


[radha@lab11 ~]$ ll /usr/bin/su
-rwsr-xr-x. 1 root root 32072 Nov 20  2015 /usr/bin/su
[radha@lab11 ~]$ su - root
Password:
Last login: Thu Aug  3 08:30:04 CDT 2017 from 192.168.134.1 on pts/0
[root@lab11 ~]# chmod u-s /usr/bin/su
[root@lab11 ~]# ll /usr/bin/su
-rwxr-xr-x. 1 root root 32072 Nov 20  2015 /usr/bin/su
[root@lab11 ~]# su - radha
Last login: Thu Aug  3 14:17:44 CDT 2017 on pts/0
[radha@lab11 ~]$ su - root
Password:
su: Authentication failure


#setgid is set at group level

File can be executed by non-owners by exact same privileges that group members have.
[root@server ~]# ll /usr/bin/wall
-r-xr-sr-x. 1 root tty 15344 Jun  9  2014 /usr/bin/wall

wall is used for broadcasting message to all logged in users.

-File System Block Corruption Fix

[root@server ~]# dumpe2fs /dev/mapper/vg01-lvol1 |grep superblock
dumpe2fs 1.42.9 (28-Dec-2013)
  Primary superblock at 1, Group descriptors at 2-3
  Backup superblock at 8193, Group descriptors at 8194-8195
  Backup superblock at 24577, Group descriptors at 24578-24579
  Backup superblock at 40961, Group descriptors at 40962-40963
  Backup superblock at 57345, Group descriptors at 57346-57347
  Backup superblock at 73729, Group descriptors at 73730-73731
  Backup superblock at 204801, Group descriptors at 204802-204803


[root@server ~]# fsck -b 8193 /dev/mapper/vg01-lvol1
fsck from util-linux 2.23.2
e2fsck 1.42.9 (28-Dec-2013)
teste2 was not cleanly unmounted, check forced.
Pass 1: Checking inodes, blocks, and sizes
Pass 2: Checking directory structure
Pass 3: Checking directory connectivity
Pass 4: Checking reference counts
Pass 5: Checking group summary information

teste2: ***** FILE SYSTEM WAS MODIFIED *****
teste2: 11/53248 files (0.0% non-contiguous), 12632/212992 blocks


#Error

[root@server ~]# pvcreate /dev/vdd
  WARNING: Device for PV xdVv91-0Gfz-uzSs-1pzu-CDVQ-34Pm-PwsGBd not found or rejected by a filter.
  Device /dev/vdd not found (or ignored by filtering).


[root@server ~]# uuidgen
c534079b-103f-45ab-9252-839684568fd6


[root@server ~]# tune2fs /dev/vdd -U c534079b-103f-45ab-9252-839684568fd6
tune2fs 1.42.9 (28-Dec-2013)
tune2fs: Bad magic number in super-block while trying to open /dev/vdd
Couldn't find valid filesystem superblock.

[root@server ~]# dumpe2fs /dev/vdd
dumpe2fs 1.42.9 (28-Dec-2013)
dumpe2fs: Bad magic number in super-block while trying to open /dev/vdd
Couldn't find valid filesystem superblock.


#mkfs -n doesn't create a FS , but displays what it would do if it were to create a FS..

[root@server ~]# mkfs.ext4 -n /dev/vdd
mke2fs 1.42.9 (28-Dec-2013)
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
196608 inodes, 786432 blocks
39321 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=805306368
24 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
  32768, 98304, 163840, 229376, 294912


[root@server ~]# fsck -b 98304 /dev/vdd
fsck from util-linux 2.23.2
e2fsck 1.42.9 (28-Dec-2013)
fsck.ext2: Invalid argument while trying to open /dev/vdd

The superblock could not be read or does not describe a correct ext2
filesystem.  If the device is valid and it really contains an ext2
filesystem (and not swap or ufs or something else), then the superblock
is corrupt, and you might try running e2fsck with an alternate superblock:
    e2fsck -b 8193 <device>

#Last ditch effort of recreating ONLY superblocks

[root@server ~]# mke2fs -S /dev/vdd -t ext4
mke2fs 1.42.9 (28-Dec-2013)
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
196608 inodes, 786432 blocks
39321 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=805306368
24 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
  32768, 98304, 163840, 229376, 294912

Allocating group tables: done
Skipping journal creation in super-only mode
Writing superblocks and filesystem accounting information: done

Run e2fsck immediately..

root@server ~]# e2fsck /dev/vdd

#Display devices ..
[root@server ~]# lvs -a -o +devices
  WARNING: Device for PV xdVv91-0Gfz-uzSs-1pzu-CDVQ-34Pm-PwsGBd not found or rejected by a filter.
  LV     VG   Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Devices
  lvol0  vg01 -wi-a----- 208.00m                                                     /dev/vde(0)
 
#Another utility
debugfs

[root@server ~]# vgs -a -o +pv_name
  VG   #PV #LV #SN Attr   VSize VFree   PV
  vg01   2   3   0 wz--n- 3.97g   3.36g /dev/vde
  vg01   2   3   0 wz--n- 3.97g   3.36g /dev/vdc1
  vgos   1   2   0 wz--n- 9.76g 996.00m /dev/vda2

[root@server ~]# vgreduce vg01 --removemissing --force
  WARNING: Device for PV xdVv91-0Gfz-uzSs-1pzu-CDVQ-34Pm-PwsGBd not found or rejected by a filter.
  WARNING: Device for PV xdVv91-0Gfz-uzSs-1pzu-CDVQ-34Pm-PwsGBd not found or rejected by a filter.
  Wrote out consistent volume group vg01


 [root@server ~]# pvcreate /dev/vdd
  Physical volume "/dev/vdd" successfully created

</pre>

</div>

<div class="w3-container">
  <h1><span class="mw-headline" id="QUESTIONS"> Questions </h1> 
<p>

</p>

<pre> 

-Good cheat sheet
https://www.lisenet.com/2016/configure-host-based-and-user-based-security-for-the-service-on-rhel-7/


-Examples 

1. Configure an SSH server on server1.example.com with access limited to the hosts on the 192.168.122.0/24 network.
   Create local users named katie and dickens. Limit SSH access on the server only to user katie.

-Doc
man hosts_access , /usr/share/doc/tcp_wrappers

-Install
[root@rhce1 ~]# yum install tcp_wrappers -y

[root@rhce1 ~]# ldd /usr/sbin/sshd | grep libwrap
  libwrap.so.0 => /lib64/libwrap.so.0 (0x00007fb65a254000)

-Verify
[root@rhce1 ~]# strings -f /usr/sbin/* | grep hosts_access
/usr/sbin/auditd: hosts_access
/usr/sbin/sshd: hosts_access

- Option-1
[root@rhce1 etc]# tail -2 /etc/hosts.allow
sshd :  192.168.122.0/24

[root@rhce1 etc]# tail -2 /etc/hosts.deny
sshd : ALL
sshd : dickens

Note: Ensure ALL in Deny so that every other subnet access is denied.

- Option-2
Add --zone=<zone name> and --permanent in real time.

firewall-cmd --add-rich-rule='rule family="ipv4" source address="192.168.122.0/24" invert="True" service name="ssh" 
log prefix="Reject net 192.168.122.0/24" level="info"  reject '

- Option-3 ( or do it while creating)

[root@rhce1 etc]# chsh -s /bin/bash dickens
Changing shell for dickens.
Shell changed.

- Option-4 : Deny via sshd_config ( Refer AllowGroups, DenyGroups as well)

[root@rhce1 etc]# tail -1 /etc/ssh/sshd_config
DenyUsers dickens

- Option-5 :  via PAM ( man pam_listfileq)

Add below line to /etc/pam.d/sshd

[root@rhce1 pam.d]# grep deny sshd
auth  required  pam_listfile.so item=user sense=deny file=/etc/ssh.deny onerr=fail

[root@rhce1 pam.d]# cat /etc/ssh.deny
dickens

-Verify 

cd /etc
[root@rhce1 etc]# tcpdmatch -d sshd 193.168.122.10
client:   address  193.168.122.10
server:   process  sshd
access:   denied

[root@rhce1 etc]# tcpdmatch -d sshd 192.168.122.10
client:   address  192.168.122.10
server:   process  sshd
access:   granted


--From the logs
May 25 16:59:10 rhce1 sshd[3160]: pam_listfile(sshd:auth): Refused user dickens for service sshd
May 25 16:59:12 rhce1 sshd[3160]: Failed password for dickens from 192.168.122.1 port 49132 ssh2


-Additional: Prevent root login only via consoles (not remote ssh).
A blank /etc/securetty file does not prevent the root user from logging in remotely using 
the OpenSSH suite of tools because the console is not opened until after authentication.

echo > /etc/securetty 

-Prevent root login via ssh by updating in sshd_config
PermitRootLogin no  
chsh -s /sbin/nologin root

-To disable **ALL** Users from logging in  
[root@rhce1 etc]# echo "Access to this system is restricted " > /etc/nologin


-Restricting password auth vs non password auth based on CIDR/User via /etc/ssh/sshd_config

PasswordAuthentication no

Match Address 192.168.0.0/16
        PasswordAuthentication yes

Match User kuttu
        PasswordAuthentication yes


--SELINUX 

yum install yum-utils #To get repoquery.
yum install setroubleshoot-server policycoreutils-python libselinux-utils selinux-policy-devel setools-console

sepolicy manpage -a -p /usr/share/man/man8
mandb

--Enable Samba Booleans so that samba can read/write all shares mounted

semanage boolean -m samba_export_all_ro --on
setsebool -P samba_export_all_rw on



==> /var/log/samba/log.smbd <==
[2018/05/31 16:14:25.247168,  0] ../source3/passdb/lookup_sid.c:1605(get_primary_group_sid)
  Failed to find a Unix account for dickens
[2018/05/31 16:14:25.247837,  0] ../source3/auth/check_samsec.c:493(check_sam_security)
  check_sam_security: make_server_info_sam() failed with 'NT_STATUS_NO_SUCH_USER'

Note: 
Follow this sequence: password change in unix, followed by user addition in samba

useradd -u 2001 dickens
echo 'oracle' | passwd --stdin dickens 

--valid users
If this is left blank all users will be able to access the share which is the default!


Attributes to check:
force create mode = 0770  
directory mask = 0770
hosts allow

--On Samba client

Ensure to add the samba-client on the FW ..
firewall-cmd --permanent --add-service=samba-client

--Always create userid's with UID/GID so the mapping of the files/directories looks fine.


-NFS
ALways add all 3 servicecs to firewall
firewall-cmd --permanent --add-service={mountd,nfs,rpc-bind}

Show the versions of NFS supported
[root@rhce1 ~]# cat /proc/fs/nfsd/versions
-2 +3 +4 +4.1 +4.2

-Selinux context for NFS Mount(Client)

By default the NFS mounts has nfs_t if selinux is not used in the mount.




Note:
Always enable/start services on both services and clients.

For eg. ISCSI and/or NFS or other services - start the services on the clients too.

systemctl enable iscsi on the client (not just server)


-IP FORWARDING

[root@rhce4 sysctl.d]# sysctl -p
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1


--DNS

[root@rhce4 named]# nmap -Pn -sT dns4.intercloudzone.com

Starting Nmap 6.40 ( http://nmap.org ) at 2018-06-06 10:31 CDT
Nmap scan report for dns4.intercloudzone.com (192.168.122.40)
Host is up (0.0015s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
53/tcp open  domain

Nmap done: 1 IP address (1 host up) scanned in 0.16 seconds

[root@rhce4 named]# ss -a sport = :53

[root@rhce4 named]# cat intercloudzone.com.db
$TTL 1D
$ORIGIN intercloudzone.com.
@ IN SOA  @ root.intercloudzone.com. (
          0 ; serial
          1D  ; refresh
          1H  ; retry
          1W  ; expire
          3H )  ; minimum
  NS  dns4
dns4  A 192.168.122.40
rhce4 A 192.168.122.40
rhce5 A 192.168.122.50
dummy A 192.168.122.40
@ TXT "intercloudzone-site-verification-code=RHCE-INTERCLOUDZONE.COM"

[root@rhce4 named]# dig +short TXT intercloudzone.com @192.168.122.40
"intercloudzone-site-verification-code=RHCE-INTERCLOUDZONE.COM"


--SPF Record ( Sender Policy Framework)
https://support.google.com/a/answer/33786?hl=en

mail4 MX  10  192.168.122.40
..
@ TXT "v=spf1 a:mail4.intercloudzone.com ~all"

This record indicates that there is only one server that is allowed to send mail using the intecloudzone.com domain, 
and that is mail4.intercloudzone.com. Now that we know that, we look up the IP address of the mail.intercloudzone.com host.

If the IP address matches the IP address of the incoming connection, then we have a match and the SPF test yields a Pass result.
If the address does not match  then we go on to the next part of the SPF record, in this case "-all" which tells us that 
there any other IP address yields a Fail result.

Note if there was no SPF record for example.com, the result would be None, rather than Pass or Fail.

Reference:
http://www.openspf.org/FAQ/Examples

-- LDAP (dc=domain component,c=country,ou=organization unit,cn=common name, 
DN=Distinguished Name - like absoulte path name and is a sequence of comma separated RDNs)

Configure LDAP client on rhce5.intercloudzone.com with search base dc=intercloudzone,dc=com and 
self-signed certificate over SSL/TLS assuming ldap server is running on
rhce4.intercloudzone.com
 
Note: Install sssd and authconfig! Also in the ldapserver ensure the ldapprotocol is specificed (ie ldap://)
yum install openldap openldap-clients nss-pam-ldapd sssd authconfig

authconfig --enableldap --enableldapauth --enablesssd --entableldaptls --ldapserver=ldap://rhce4.intercloudzone.com 
--ldapbasedn="dc=intercloudzone,dc=com" --update --test


[root@rhce5 ~]# cat /etc/sssd/sssd.conf  |grep -v ^$
[domain/default]
autofs_provider = ldap
cache_credentials = True
ldap_search_base = dc=intercloudzone,dc=com
id_provider = ldap
auth_provider = ldap
chpass_provider = ldap
ldap_uri = ldap://rhce4.intercloudzone.com
ldap_tls_cacertdir = /etc/openldap/cacerts
[sssd]
services = nss, pam, autofs
domains = default
[nss]

[root@rhce5 ~]# grep -v ^# /etc/openldap/ldap.conf |grep -v ^$
TLS_CACERTDIR /etc/openldap/cacerts
SASL_NOCANON  on
URI ldap://rhce4.intercloudzone.com
BASE dc=intercloudzone,dc=com

--Ensure sss is in the /etc/nsswitch.conf files

[root@rhce5 ~]# egrep '^passwd|^shadow|^group' /etc/nsswitch.conf
passwd:     files sss
shadow:     files sss
group:      files sss

systemctl enable sssd

--Apache Tips
elinks http://localhost/manual ( Refer .htaccess for examples, Directives)

The pattern to deny access on is not a CIDR, just the prefixes of the subnet.
Eg. "Require not host 192.168" 


-Postfix 

postfix -vv or postfix check ( Syntax checking)

--Aliases: Command = newaliases ( Local -> Local/Remote)

[root@rhce4 postfix]# tail -1 /etc/aliases
mike: barry,raj.anju@gmail.com

[root@rhce4 postfix]# echo "Testing mail to mike" | mail -s "Test subject - send to mike" mike

[root@rhce4 postfix]# echo | mail -u barry
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
"/var/mail/barry": 1 message
>   1 root                  Thu Jun  7 09:23  19/672   "Test subject - send to mike"
Message  1:

--Delivery log
Jun  7 09:23:26 rhce4 postfix/pickup[1420]: 768906043DF: uid=0 from=<root>
Jun  7 09:23:26 rhce4 postfix/cleanup[5116]: 768906043DF: message-id=<20180607142326.768906043DF@rhce4.intercloudzone.com>
Jun  7 09:23:26 rhce4 postfix/qmgr[1421]: 768906043DF: from=<root@rhce4.intercloudzone.com>, size=503, nrcpt=1 (queue active)
Jun  7 09:23:26 rhce4 postfix/local[5118]: 768906043DF: to=<barry@rhce4.intercloudzone.com>, orig_to=<mike>,
  relay=local, delay=0.13, delays=0.09/0.02/0/0.03, dsn=2.0.0, status=sent (delivered to mailbox)
Jun  7 09:23:26 rhce4 postfix/qmgr[1421]: 768906043DF: removed

--Canonical: Establish mapping between local and non-local mail addresses

[root@rhce4 postfix]# tail -2 canonical
@intercloudzone.com @localhost.localdomain
anju@intercloudzone.com anju@localhost.localdomain


[root@rhce4 postfix]# echo "Testing mail to anju" | mail -s "Test subject " anju@intercloudzone.com
[root@rhce4 postfix]# mail -u anju
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
"/var/mail/anju": 1 message 1 new
>N  1 root                  Thu Jun  7 10:49  18/654   "Test subject"
& quit


--Virtual: Mostly for redirects. Mail intended for one user to one more other email addresses.
[root@rhce4 postfix]# tail -2 virtual
@example.com  anju
radha kuttu,kannan

[root@rhce4 postfix]# tail -2 main.cf
virtual_alias_domains = example.com
virtual_alias_maps = hash:/etc/postfix/virtual

[root@rhce4 postfix]# echo "Mail testing " | mail -s "testing" kuttu@example.com

[root@rhce4 postfix]# mail -u anju
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
"/var/mail/anju": 1 message 1 new
>N  1 root                  Thu Jun  7 11:49  18/635   "testing"
& quit

[root@rhce4 postfix]# echo "Mail to radha" | mail -s "mail to radha -fwd to k & k" radha

[root@rhce4 postfix]# echo | mail -u kuttu
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
"/var/mail/kuttu": 1 message 1 new
>N  1 root                  Thu Jun  7 11:52  18/657   "mail to radha -fwd to k & k"
Message  1:
From root@rhce4.intercloudzone.com  Thu Jun  7 11:52:01 2018
Return-Path: <root@rhce4.intercloudzone.com>
X-Original-To: radha
Delivered-To: kuttu@rhce4.intercloudzone.com
Date: Thu, 07 Jun 2018 11:52:01 -0500
To: radha@rhce4.intercloudzone.com
Subject: mail to radha -fwd to k & k
User-Agent: Heirloom mailx 12.5 7/5/10
Content-Type: text/plain; charset=us-ascii
From: root@rhce4.intercloudzone.com (root)
Status: R


-Virtual reference example

Let's say there are 3 domains, one main and two virtual

example.com (this is also the domain I’ve used for naming the server)
example.org
example.net

--- main.cf --
myhostname = server.example.com
mydomain = example.com
myorigin = $mydomain
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
virtual_alias_domains = example.org example.net
virtual_alias_maps = hash:/etc/postfix/virtual

info@example.com                    user1
info@example.org                    user2
info@example.net                    user3


Relocated: If user moved from example.com domain to example.org
user1@example.com user1@example.net

Transport: Maps users mail address and a host (next hop)
user1@example.com smtp:host1.example.com


--SAMBA 

Port number
[root@rhce4 samba]# grep microsoft /etc/services
microsoft-ds    445/tcp
microsoft-ds    445/udp

-Ensure all directives below incorporated to prevent mounting by other samba users

[smb2]
        comment = SMB2 Share
        path = /smb2
        create mask = 0500
        directory mask = 0500
        read list = mary
        public  = no
        browseable = no
        valid users = mary


[root@rhce5 ~]# mount.cifs //rhce4.intercloudzone.com/smb2 /mnt/smbshare2 -o user=harry,pass=harry -v
mount.cifs kernel mount options: ip=192.168.122.40,unc=\\rhce4.intercloudzone.com\smb2,user=harry,pass=********
mount error(13): Permission denied
Refer to the mount.cifs(8) manual page (e.g. man mount.cifs)
[root@rhce5 ~]# mount.cifs //rhce4.intercloudzone.com/smb2 /mnt/smbshare2 -o user=mary,pass=mary -v
mount.cifs kernel mount options: ip=192.168.122.40,unc=\\rhce4.intercloudzone.com\smb2,user=mary,pass=********

-Mount a share on both Samba and NFS

[both]
  comment = NFS and Samba
  path = /both
  public = yes
  browseable = yes
  create mask = 0777
  directory mask = 0777
  hosts allow = 192.168.
  guest ok = yes
  write list = guest
  writeable = yes


setsebool -P samba_share_nfs on
setsebool -P nfsd_anon_write on
semanage fcontext -a -t public_content_rw_t "/both(/.*)?"
restorecon -vR /both


[root@rhce5 ~]# tail -2 /etc/fstab
//rhce4.intercloudzone.com/smb2 /mnt/smbshare2  cifs  ro,credentials=/mnt/smb2creds,_netdev 0 0
//rhce4.intercloudzone.com/both /mnt/both cifs  guest,rw,_netdev  0 0


[root@rhce4 samba]# cat /etc/exports
/both *.intercloudzone.com(rw,no_root_squash) 192.168.0.0/24(rw,no_root_squash)

[root@rhce4 samba]# exportfs -vr
exporting 192.168.0.0/24:/both
exporting *.intercloudzone.com:/both

firewall-cmd --add-service={nfs,rpc-bind,mountd} --permanent

[root@rhce5 both]# showmount -e rhce4.intercloudzone.com
Export list for rhce4.intercloudzone.com:
/both *.intercloudzone.com,192.168.0.0/24

[root@rhce5 both]# mount -t nfs rhce4.intercloudzone.com:/both /mnt/nfsboth/ -o rw -vvv
mount.nfs: timeout set for Thu Jun  7 17:02:49 2018
mount.nfs: trying text-based options 'vers=4.1,addr=192.168.122.40,clientaddr=192.168.122.50'


-System Locale

[root@rhce4 ~]# localectl
   System Locale: LANG=en_US.UTF-8
       VC Keymap: us
      X11 Layout: us
[root@rhce4 ~]# echo $LANG
en_US.UTF-8

-systemd

Available units can be listed like 

systemctl -t help

When system boots the control is passed onto systemd from initramfs, normally the default.target
is a symlink to actual target.

[root@rhce4 systemd]# ls -ltr /etc/systemd/system/default.target
lrwxrwxrwx. 1 root root 37 Dec  4  2017 /etc/systemd/system/default.target -> /lib/systemd/system/multi-user.target

During boot on the linux16, add systemd.unit=rescue.target or other target names to switch.

-Root password corruption
linux16 ...rd.break (or init=/sysroot/bin/sh)
mount -o remount,rw /sysroot
chroot /sysroot
passwd 
touch /.autorelabel
exit (twice)

-Grub2 Command Line.

grub> 
insmod lvm
search.file /etc/fstab 
  lvm/vgos-root
set root=(lvm/vgos-root)
linux16 (hd0,msdos1)/vmlinuz -tab root=/dev/mapper/vgos-root
initrd (hd0,msdos1)/initramfs* 

-System boot issues 

Early debug shell can be activated by

systemctl enable debug-shell # A root shell will be spanned on TTY9, CTRL+ALT+F9)

During boot systemd will spawn several jobs and if some of them cannot complete
it will get stuck and can be checked via

systemctl list-jobs

--TEAMD configuration 

copy the team.conf example from /usr/share/doc, ensure the interfaces are down..

[root@rhce4 ~]# ip link show | egrep 'eth[3|4]' |grep DOWN
5: eth3: <BROADCAST,MULTICAST> mtu 1500 qdisc pfifo_fast state DOWN mode DEFAULT qlen 1000
6: eth4: <BROADCAST,MULTICAST> mtu 1500 qdisc pfifo_fast state DOWN mode DEFAULT qlen 1000

[root@rhce4 ~]# cat team1.conf
{
  "device": "team1",
  "runner": {"name": "activebackup"},
  "link_watch": {"name": "ethtool"},
  "ports":  {
    "eth3": {
      "prio": -10,
      "sticky": true
    },
    "eth4": {
      "prio": 100
    }
  }
}

teamd -g -f team1.conf -d

Note: Important man page refer 
man nm-settings

- DAD (IPv6 - Duplicate Address Detection)
[root@rhce4 network-scripts]# sysctl -w net.ipv6.conf.team0.accept_dad=0
net.ipv6.conf.team0.accept_dad = 0

[root@rhce4 network-scripts]# echo "net.ipv6.conf.team0.accept_dad=0" > /etc/sysctl.d/accept_dad.conf
[root@rhce4 network-scripts]# nmcli c down team0

The meaning of accept_dad is as follows:

accept_dad - INTEGER
    Whether to accept DAD (Duplicate Address Detection).
        0: Disable DAD
        1: Enable DAD (default)
        2: Enable DAD, and disable IPv6 operation if MAC-based duplicate
            link-local address has been found.

The localhost address is ::1/128, which is 127.0.0.1/8 in IPv4 format.

A unique local address is an IPv6 address in the block fc00::/7. (RFC1918)


Note:
Examples of routing are in /usr/share/doc/initscripts-9.49.39/sysconfig.txt

When including a ipv6 followed by port, include a square bracket

[2001:db8:0:10::1]:80

The leading practice is to receive at least a /48 prefix from an ISP. 
This leaves you with 2^80 bits to manipulate (128 bit address - 48 bits that can't be changed = 80 bits to use). 

According to RFC4291 the current recommended smallest prefix is a /64. 

Reference:
https://supportforums.cisco.com/t5/network-infrastructure-documents/ipv6-subnetting-overview-and-case-study/ta-p/3125702
If we are assigned 2001:db8:1234:0000:/48 from our provider, 
as mentioned, we have the "0000" to manipulate for site, sub-site and subnet IDs.


A link local address is un-routable, can talk to other hosts only in the same network link. To ensure it's unique
the creation inserts mac address to the address. 
fe80::/64

Since every link has a fe80::/64 address routing table cannot be used to select the outbound interface correctly.This
is why a scope identifier should be used. 

Scope identifiers are only required for the IPv6 with link scope, rest will use the routing table.

Multicast Address:
There is no broadcast address in IPV6 and hence Multicast plays a big role. Pinging ff02::1 will send traffic to all
nodes on the link.


:: equivalent to ipv4 0.0.0.0      - Listening on all configured ip addresses.
::/0 equivalent to ipv4 0.0.0.0/0  - Default Route for IPv6 internet. The route chosen when there are no explicit routes available.
2000::/3 Global Unicast Address
fc00::/10 Unique Local Address (RFC4193) - equivalent to ipv4 RFC1918
fe80::/64 - Link-Local address, automatically configured for every device.

ff00::/8 - Multicast - equivalent to 224.0.0.0/4. There is no broadcast address in IPv6.

ping6 ff02::1 is a multicast address which will send packet all local-links.

ff02::1:2 -- all-dhcp-servers link-local multicast group
ff02::2   -- all-routers link-local multicast group

-DHCPv6
Since there is no broadcast address, host sends a DHCPv6 from link-local to port 547/UDP on ff02::1:2 - the all-dhcp-servers 
link-local multicast group. The DHCP server sends back a reply with appropriate information to port 546/UDP on clients link-local
address.

-SLAAC - Stateless Adddress Autoconfiguration (SLAAC) 
This dynamic configuration is similar to DHCPv6 where in hte host brings up it's interface with a link-local fe80::/64 address normally.
It sends a router solicitation to ff02::2, the all-routers link-local multicast group. The IPV6 router on the local link responds to the
hosts link-local address with a network prefix and possibly other information. The hose uses that network prefix with an interface id
and it normally constructs in the same way that link local addresses are constructed.

Following interface IDs are reserved and cannot be used for normal network
All Zeros identifier 0000:0000:0000:0000 - Subnet router anycast used by all routers on the link.

So for the network 2001:db8::/64, the address 2001:db8:: cannot be used.

-Bridge
A link-layer device that will forward traffic based on MAC address. It learns what hosts are connected to each network,
builds a table around with all the MAC addresses and packet forwarding decisions are made based on this MAC table.

nmcli con add type bridge con-name br0 ifname br0
nmcli con add type bridge-slave master br0 con-name br0-port1 ifname eth3
nmcli con add type bridge-slave master br0 con-name br0-port2 ifname eth4

-Troubleshoot

Note: Look for 'UP'
[root@rhce4 network-scripts]# ip addr show br0
10: br0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP qlen 1000


Check if bridge is in forwarding state

[root@rhce4 network-scripts]# brctl showstp br0 |grep forwarding
 port id    8001      state        forwarding
 port id    8002      state        forwarding


Look for MACs registered.

 [root@rhce4 network-scripts]# brctl showmacs br0
port no mac addr    is local? ageing timer
  1 52:54:00:b4:fa:ec yes      0.00
  1 52:54:00:b4:fa:ec yes      0.00
  2 52:54:00:c5:e7:09 yes      0.00
  2 52:54:00:c5:e7:09 yes      0.00


Note: NetworkManager need to be disabled to configure bridge on a team/bond interface.

-Firewalld

firewalld separates all incoming traffic into zones. Firewalld uses this logic where the first rule matches wins.

1. If source address of an incoming packet matches with a source rule setup for a zone, that packet will be routed through that zone.

2. If incoming interface of a packet matches a filter setup for that zone, that zone will be used.

3. Else default zone will be used.


--Port Forwarding (NAT)
With port forwarding, traffic to a single port is forwarded either a different port on same machine or a port on a different machine. 

When a port forward is configured packets to a difference machine, any replies from that machine goes directly to the client and this 
will result in invalid connection. The machine that is forwarded will have to be masqueraded through the firewall that performed 
port forwarding.


--Redirect all source to a specific zone.
firewall-cmd --add-rich-rule 'rule family=ipv4 souce address=192.168.0.0/16 drop'

Assign a specific zone to a source subnet

firewall-cmd --zone=drop --add-source=192.168.0.0/16

-Unbound (Caching only nameserver)

interface: 0.0.0.0
access-control: 0.0.0.0/0 allow
 forward-zone:
        name: "."
        forward-host: 192.168.122.50


[root@rhce5 ~]# unbound-checkconf
unbound-checkconf: warning: . forward-host: "192.168.122.50" is an IP4 address, and when looked up as a host name during use may not resolve.
/etc/unbound/unbound_server.key: No such file or directory
[1528925699] unbound-checkconf[1599:0] fatal error: server-key-file: "/etc/unbound/unbound_server.key" does not exist

[root@rhce5 ~]# systemctl restart unbound-keygen

[root@rhce5 ~]# unbound-checkconf
unbound-checkconf: warning: . forward-host: "192.168.122.50" is an IP4 address, and when looked up as a host name during use may not resolve.
unbound-checkconf: no errors in /etc/unbound/unbound.conf

[root@rhce5 ~]# unbound-control dump_cache
START_RRSET_CACHE
END_RRSET_CACHE
START_MSG_CACHE
END_MSG_CACHE
EOF

dig @192.168.122.50 A a.example.com

[root@rhce5 ~]# unbound-control dump_cache
START_RRSET_CACHE
END_RRSET_CACHE
START_MSG_CACHE
msg 192.168.122.50. IN A 32898 1 1 2 0 0 0
msg 192.168.122.50. IN AAAA 32898 1 1 2 0 0 0
msg a.example.com. IN A 32898 1 1 2 0 0 0
END_MSG_CACHE
EOF

--Local nslookup order is dictacted by /etc/nsswitch.conf and to verify use getent hosts

[root@rhce5 ~]# getent hosts dns4
192.168.122.40  dns4.intercloudzone.com dns4

Note:
While most DNS uses UDP, if response data size exceeds 512 or 4096 bytes, the servers using EDNS
will fall back to TCP to retry the query and thus the DNS should allow both TCP/UDP on port 53.

dig +tcp or dig +vc options can be tried to check if the udp (default) output is sparse.

sshd usually performs reverse DNS look-ups and missing PTR records will delay in connectivities.

-DNS Troubleshooting

[root@rhce5 ~]# grep [[:space:]]dns4.intercloudzone.com /etc/hosts
192.168.122.40  dns4.intercloudzone.com dns4

-Postfix

inet_interfaces  Controls which network intefaces Postfix listens on for incoming and outgoing
                 messages. If set to loopback-only, postfix listens only on 127.0.0.1 and ::1.

myorigin         Rewrite locally posted email to appear to come from this domain. This helps ensure
                 responses return to the correct domain the mail server is responsible for.

mydestination    Configure which domains the mail server is an endpoint for. Email addressed to 
                 these domails are delivered into local mailboxes.

local_transport  Determine how email addressed to $mydestination should be delivered. By default, set to
                 local:$myhostname , which use 'local' mail delivery agent to deliver incoming mail to the local 
                 message store in /var/spool/mail.

                 Set this to error: error messsage, eg. local_transport = error: local delivery disabled, to disable
                 local delivery completely.

mynetworks       Allow relay through this mail servers listed to anywhere without auth. If mynetworks is not explicity set it will be filled
                 automatically using setting for mynetworks_style. The default for mynetworks_style is subnet, meaning
                 all subnets in which the server has an IP address will be added to mynetworks. THis is often not a desired
                 situation, especially in situations where the server has an external IP address. It is recommended that
                 a mynetworks setting get's added manually or mynetworks_style is set to host.

                 For null client, mynetworks = 127.0.0.0/8 [::1]/128, so that only mesages from these networks are forwarded to relay host.

                 
postqueue -p displays list of any outgoing mail messages.


--ISCSI
Data Latency : Gurantee that the performance is consistent from the time content/data leaves the disk and reaches work-station
              and back to disk. Ethernet ( like many cars in a freeway trying to pass each other) doesn't do a guaranteed latency 
               but FC does ( like trucks in a road)

Every object contains three things:

The data itself. The data can be anything you want to store, from a family photo to a 400,000-page manual for assembling an aircraft.

An expandable amount of metadata. The metadata is defined by whoever creates the object storage; it contains contextual 
information about what the data is, what it should be used for, its confidentiality, or anything else that is relevant to the way in which the data is used.

A globally unique identifier. The identifier is an address given to the object in order for the object to be found over a distributed system.
 This way, it’s possible to find the data without having to know the physical location of the data 
 (which could exist within different parts of a data center or different parts of the world).


With block storage, files are split into evenly sized blocks of data, each with its own address but with no additional information (metadata) to provide more context for what that block of data is. You’re likely to encounter block storage in the majority of enterprise workloads; it has a wide variety of uses (as seen by the rise in popularity of SAN arrays).

Object storage, by contrast, doesn’t split files up into raw blocks of data. Instead, entire clumps of data are stored in, yes, an object that contains the data, metadata, and the unique identifier. There is no limit on the type or amount of metadata, which makes object storage powerful and customizable. Metadata can include anything from the security classification of the file within the object to the importance of the application associated with the information. Anyone who’s stored a picture on Facebook or a song on Spotify has used object storage even if they don’t know it. In the enterprise data center, object storage is used for these same types of storage needs, where the data needs to be highly available and highly durable.

However, object storage generally doesn’t provide you with the ability to incrementally edit one part of a file (as block storage does). Objects have to be manipulated as a whole unit, requiring the entire object to be accessed, updated, then re-written in their entirety. That can have performance implications.

Another key difference is that block storage can be directly accessed by the operating system as a mounted drive volume, while object storage cannot do so without significant degradation to performance. The tradeoff here is that, unlike object storage, the storage management overhead of block storage (such as remapping volumes) is relatively nonexistent.


ISCSI initiators sends commands - CDB(Command Descriptor Blocks)s across the SCSI bus for storage management.

ISCSI service is typically implemented in s/w above TCP/IP stack or a TCP Offload Engine (TOE) a specialized Ethernet network interface (NIC) that incldues
TCP/IP network layers to increase performance.

-NFS Client Mount.

While mount selinux context can be exported as a mount option.

mount -o context="system_u:object_r:public_content_rw_t:s0" server:/myshare /mnt/nfsexport

To explicity export the SELinux context, the NFS version 4.2 should be explicity turned on in /etc/sysconfig/nfs
RPCNFSDARGS="-V 4.2"

mount -o v4.2 must be specified as mount option.
mount -o sec=krb5p,v4.2 server:/myshare /mnt/nfsexport


samba_enable_home_dirs allows local linux home directories to be shared by Samba to other systems.

use_samba_home_dirs on the other hand allows remote SMB shares to be mounted and used as local linux directories. IN otherwords iff  you  want  to use a remote Samba server 
for the home directories on this machine, you must set the use_samba_home_dirs boolean.

NOte: To create a samba-only ( pay attention to the question) user , make sure the /sbin/nologin is added during Linux user creation.

By default the protocol used to authenticate is NTLMv2 password hashing encapsulated in Raw NTLMSSP messages sec=ntlmssp is the 

Note: While creating auxiliary system group use groupadd -r

Note: valid users if not specificied in the smb.conf , all users can access the share.

When a Samba Share is mounted, the mount credentials determine the access permissions on the mount point by default. The new
multiuser mount option separates the mount credentials from credentials used to determine the file access for each user.

The root user mounts the share using multiuser option and an SMB Username which has minimal access. Regular users can then
stash their own SMB usernames and passwords in the current sessions kernel keyrin with cifscreds command. The access to share
are authenticated with their own credentials from the keyring, not the mount credentials.


-MariadB
To find out all the options related to MariaDB

[root@rhce4 doc]# systemctl status mariadb  |grep mysql
 Main PID: 1760 (mysqld_safe)
           ├─1760 /bin/sh /usr/bin/mysqld_safe --basedir=/usr
           └─1922 /usr/libexec/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib64/mysql/plugin --log-erro


/usr/libexec/mysqld --verbose --help

--To see what values a running MySQL server is using 
mysqladmin variables

-To configure mysql allowing connections only from local-clients add to /etc/mysql.conf under [mysqld]
skip-networking = 1


-Backup database

mysqldump --all-databases


-Find the data directory
[root@rhce4 ~]# mysqladmin -u root -poracle variables | grep datadir
| datadir                                           | /var/lib/mysql/


-Find the LVM
[root@rhce4 ~]# df -h /var/lib/mysql/
Filesystem             Size  Used Avail Use% Mounted on
/dev/mapper/vgos-root  3.9G  2.1G  1.9G  53% /

-Check for free space
[root@rhce4 ~]# vgdisplay vgos | grep Free 
  Free  PE / Size       624 / <2.44 GiB

- Ensure DB is shutdown or  flush with read lock.
FLUSH TABLES WITH READ LOCK; 
Note:  Do no close this session as the lock will be lifted once the session is exited!


-Create an LVM Snapshot
lvreate -L2G -n mariadb-backup /dev/mapper/vgos-root -s

- Mount the snapshot and backup the datafiles from here..
[root@rhce4 ~]# mkdir /mnt/snapshot
[root@rhce4 ~]# mount /dev/vgos/mariadb-backup /mnt/snapshot/

-HTTP
ab is a tool to benchmark the httpd servers.

Basic syntax covers two parts a) Key : Value pair b) HTML-Like directives <Blockname ParameterName >

Ex.
<Directory />
    AllowOverride none   #.htaccess files will not be considered 
    Require all denied   # httpd will not servce any pages from this directory.
</Directory>

DocumentRoots should be readable by apache, in most case not writetable.

Usually on 'root' has access to the DocumentRoot, but if a linuxgroup requires 
write access to the document root, ACLs are the best way to set it up.

[root@rhce4 ~]# groupadd webmasters
[root@rhce4 ~]# setfacl -R -m g:webmasters:rwX /var/www/html/
[root@rhce4 ~]# setfacl -R -m d:g:webmasters:rwX /var/www/html/

Virtual-Hosts are usually setup when it's not cost-effective to spin up multiple virutal machines when
it's not cost-effective to serve out many low-traffic sites.

By default every virtual host is IP Based Virtual Host, sorting traffic to virtual hosts based on what IP 
address client should connect to. If there are multiple virtual hosts declared for a single IP/port combination
the ServerName and ServerAlias directives are consulted effectively enabling named based virtual hosting.

IP Part of virtual host can be replaced by one of two wild cards _default_ or * , effectively both means "Match anything"

-TLS-HandShake

A Certificate has multiple parts - a public key, server identity and a signature from certificate authority.

During the initial handshake, when setting up encrypted connection client and server agree on a set of encryption
ciphers supported by both server and client and exchange a bits of random data. The client uses this random data to generate
a session key which will be used for much faster symmetric encryption and the same is used for both encryption and decryption.
To make sure the key is not compromised, it is sent to the server encrypted with the servers public key(part of server certificate).

Note: The SELinux context for a certificate is cert_t 

HSTS : Configuring HTTP Strict Transport  
A common misconfiguration and the one that result in warnings in most modern browsers is having a web-page that is served over 
https include resources served out over clear-text http.

To protect againt this type of misconfiguration, add following line inside <VirtualHost> block that has TLS enabled.

Header always Strict-Transport-Security "max-age=15768000"

Sending this extra header informs clients that they are not allowed to fetch any resources for this page that are not served using TLS.

To setup redirects from http to https, a catch-all virtualhost configuration can be used. So inside a <VirtualHost *:80> block

RewriteEngine on
RewriteRule ^(/.*)$ https://%{HTTP_POST}$1 [redirect=301]


-Redirection rule and a catch-all configuration file

[root@rhce5 conf.d]# cat 00-default.conf
<-VirtualHost _default_:80>
    DocumentRoot "/srv/default/www"
    CustomLog "/var/log/httpd/default-vhost.log" common
    RewriteEngine on
    RewriteRule ^(/.*)$ https://%{HTTP_HOST}$1 [redirect=301]
<-/VirtualHost>

<-Directory /srv/default/www>
  AllowOverride none
  Require all granted
<-/Directory>


ScriptAlias /cgi-bin/ "/var/www/cgi-bin/"

This instructs httpd to redirect any request for files under the /cgi-bin/ to /var/www/cgi-bin directory and treat
the files in that directiory as executables.

All these files should be executable by apache user/group and httpd_sys_script_exec_t SELinux context should be set.

CGI Directory should have "Options None" and access should be granted via <Directory> block.

--Serving Dynamic Python Content

WSGI(Web Server Gateway Interface)


-Bash
#! - Sharp-Bang

Debugging - turn on at a specific step by set -x and turn off by set +x 

bash -x or bash -v


-Additional commands
rev - to reverse string
$* vs $@ : $* - means all arguments but seen as a single word vs $@ is all arguments seen as separate parameters


-Docker

docker search rhel7
docker pull registry.access.redhat.com/rhel7.5
docker images # List images

[root@rhce5 certs]# docker run -i -t rhel7 bash
[root@47abe2f93c44 /]# echo hello > /tmp/test
[root@47abe2f93c44 /]# exit
exit

docker ps -a #Shows the container is still running.
root@rhce5 certs]# docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                      PORTS               NAMES
47abe2f93c44        rhel7               "bash"              32 seconds ago      Exited (0) 21 seconds ago                       goofy_saha


#Since the container was not removed, while existing - start it interactively.
[root@rhce5 certs]# docker start -ai goofy_saha
[root@47abe2f93c44 /]# cat /tmp/test
hello

#Baking stuff to container
docker run -i rhel7 bash -c "yum install -y httpd; yum clean all"

[root@rhce5 certs]# docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS               NAMES
bd3b8aab438a        rhel7               "bash -c 'yum inst..."   50 seconds ago      Exited (0) 12 seconds ago                         nifty_hamilton
47abe2f93c44        rhel7               "bash"                   3 minutes ago       Exited (127) 54 seconds ago                       goofy_saha

-Commit to create a new image with httpd included

[root@rhce5 certs]# docker commit -m "RHEL7 + httpd" nifty_hamilton rhel_httpd
sha256:39116a6f88a2d786553dd8e7fe14d62e344a891d6a71a7d8e838c48f34817629

[root@rhce5 certs]# docker images
REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE
rhel_httpd                           latest              39116a6f88a2        25 seconds ago      231 MB

-p 8080:80 option will map port 8080 on the host to 80 on the container
-d to background
/usr/sbin/httpd -DFOREGROUND will start httpd in a very basic mode


[root@rhce5 certs]# docker run -p 8080:80 -d rhel_httpd /usr/sbin/httpd -DFOREGROUND
0f2eb5034da68e0d45e3d5387449af511bbfdf9afa48f27ece062862679fdb45

[root@rhce5 certs]# curl -s http://localhost:8080 |grep Test
     title>Test Page for the Apache HTTP Server on Red Hat Enterprise Linux</title 
     h1>Red Hat Enterprise Linux <strong>Test Page</strong></h1 

docker history rhel_httpd #Shows history of the image.


-Create local registries to distribute finished images to other hosts.
yum install docker-distribution
systemctl start docker-distribution

-Push images to the registry.

docker tag rhel_httpd registry.intercloudzone.com:5000/user/httpd
firewall-cmd --add-port=5000/tcp --permanent

-Exporting images to a file.

[root@rhce5 certs]# docker save --output=rhel_httpd-latest.tar rhel_httpd
[root@rhce5 certs]# ls -ltr *.tar
-rw-------. 1 root root 241635840 Jun 22 20:22 rhel_httpd-latest.tar
--------------------------

-ABSTRACT CODE

PREP = Parameters (Input), R (Return/Output), E (Example), P (Psuedocode)
STAR = Situation, Task, Action, Result.




-Issues/Met with

1. Zone was created, up until then the dotted records were resolving. Due to TTL's/-ive TTL's the resolution 
   started failing from several resolvers but with gaps. Akamai/Dyn both had to look on their side until this was resolved.

2. VM's from same network works, but some VM's didn't. The CIDR was /25 instead of /24 which took few VM's outside of the subnet.

3. The pages stopped rendering from outside network but worked from intranet (Corporate). The result had to do 
   with a .js script load which occurs from a static site which was inherently blocked (cloud-sites-state.oracle.com) 
   from within the application to the outside world.

4. MTU size was different 


</pre>


<div class="w3-container">
  <h1><span class="mw-headline" id="WEB"> WEB </h1> 
<p>

</p>

<pre> 

</pre>  
</body>
</html>
